<!DOCTYPE HTML PUBLIC "-//W3C//DTD 3.2 HTML//EN">
<HTML>
<HEAD>
  <META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <TITLE>Priism Help: Watershed</TITLE>
  <META NAME="Description" CONTENT="On-line help for Priism's application to incrementally threshold (watershed segmentation) a data set.">
  <META NAME="Keywords" CONTENT="Priism,segmentation,mask,threshold,watershed,region growing">
  <LINK REV=MADE HREF="mailto:ive@msg.ucsf.edu">
</HEAD>
<BODY>

<H1><A NAME="Overview">Watershed</A></H1>
<H2>Overview</H2>
<P>Watershed segments a volume into regions (also referred to as patches) and
has options to report measurements for those regions and select a subset of the
regions based on the measurement results.  The basic algorithm is

<OL>
  <LI>Invert and filter the data.  Watershed inverts the data if the
    <EM>Invert</EM> toggle button in the main dialog is on.  Watershed filters
    the data if the <EM>Filter</EM> toggle button in the main dialog is on.
    Parameters controlling the nature of the filter are discussed in the
    <A HREF="#Filter">Filter topic</A>.
  <LI>Segment the data.  Watershed segments the data if the <EM>Segment</EM>
    toggle button in the main dialog is on.  When segmentation starts,
    normally no regions are defined, but you can choose to retain a set of
    patches as they are from a previous run of segmentation.  The
    <A HREF="#FirstIteration">First iteration topic</A> describes how to do so
    in more detail.  During segmentation, Watershed considers the pixels in
    order of decreasing intensity; segmentation stops when a given fraction of
    the pixels have been segmented or a given intensity level has been reached.
    The <A HREF="#Cutoff">Cutoff section</A> describes how to control the
    termination of segmentation.  No special provisions are made to order
    pixels with the same intensity unless the
    <A HREF="#RefineSort">"Refine sort" toggle button</A> is on.  During
    segmentation, Watershed disposes of each pixel considered as follows:
    <UL>
      <LI>If the pixel is not adjacent to any region, Watershed defines a new
        region which initially contains just that pixel.
      <LI>If the pixel is adjacent to just one region, Watershed adds the
        pixel to that region.  If the region is at or has exceeded the maximum
        size allowed (set by the <A HREF="#GrowthLimit">Growth limit</A>
        field), the pixel is still assigned to the region but it is marked
        as excess growth and is not included in measurements of the region.
      <LI>If the pixel is adjacent to two or more regions, the behavior
        depends on the setting of the
        <A HREF="#NeighborsSorted">"Neighbors sorted"</A> toggle button.
        When the <A HREF="#NeighborsSorted">"Neighbors sorted"</A> toggle
        button is off, the adjacent regions are considered in order of
        their geometric relationship to the pixel (i.e. to the right, to
        the left, ...).  Watershed assigns the pixel to the first region that
        has not exceeded the growth limit; if all the regions have exceeded
        the growth limit, Watershed assigns the pixel to the last region and
        marks it as excess growth.  Once Watershed has assigned the pixel
        to a region, any remaining adjacent regions are considered one by
        one.  If either the adjacent region or the region assigned to the
        pixel is smaller than the <A HREF="#MergeLimit">merge limit</A> and the
        <A HREF="#GrowthLimit">growth limit</A>; the regions are merged and
        the combined region is tested for possible mergers against the
        remaining adjacent regions.  When the
        <A HREF="#NeighborsSorted">"Neighbors sorted"</A> toggle button is on,
        the pixel is assigned to the region containing the neighbor with the
        highest intensity (no special provision is made for ties).  If that
        region is at or has exceeded the
        <A HREF="#GrowthLimit">growth limit</A>, the pixel is marked as
        excess growth.  The region to which the pixel is assigned is then
        tested against the other neighboring regions in order of increasing
        intensity for the pixels adjacent to the pixel under consideration (no
        special provision is made for ties).  If either of the pair of regions
        is smaller than the <A HREF="#MergeLimit">merge limit</A> and the
        <A HREF="#GrowthLimit">growth limit</A>, the regions are merged and
        the combined region is used in any further tests.
    </UL>
  <LI>Measure the attributes of each region.  Watershed determines the
    attributes of each region if the <EM>Calculate patch attributes</EM>
    toggle button is on.  The attributes calculated always include a set of
    purely geometric measurements.  Watershed can also calculate attributes
    which depend on the intensity values in the patch.  Press the
    <EM>Modify...</EM> button adjacent to the toggle button to open the dialog
    that controls the sources of the intensity values.  The
    <A HREF="#IntensitySources">Intensity sources</A> topic describes that
    dialog in more detail.  The <A HREF="#Attributes">Attributes topic</A>
    describes what the various attributes are.
  <LI>Select regions based on their attributes.  If the <EM>Select patches by
    attributes</EM> toggle button is on in the main dialog, Watershed will
    select regions whose attributes meet a set of criteria.  To enter the
    selection criteria, press the <EM>Modify...</EM> button next to the toggle
    button.  The <A HREF="#SelectionExpression">Selection expression topic</A>
    describes the format of the criteria.
  <LI>Repeat the segmentation, measurement, and selection steps.  If the
    <EM>Iterate segmentation and selection</EM> toggle button in the main
    dialog is on, Watershed retains the selected patches from one round as they
    are and marks the remainder as unsegmented.  Watershed then repeats
    the process of segmentation, selection, and iteration after adjusting
    the three thresholds (the <A HREF="#MergeLimit">merge limit</A>,
    <A HREF="#GrowthLimit">growth limit</A>, and
    <A HREF="#Cutoff">termination condition for segmentation</A>).  To enter
    the number of iterations and the amount of adjustment to apply to the
    thresholds, press the <EM>Modify...</EM> button adjacent to the toggle
    button.  The <A HREF="#Iteration">Iteration topic</A> describes the
    controls for entering the iteration parameters.
</OL>

<P>To start the processing, enter the input file name or window number in the
<EM>Open</EM> field at the top of the dialog, select the region of interest
(the controls for doing so are the same as many other Priism applications;
consult the <A HREF="Region.html">region processing documentation</A> for
details), and then press the <EM>DoIt</EM> button at the bottom of the dialog.
Watershed has the limitation that it only processes one volume at a time;
if you specify multiple wavelengths or time points in the region of interest,
Watershed will only process the first wavelength and the first time point
from that region of interest.

<P>If you change the parameters and press the "DoIt" button, Watershed knows
what has changed and what has not changed so it will only recalculate what
is necessary.  For example, if you change the intensity sources for the
patch attributes, Watershed will reuse the previous results from the
filtering and segmentation steps.  If you want Watershed to recalculate
all steps, turn on the <EM>Force recalculation</EM> toggle button.  One case
where forcing recalculation is useful is if Watershed's input is a file and you
rewrite that file with new data since Watershed does not check to see if the
file has changed.

<P>If you have an image window available, Watershed can display where the
centers of the regions are and you can interactively select or deselect
regions.  The <A HREF="#WindowInteraction">Window interaction topic</A>
describes how this works in more detail.

<P>Once processing is done you can save images of the patches generated
or text files with the attributes of the patches; the
<A HREF="#Results">Results topic</A> describes in fuller detail what is
possible.  To modify the set of selected patches you can also load a
text file which lists the patch numbers to select; the
<A HREF="#LoadSelection">Load selection topic</A> describes how to do so.

<P>The filtering option in Watershed is similar to the mean filter in
<A HREF="Filter2D.html">Filter 2D</A> or <A HREF="Filter3D.html">Filter 3D</A>
except that the edges are handled differently.  If you want a filter better
adapted to your input data, you can turn off the <EM>Filter</EM> toggle button
in Watershed and have Watershed read the result of the better filter.

<P><A HREF="RegGrow.html">RegionGrowing</A> and
<A HREF="FindPoints.html">FindPoints</A> are two other Priism applications
that can perform region growing; the differences between them and Watershed
are:

<UL>
  <LI>RegionGrowing requires a list of starting points for the regions.
    FindPoints can automatically find the starting points from the
    brightest points (subject to constraints on number and distance between
    the starting points) or can start with a list of already selected points.
    Watershed automatically uses local maxima as the starting points.
  <LI>RegionGrowing and FindPoints grow regions one at a time via a recursive
    process based on the connectivity of the pixels.  Regions are never
    merged.  If a pixel is assigned to a region and later FindPoints or
    RegionGrowing grow another region which runs into that pixel and the
    center of the new region is closer to the pixel than the center of the
    region to which the pixel is assigned, the pixel is reassigned.  In
    Watershed, pixels are considered in order of intensity and regions can
    be merged.  Except for mergers, Watershed does not reassign pixels once
    they are assigned to a region.
</UL>

<H3>Topics</H3>
<P>
  <A HREF="Region.html">Region processing</A> |
  <A HREF="#Filter">Filter</A> |
  <A HREF="#FirstIteration">First iteration</A> |
  <A HREF="#MergeLimit">Merge limit</A> |
  <A HREF="#GrowthLimit">Growth limit</A> |
  <A HREF="#Cutoff">Cutoff</A> |
  <A HREF="#NeighborsSorted">Neighbors sorted</A> |
  <A HREF="#RefineSort">Refine sort</A> |
  <A HREF="#Attributes">Attributes</A> |
  <A HREF="#IntensitySources">Intensity sources</A> |
  <A HREF="#SelectionExpression">Selection expression</A> |
  <A HREF="#Iteration">Iteration</A> |
  <A HREF="#WindowInteraction">Window interaction</A> |
  <A HREF="#LoadSelection">Load selection</A> |
  <A HREF="#Results">Results</A>

<H3>Related Priism Topics</H3>
<P>
  <A HREF="Priism.html">Priism</A> |
  <A HREF="Filter2D.html">Filter 2D</A> |
  <A HREF="Filter3D.html">Filter 3D</A> |
  <A HREF="RegGrow.html">RegionGrowing</A> |
  <A HREF="FindPoints.html">FindPoints</A>
<HR>

<H2><A NAME="Filter">Filter</A></H2>
<P>If the <EM>Filter</EM> toggle button is on in Watershed's main dialog,
Watershed will filter the input data before segmentation.  The filter
Watershed uses is one of the following:

<UL>
  <LI>The value at each pixel, <VAR>p</VAR>, is the value at <VAR>p</VAR> in
    the input minus the average pixel value for the pixels in a box centered
    on <VAR>p</VAR>.  Watershed uses this filter if the <EM>Smooth</EM> toggle
    button is off.
  <LI>The values at each pixel, <VAR>p</VAR>, is the average pixel value for
    the pixels in a box centered on <VAR>p</VAR>.  Watershed uses this filter
    if the <EM>Smooth</EM> toggle button is on.
</UL>

<P>For both filters, use the <EM>Size</EM> field to enter the size of the box
Watershed uses to compute the local average.  The first value in the size
field is the x dimension of the box, the second value is the y dimension of
the box, and the third is the z dimension of the box.  If the size of the
box exceeds the size of the region processed in a dimension, Watershed
silently limits the box size in that dimension to the size of the input
region.

<P><A HREF="#Overview">Return to overview</A>
<HR>

<H2><A NAME="FirstIteration">First Iteration</A></H2>
<P>If you have done one run through (with or without multiple iterations)
of the segmentation and would like to do another run that retains the
currently selected regions, then select the <EM>retain marked patches</EM>
option from the <EM>First iteration</EM> menu.  The effects of doing that are:

<UL>
  <LI>During the new segmentation run, pixels may be assigned to the
    regions retained from the previous run but they are marked as excess
    growth and, therefore, are not included in the calculations of region
    attributes.
  <LI>Two regions retained from a previous run are never merged.
  <LI>A new region from the current run may be merged into a retained region
    if the new region is smaller than the <A HREF="#MergeLimit">merge limit</A>
    and <A HREF="#GrowthLimit">growth limit</A>.  When a new region is merged
    into a retained region, the elements of the new region are marked as
    excess growth.
</UL>

<P>Your other choice for the first iteration of segmentation is to ignore the
currently selected patches and start the region growing as if no previous
results were available.  Choose the <EM>reset all patches</EM> option from
the <EM>First iteration</EM> menu if you want to ignore the currently selected
regions.

<P><A HREF="#Overview">Return to overview</A>
<HR>

<H2><A NAME="MergeLimit">Merge Limit</A></H2>
<P>During segmentation, Watershed will merge two regions if the next pixel to
be segmented touches two existing regions and at least one of those regions
has fewer pixels than the value shown in the <EM>Merge limit</EM> field and
has fewer pixels than the value shown in the <EM>Growth limit</EM> field.

<P><A HREF="#Overview">Return to overview</A>
<HR>

<H2><A NAME="GrowthLimit">Growth Limit</A></H2>
<P>Watershed adds pixels to a region during segmentation as long as the number
of pixels in that region does not exceed the value shown in the
<EM>Growth limit</EM> field.  Watershed will still associate pixels with the
region once the growth limit is reached, but those pixels are flagged as
excess growth and are not included when calculating the region's attributes.
The growth limit also has an impact on whether or not the Watershed
merges patches (see the description of the
<A HREF="#MergeLimit">merge limit</A> for details), but unless the merge limit
is greater than the growth limit, the merge limit will take precedence.

<P><A HREF="#Overview">Return to overview</A>
<HR>

<H2><A NAME="Cutoff">Cutoff</A></H2>
<P>Watershed segments the region of interest until a given number of pixels
have been segmented.  You can specify the number of pixels to segment in
two ways:

<UL>
  <LI>Specify the number of pixels to segment directly as a percentage of
    the total size of the region of interest.  To do so, select
    <EM>% of data</EM> from the menu next to the <EM>Cutoff</EM> field and
    then enter the percentage in the <EM>Cutoff</EM> field.
  <LI>Specify that only pixels with intensities greater than or equal to
    a certain threshold value are segmented.  To do so, select
    <EM>intensity</EM> from the menu next to the <EM>Cutoff</EM> field and then
    enter the intensity threshold value in the <EM>Cutoff</EM> field.
</UL>

<P><A HREF="#Overview">Return to overview</A>
<HR>

<H2><A NAME="NeighborsSorted">Neighbors Sorted</A></H2>
<P>When a pixel to be segmented touches two or more already segmented regions,
the order in which those regions are considered for assigning the pixel to
a region and for merging of regions has some effect on the segmentation
results.  When the "Neighbors sorted" toggle button is off, the regions are
tested in order of their geometric relationship to the pixel to be segmented:
right, left, up, down, top, and bottom.  That ordering was used for results in
<CITE>Harmon B, Sedat J (2005) Cell-By-Cell Dissection of Gene Expression
and Chromosomal Interactions Reveals Consequences of Nuclear Reorganization.
PLoS Biol 3(3): e67 doi:10.1371/journal.pbio.0030067</CITE>.

<P>When the "Neighbors sorted" toggle button is on, the pixel to be segmented
is assigned to the region containing the neighbor pixel with the largest data
value (no special provision is made to resolve ties).  Tests for merging the
region to which the pixel has been assigned to another adjacent region are
made by considering the region containing the neighbor pixel with the lowest
data value first, the one containing the neighbor pixel with the next to
lowest data value second, and so on (again, no special provision is made to
resolve ties).

<P><A HREF="#Overview">Return to overview</A>
<HR>

<H2><A NAME="RefineSort">Refine Sort</A></H2>
<P>The order in which pixels with the same intensity are considered for
segmentation has some effect on the segmentation results.  When the
"Refine sort" toggle button is off, no special action is taken to order the
pixels with the same intensity:  the order in which they will be considered
is a deterministic side effect of the sorting algorithm used and the
arrangement of values in the data set.  When the "Refine sort", toggle button
is on, the values are first sorted with the same algorithm when the
"Refine sort" toggle button is off.  Then, pixels with the same intensity
are ordered as follows:
<Ol>
  <LI>Pixels which have an intensity lower than at least one of their immediate
    neighbors are considered first.  Within this group, the pixels are ordered
    in increasing order of the average absolute intensity difference from their
    neighboring pixels (no special provision is made to resolve ties in the
    average absolute intensity difference).
  <LI>Pixels whose intensity is the same as all of their immediate neighbors
    are considered next.  Within this group, the pixels are arranged in
    decreasing order of the minimum city block distance from the pixel to
    any pixel with a larger intensity (no special provision is made to resolve
    ties).
  <LI>Pixels which have an intensity greater than at least one of their
    immediate neighbors and greater than or equal to all of their immediate
    neighbors are considered next.  Within this group, the pixels are ordered
    in increasing order of the average absolute intensity difference from their
    neighboring pixels (no special provision is made to resolve ties in the
    average absolute intensity difference).
  <LI>Pixels which have an intensity greater than all of their immediate
    neighbors are considered last.  No special provision is taken to order
    the pixels within this group.
</OL>

<P>Results for watershed segmentation in <CITE>Harmon B, Sedat J (2005)
Cell-By-Cell Dissection of Gene Expression and Chromosomal Interactions Reveals
Consequences of Nuclear Reorganization.  PLoS Biol 3(3): e67
doi:10.1371/journal.pbio.0030067</CITE> were generated without refining the
sort.

<P><A HREF="#Overview">Return to overview</A>
<HR>

<H2><A NAME="Attributes">Attributes</A></H2>
<P>When Watershed computes attributes, it always computes the following
quantities for each region:

<DL>
  <DT>X_Center<DD>Is the average x pixel coordinate for pixels in the region.
  <DT>Y_Center<DD>Is the average y pixel coordinate for pixels in the region.
  <DT>Z_Center<DD>Is the average z pixel coordinate for pixels in the region.
  <DT>X_Lower_Bound<DD>Is the minimum x pixel coordinate for pixels in the
    region.
  <DT>X_Upper_Bound<DD>Is the maximum x pixel coordinate for pixels in the
    region.
  <DT>Y_Lower_Bound<DD>Is the minimum y pixel coordinate for pixels in the
    region.
  <DT>Y_Upper_Bound<DD>Is the maximum y pixel coordinate for pixels in the
    region.
  <DT>Z_Lower_Bound<DD>Is the minimum z pixel coordinate for pixels in the
    region.
  <DT>Z_Upper_Bound<DD>Is the maximum z pixel coordinate for pixels in the
    region.
  <DT>Volume<DD>Is the number of pixels in the region.
  <DT>Surface_Area<DD>Let <VAR>nxy</VAR> be the number of faces which are
    parallel to the x/y plane and lie are on the boundary of the region;
    <VAR>nxz</VAR> be the number of faces which are parallel to the x/z
    and on the boundary of the region; and <VAR>nyz</VAR> be the number of
    faces which are parallel to the y/z plane and are on the boundary of the
    region.  Watershed calculates the surface area as<BR>
    <VAR>nxy</VAR>*<VAR>dx</VAR>*<VAR>dy</VAR>+<VAR>nxz</VAR>*<VAR>dx</VAR>*<VAR>dz</VAR>+<VAR>nyz</VAR>*<VAR>dy</VAR>*<VAR>dz</VAR><BR>
    where <VAR>dx</VAR> and <VAR>dy</VAR> are the x and y pixel spacings,
    respectively, from the input image file and <VAR>dz</VAR> is the z
    pixel spacing from the input image file multiplied by the z step size for
    the selected region of interest.
</DL>

<P>If you have specified one or more
<A HREF="#IntensitySources">intensity sources</A> for the attributes
calculation, Watershed also computes the following attributes for each
region:

<DL>
  <DT>Weighted_X_Center_<VAR>name</VAR><DD>Is the intensity weighted average
    x pixel coordinate for the pixels in the region.  <VAR>name</VAR> is
    the name of the intensity source.  If the average intensity of the region
    is zero, Watershed uses zero as the weighted x center.
  <DT>Weighted_Y_Center_<VAR>name</VAR><DD>Is the intensity weighted average
    y pixel coordinate for the pixels in the region.  <VAR>name</VAR> is
    the name of the intensity source.  If the average intensity of the region
    is zero, Watershed uses zero as the weighted y center.
  <DT>Weighted_Z_Center_<VAR>name</VAR><DD>Is the intensity weighted average
    z pixel coordinate for the pixels in the region.  <VAR>name</VAR> is
    the name of the intensity source.  If the average intensity of the region
    is zero, Watershed uses zero as the weighted z center.
  <DT>Average_Intensity_<VAR>name</VAR><DD>Is the average intensity value over
    the region for the intensity source <VAR>name</VAR>.
  <DT>Min_Intensity_<VAR>name</VAR><DD>Is the smallest intensity value in the
    region for intensity source <VAR>name</VAR>.
  <DT>Max_Intensity_<VAR>name</VAR><DD>Is the largest intensity value in the
    region for intensity source <VAR>name</VAR>.
</DL>

<P>For all attributes that refer to a pixel coordinate, what is meant is
the zero-based pixel index relative to the region of the input file selected
for processing.  If the region of interest is <VAR>nx</VAR> by <VAR>ny</VAR>
by <VAR>nz</VAR> in size, the x pixel coordinates range from zero to
<VAR>nx</VAR>-1, the y pixel coordinates range from zero to <VAR>ny</VAR>-1,
and the z pixel coordinates range from zero to <VAR>nz</VAR>-1.

<P><A HREF="#Overview">Return to overview</A>
<HR>

<H2><A NAME="IntensitySources">Intensity Sources</A></H2>
<P>When the <EM>Calculate patch attributes</EM> toggle button is on in
Watershed's main dialog, Watershed calculates
<A HREF="#Attributes">attributes for each region</A>.  To include
attributes (the average intensity, minimum intensity, maximum intensity,
and the center of the patch based on an intensity-weighted calculation) which
depend on intensity values in the region, you must select one or more intensity
sources.  To select the intensity sources, press the <EM>Modify...</EM> key
next to the <EM>Calculate patch attributes</EM> toggle button.  This opens a
dialog where you can select one or two intensity sources.  If the
<EM>Data used for patching</EM> toggle button is on in that dialog, then one of
the intensity sources is the data used for segmentation (i.e. the input data
after the filtering and inversion, if applied).  If the toggle button next to
the <EM>File</EM> button is on, one of the intensity sources is drawn from
the image file or window whose name appears in the field next to the
<EM>File</EM> button.  You can enter the name directly in that field or,
for selecting a file, you can press the <EM>File</EM> button to open a
file browser.

<P>For the intensity source drawn from an arbitrary image file or window,
you must choose what subset of that source to use.  That subset will always
have x, y, and z sizes that match the size of the region of interest selected
in Watershed's main dialog.  For reference, the full x, y, z, and time sizes
of the source are shown in that order immediately below the field with the
window or file name.  To select the wavelength to use from the intensity
source, turn on the corresponding toggle button immediately below the size
display (the toggle buttons are ordered, from left to right, by increasing
wavelength index; the actual wavelength value is displayed to the right of the
toggle button if it is known).  To select the bottom left corner of the volume
chosen from the intensity source, enter the corner's x, y, and z indices, in
that order, into the <EM>XYZ start</EM> field; the indices start from 0 so an
entered value of <VAR>0 0 0</VAR> is the first pixel in a wavelength and time
point.  In the z direction, the subset will use every <VAR>n</VAR>th section
from the intensity source where <VAR>n</VAR> is the value shown in the
<EM>Z step</EM> field.  To select the time point to use from the intensity
source, enter the time point's zero-based index in the <EM>Time</EM> field.

<P><A HREF="#Overview">Return to overview</A>
<HR>

<H2><A NAME="SelectionExpression">Selection Expression</A></H2>
<P>If the <EM>Select patches by attributes</EM> toggle button in Watershed's
main dialog is on, Watershed will mark as selected those regions whose
attributes match a set of criteria you specify.  To enter the criteria, press
the <EM>Modify...</EM> button next to the <EM>Select patches by attributes</EM>
toggle button.  Doing so opens a dialog which has a field, with scrollbars, on
the left where you enter the criteria.  On the right is a list of the available
attributes, if you double click an element in the list, Watershed
inserts it at the current cursor position in the criteria.  The buttons
at the bottom of the dialog have the following functions:

<DL>
  <DT>Check<DD>When pressed, verifies that the criteria entered are
    valid.  If they are not, it will display a message which will
    roughly indicate the type of error and the location.
  <DT>Save<DD>When pressed, opens a file browser; the criteria are saved
    as text in the file entered.
  <DT>Load<DD>When pressed, opens a file browser; after you select a file,
    Watershed replaces the current criteria with the contents of the file.
  <DT>Close<DD>Dismisses the dialog.  To reopen it, press the
   <EM>Modify...</EM> button next to the <EM>Select patches by attributes</EM>
   toggle button in Watershed's main dialog.
</DL>

<P>A valid set of criteria is a combination of one or more Boolean
expressions.  For instance, <CODE>Volume &lt; 10 and Surface_Area &lt; 5</CODE>
is valid but <CODE>Volume</CODE> by itself is not.  Elements that may be used
in the criteria are:

<DL>
  <DT>numbers or constants<DD>Explicit values (for instance 1, 5.7, and 1e3;
    the last is an alternative way to say 1000) stand for themselves.
    Watershed also recognizes two named constants:  <CODE>pi</CODE>
    (i.e. 3.14159...) and <CODE>e</CODE> (i.e. 2.71828...).
  <DT>attribute names<DD>Where an attribute name appears, Watershed substitutes
    the value of that attribute for the region.  Consult the
    <A HREF="#Attributes">Attributes topic</A> for a description of the
    attributes.
  <DT>( and )<DD>Use parentheses to specify a different order of operations
    than the default ordering (exponentiation has highest precedence,
    followed by multiplication and division, followed by addition and
    subtraction, followed by the comparison operators, and followed by the
    Boolean operators among which not has the highest precedence; operators
    with the same precedence which appear consecutively are evaluated left
    to right).
  <DT>comparison operations<DD>These are <CODE>==</CODE> (is equal to),
    <CODE>!=</CODE> (is not equal to), <CODE>&lt;</CODE> (is less than),
    <CODE>&gt;</CODE> (is greater than), <CODE>&lt;=</CODE> (is less than or
     equal to), and <CODE>&gt;=</CODE> (is greater than or equal to).
  <DT>Boolean operations<DD>These are <CODE>not</CODE> (<CODE>not</CODE>
    <VAR>x</VAR> is true if <VAR>x</VAR> is false and is false if <VAR>x</VAR>
    is true; as a shortcut, you may use <CODE>!</CODE> instead of
    <CODE>not</CODE>), <CODE>and</CODE> (<VAR>x</VAR> <CODE>and</CODE>
    <VAR>y</VAR> is true if both <VAR>x</VAR> and <VAR>y</VAR> are true;
    otherwise it is false), <CODE>or</CODE> (<VAR>x</VAR> <CODE>or</CODE>
    <VAR>y</VAR> is false if <VAR>x</VAR> and <VAR>y</VAR> are false; otherwise
    it is true), and <CODE>xor</CODE> (<VAR>x</VAR> <CODE>xor</CODE>
    <VAR>y</VAR> is true if only one of <VAR>x</VAR> and <VAR>y</VAR> is
    true; otherwise it is false).
  <DT>numeric operations<DD>These are <CODE>+</CODE> (addition),
    <CODE>-</CODE> (subtraction), <CODE>*</CODE> (multiplication),
    <CODE>/</CODE> (division), and <CODE>^</CODE> (exponentiation).
  <DT>transcendental functions<DD>These are
    <CODE>cos(</CODE><VAR>x</VAR><CODE>)</CODE> (the cosine of <VAR>x</VAR>,
    assuming <VAR>x</VAR> is in radians), <CODE>sin(</CODE><VAR>x</VAR><CODE>)</CODE>
    (the sine of <VAR>x</VAR>, assuming <VAR>x</VAR> is in radians),
    <CODE>tan(</CODE><VAR>x</VAR><CODE>)</CODE> (the tangent of <VAR>x</VAR>,
    assuming <VAR>x</VAR> is in radians),
    <CODE>log(</CODE><VAR>x</VAR><CODE>)</CODE> (the natural logarithm of
    <VAR>x</VAR>), and <CODE>log10(</CODE><VAR>x</VAR><CODE>)</CODE>
    (the logarithm base 10 of <VAR>x</VAR>). 
  <DT>miscellaneous functions<DD><CODE>abs(</CODE><VAR>x</VAR><CODE>)</CODE>
    returns the absolute value of <VAR>x</VAR>.
    <CODE>max(</CODE><VAR>x</VAR><CODE>,</CODE><VAR>y</VAR><CODE>)</CODE>,
    returns the larger of its two arguments.
    <CODE>min(</CODE><VAR>x</VAR><CODE>,</CODE><VAR>y</VAR><CODE>)</CODE>,
    returns the smaller of its two arguments.
    <CODE>in_range(</CODE><VAR>b1</VAR><CODE>,</CODE><VAR>b2</VAR><CODE>,</CODE><VAR>x</VAR><CODE>)</CODE> is a shortcut for the expression "<VAR>x</VAR> <CODE>&gt;=</CODE> <VAR>b1</VAR> <CODE>and</CODE> <VAR>x</VAR> <CODE>&lt;=</CODE> <VAR>b2</VAR>".
</DL>

<P><A HREF="#Overview">Return to overview</A>
<HR>

<H2><A NAME="Iteration">Iteration</A></H2>
<P>If the <EM>Iterate segmentation and selection</EM> toggle button is on
in Watershed's main dialog, each run started with the <EM>DoIt</EM> button
will repeat the segmentation, attribute calculation, and region selection
steps a fixed number of times.  After each iteration, Watershed
adjusts the <A HREF="#MergeLimit">merge limit</A>,
<A HREF="#GrowthLimit">growth limit</A>, and
<A HREF="#Cutoff">termination condition</A> by constant amounts.  Also at the
start of each iteration, Watershed retains the selected regions from the
previous iteration.  The retained regions grow and merge according to the
following rules:

<UL>
  <LI>Watershed may assign a pixel to a retained region but marks such
    a pixel as excess growth which is not included in calculations of region
    region attributes.
  <LI>Two retained regions are never merged.
  <LI>A new region from the current iteration may be merged into a retained
    region if the new region is smaller than the
    <A HREF="#MergeLimit">merge limit</A> and
    <A HREF="#GrowthLimit">growth limit</A>.  When a new region is merged
    into a retained region, the elements of the new region are marked as
    excess growth.
</UL>

<P>To modify the parameter controlling multiple iterations, press the
<EM>Modify...</EM> button adjacent to the
<EM>Iterate segmentation and selection</EM> toggle button.  Doing so opens
a dialog with fields for the iteration parameters.  Those fields are:

<DL>
  <DT># of iterations<DD>Specifies the number of iterations to perform in
    each run.
  <DT>Merge limit change<DD>At the start of each iteration after the first,
    Watershed adds the value shown in this field to the
    <A HREF="#MergeLimit">merge limit</A>.  Watershed expects the value to
    have units of pixels.
  <DT>Growth limit change<DD>At the start of each iteration after the first
    Watershed adds the value shown in this field to the
    <A HREF="#GrowthLimit">growth limit</A>.  Watershed expects the value to
    have units of pixels.
  <DT>Cutoff change<DD>At the start of each iteration after the first,
    Watershed adds the value shown in this field to the
    <A HREF="#Cutoff">cutoff value</A> that controls how many pixels are
    segmented.
</DL>

<P><A HREF="#Overview">Return to overview</A>
<HR>

<H2><A NAME="WindowInteraction">Window Interaction</A></H2>
<P>If the <EM>Working window</EM> toggle button in Watershed's main dialog is
on and you have entered a valid window number in the adjacent field, then
Watershed will display a cross in the image window at the center of each
region produced by the segmentation.  A green cross represents an selected
region and a red cross represents an unselected region.  The size of the cross
arms indicates the x and y bounds for the region.

<P>If the <EM>enable picking</EM> toggle button in Watershed's main dialog is
on as well as the <EM>Working window</EM> toggle button, you can click on a
point in the image window and, if that point belongs to a region, Watershed
marks the region as selected if the region was not selected or marks the region
as unselected if the region was selected.

<P><A HREF="#Overview">Return to overview</A>
<HR>

<H2><A NAME="LoadSelection">Load Selection</A></H2>
<P>Once you have segmentation results, you may change the set of selected
patches by loading a file with a list of patch numbers.  The file must be
text.  It can have any number of lines at the beginning of the file which do
not begin with a number; the remainder of the file must consist of columns of
numbers where one of the columns contains the patch numbers.  The
<A HREF="#Results">Save patch attributes</A> button in Watershed's main
dialog is one way to generate a file with the required format.

<P>To load the file, press the <EM>Load selection</EM> button in Watershed's
main dialog.  Then enter the name of the file in the field at the top of the
dialog that appears; alternatively, you can press the <EM>File name</EM> button
at the top of the dialog to open a file browser.  On the second line of the
dialog, enter the number of the column (the first column is column one) which
has the patch numbers.  For files generated by Watershed's
<A HREF="#Results">Save patch attributes</A> button, the patch numbers are in
column one.  If you want the list in the file to replace the list of
currently selected patches, turn the <EM>Merge with current selection</EM>
toggle button off; if you want to combine the current list and the list in the
file, turn the <EM>Merge with current selection</EM> toggle button on.  Press
the <EM>Load</EM> button at the dialog to cause Watershed to read the list
of selected patches.

<P><A HREF="#Overview">Return to overview</A>
<HR>

<H2><A NAME="Results">Results</A></H2>
<P>Once you have sent Watershed through a run by pressing the <EM>DoIt</EM>
button, you can save the results from the run with the buttons grouped just
below the <EM>Results</EM> button in Watershed's main dialog.  Some of those
buttons may be disabled if the run did not generate the necessary data.  The
functions of the different output buttons are:

<DL>
  <DT><STRONG>Save patch centers</STRONG>
  <DD>Opens a dialog to save the coordinates of the region centers as
    a <A HREF="Pick.html">Pick Points list</A>.  Besides Pick Points,
    other programs like <A HREF="FindPoints.html">FindPoints</A> can read
    lists in that format.  The controls in the dialog are:
    <DL>
      <DT>Output<DD>Enter the name of the file in the field next to this button
        or press the button to open a file dialog.
      <DT>Patches included<DD>If you select <EM>All patches</EM> from this
        menu, Watershed saves the centers of all patches.  If you select
        <EM>Marked patches</EM>, Watershed saves the centers of the patches
        that satisfied the
        <A HREF="#SelectionExpression">selection criteria</A>.  If you select
        <EM>Unmarked patches</EM>, Watershed saves the centers of the patches
        that did not satisfy the selection criteria.
      <DT>Time point<DD>In a Pick Points list, the points are grouped by a
        time index.  Enter the time index you want associated with the points,
        in this field.
      <DT>Wave <VAR>x</VAR><DD>Besides a time index, points in a Pick Points
        list are grouped by wavelength.  To associate the region centers with
        one or more wavelengths, turn on the corresponding toggle buttons
        and turn off the other toggle buttons.  For each wavelength, you
        can choose to use the coordinates for the geometric center of the
        region or the results of an intensity weighted calculation (the
        intensity weighted results are only available if you set one or more
        <A HREF="#IntensitySources">intensity sources</A> for the attribute
        calculations).
      <DT>Save<DD>Press this button to generate the Pick Points list.
      <DT>Close<DD>Press this button to dismiss the dialog.
     </DL>

  <DT><STRONG>Save patch attributes</STRONG>
  <DD>Opens a dialog to save the region attributes as a text file with one
    column per attribute.  The text file has a number of header lines, each
    starting with #, to describe the contents of the file.  The columns are
    delimited by spaces and the first column is always the patch number.
    The controls in the dialog are:
    <DL>
      <DT>Output<DD>Enter the name of the file in the field next to this button
        or press the button to open a file dialog.
      <DT>Patches included<DD>If you select <EM>All patches</EM> from this
        menu, Watershed saves the attributes of all patches.  If you select
        <EM>Marked patches</EM>, Watershed saves the attributes of the patches
        that satisfied the
        <A HREF="#SelectionExpression">selection criteria</A>.  If you select
        <EM>Unmarked patches</EM>, Watershed saves the attributes of the
        patches that did not satisfy the selection criteria.
      <DT>Save<DD>Press this button to write the patch attributes.
      <DT>Close<DD>Press this button to dismiss the dialog.
     </DL>

  <DT><STRONG>Save filtered images</STRONG>
  <DD>Opens a dialog to save an image file with the processed (restriction
    to the region of interest, inversion (if applied), and filtering
    (if applied)) input images.  Enter the name of the file or image window
    number in the top line of the dialog or press the <EM>Output</EM> button
    in the dialog to select the file with a file browser; then press the
    <EM>Save</EM> button to store the results.

  <DT><STRONG>Save patch # images</STRONG>
  <DD>Opens a dialog to save an image file where each the value at each
    pixel is the number of the region to which the pixel belongs; pixels
    that do not belong to any region have a value of zero.  The controls
    in the dialog are:
    <DL>
      <DT>Output<DD>Enter the name of the file or image window number in the
        field next to this button or press the button to open a file dialog.
      <DT>Patches included<DD>If you select <EM>All patches</EM> from this
        menu, Watershed includes all regions in the saved images.  If you
        select <EM>Marked patches</EM>, Watershed only includes pixels
        belonging to regions that satisfied the
        <A HREF="#SelectionExpression">selection criteria</A> and sets all
        other pixels to zero.  If you select <EM>Unmarked patches</EM>,
        Watershed only includes pixels belonging to regions that did not
        satisfy the selection criteria and sets all other pixels to zero.
      <DT>Excess areas<DD>If you select <EM>Exclude</EM>, pixels associated
        with a region but marked as excess growth will be zero in the output.
        If you select <EM>Include</EM>, pixels associated with a region but
        marked as excess growth will appear as other pixels belonging to the
        same region.  If you select <EM>Flag with negative value</EM>, the
        pixels associated with a region but marked as excess growth will have
        a value equal to the negative of the region number.
      <DT>Save<DD>Press this button to write the images.
      <DT>Close<DD>Press this button to dismiss the dialog.
    </DL>

  <DT><STRONG>Save binary images</STRONG>
  <DD>Opens a dialog to save an image file where the value at each pixel is
    either zero or one.  A pixel associated with no region will be zero;
    a pixel associated with a region may be zero or one depending on what
    you select for <EM>Patches included</EM> and <EM>Excess areas</EM>.  The
    controls in the dialog are:
    <DL>
      <DT>Output<DD>Enter the name of the file or image window number in the
        field next to this button or press the button to open a file dialog.
      <DT>Patches included<DD>If you select <EM>All patches</EM> from this
        menu, a pixel which is assigned to any region will have a value of one.
        If you select <EM>Marked patches</EM>, only pixels belonging to regions
        that satisfied the
        <A HREF="#SelectionExpression">selection criteria</A> will be one.
        If you select <EM>Unmarked patches</EM>,
        only pixels belonging to regions that did not satisfy the selection
        criteria will be one.  In all cases, pixels marked as excess growth
        are also subject to your selection for <EM>Excess areas</EM>.
      <DT>Excess areas<DD>If you select <EM>Exclude</EM>, pixels associated
        with a region but marked as excess growth will be zero in the output.
        If you select <EM>Include</EM>, pixels associated with a region but
        marked as excess growth will appear as other pixels belonging to the
        same region.
      <DT>Save<DD>Press this button to write the images.
      <DT>Close<DD>Press this button to dismiss the dialog.
    </DL>
</DL>

<P><A HREF="#Overview">Return to overview</A>
<HR>

</BODY>
</HTML>
