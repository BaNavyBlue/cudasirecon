<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
<HEAD>
  <META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <TITLE>Priism Help: 2D Preprocessing</TITLE>
  <META NAME="Description" CONTENT="On-line help for Priism's application for background subraction, padding, and windowing in 2D.">
  <META NAME="Keywords" CONTENT="Priism,pad,taper,background">
  <LINK REV=MADE HREF="mailto:ive@msg.ucsf.edu">
</HEAD>
<BODY>

<H1><A NAME="Preprocessing2D">2D Preprocessing</A></H1>
<H2>Overview</H2>

<P>This program can subtract the background, pad, and taper each 2D section
of a data set.  Essentially, these are the same options as are available in
the <A HREF="FFilter2D.html">2D Fourier filtering application</A> but without
the filtering step.  The controls in the user interface include a
<A HREF="Region.html">standard set of controls</A> for selecting the input
file, output file, and region of interest and for starting and interrupting
processing.  The other controls are organized as follows:

<UL>
  <LI>Use the <A HREF="#Background">button labeled "Set background handling"</A>
    to display and change the parameters which control how the background is
    estimated and subtracted from the data.  By default, no background is
    subtracted from the input data.
  <LI>Use the <A HREF="#Window">button labeled "Set window/taper"</A> to
    select a function used to smooth out discontinuities at the edges of the
    data after background subtraction and before padding the data.  By default,
    no smoothing is done.
  <LI>Use the <A HREF="#Edges">button labeled "Set edge handling"</A>
    to control the number and values of the elements that are appended to
    the input region.  By default, the input data is not padded.
</UL>

<H3>Topics</H3>
<P>
  Overview |
  <A HREF="Region.html">Region processing</A> |
  <A HREF="#Background">Background subtraction</A> |
  <A HREF="#Window">Window/taper</A> |
  <A HREF="#Edges">Edge handling</A> |
  <A HREF="#CommandLine">Command line</A>
<H3>Related Priism Topics</H3>
<P>
   <A HREF="Priism.html">Priism</A> |
   <A HREF="FFilter2D.html">2D Filter (Fourier domain)</A>

<HR>

<H2><A NAME="Background">Background Subtraction</A></H2>
<P>The input region can be processed to remove an offset or trend before
the data is padded.  To display the controls for this processing, press the
button labeled <EM>Set background handling</EM> in the main dialog.  There
are five types of processing that can be done; select one by pressing the
appropriate toggle in the dialog.  The processing options are:

<DL>
  <DT>None<DD>The input is not modified.
  <DT>Subtract offset<DD>The specified value is subtracted from all the input
    values.
  <DT>Subtract mean<DD>For each 2D (xy) input region, the mean of the region
    is subtracted from all values in the region.
  <DT>Remove linear trend<DD>An average slope for each 2D (xy) input region
    is estimated by averaging values from the first and last third of each
    dimension; the linear trend corresponding to that average slope and
    the mean of the region is subtracted from the input data.  The algorithm
    used is the average slope method extended to two dimensions (Digital data
    analysis procedures, Bendat and Piersol, 1st Edition, 1971, page 288).
  <DT>Remove trends up to order<DD>A polynomial of the given order is fit to
    each 2D (xy) input region.  That polynomial evaluated at each input point
    is then subtracted from the input.
</DL>

<H3>Topics</H3>
<P>
  <A HREF="#Preprocess2D">Overview</A> |
  <A HREF="Region.html">Region processing</A> |
  Background subtraction |
  <A HREF="#Window">Window/taper</A> |
  <A HREF="#Edges">Edge handling</A> |
  <A HREF="#CommandLine">Command line</A>
<HR>

<H2><A NAME="Window">Window/taper</A></H2>
<P>Applying a windowing function, also called tapering, multiplies the
data by a function which goes to zero (or near zero) at the edges of the
data.  This is done to remove discontinuities at the edges; the disadvantage
of applying a window is that it essentially throws away parts of the input.

<P>The windowing functions used are separable, i.e, the windowing function,
W(x,y), can be written as the product of WX(x) and WY(y).  WX and WY are
calculated from the same formula but with different inputs for the number
of pixels, n, and the fraction, f, of the dimension that is attenuated
by the windowing function.  The two values in the <EM>Coverage</EM>
field are the values of f divided by two for the x and y directions
respectively.  Commonly used values for the coverage are 0.5 (a "full taper")
and 0.1 (a 10% taper).  The power, x, is used by half-sine windowing function.

<P>The functions used to calculate the windowing functions are shown below.
i is the pixel index and runs from 0 to n minus 1, and e is given by

<PRE>
      { floor(0.5 + f / 2.0 * n)          n even
  e = {
      { floor(0.5 + f / 2.0 * (n - 1))    n odd
</PRE>

<H3>Rectangular</H3>
<PRE>
         { 0     i &lt; e
  w(i) = { 1     e &lt;= i &lt;= n - e
         { 0     i &gt; n - e
</PRE>
<P>Because of the sharp cutoffs of the rectangular window, it is
not particularly useful; it's provided for completeness.

<H3>Triangular</H3>
<PRE>
         { i / e           i &lt; e
  w(i) = { 1               e &lt;= i &lt;= n - e
         { (n - i) / e     i &gt; n - e
</PRE>

<H3>Half-sine^power</H3>
<PRE>
         { (sin(pi * i / (2 * e)))^x           i &lt; e
  w(i) = { 1                                   e &lt;= i &lt;= n - e
         { (sin(pi * (n - i) / (2 * e)))^x     i &gt; n - e
</PRE>

<H3>Hamming</H3>
<PRE>
         { 0.54 - 0.46 * cos(pi * i / e)           i &lt; e
  w(i) = { 1                                       e &lt;= i &lt;= n - e
         { 0.54 - 0.46 * cos(pi * (n - i) / e)     i &gt; n - e
</PRE>

<H3>Blackman</H3>
<PRE>
         { cos(pi * i / e)           i &lt; e
  a(i) = { -1                        e &lt;= i &lt;= n - e
         { cos(pi * (n - i) / e)     i &gt; n - e

  w(i) = 0.34 - a(i) * (0.5 - a(i) * 0.16)
</PRE>

<H3>Topics</H3>
<P>
  <A HREF="#Preprocess2D">Overview</A> |
  <A HREF="Region.html">Region processing</A> |
  <A HREF="#Background">Background subtraction</A> |
  Window/taper |
  <A HREF="#Edges">Edge handling</A> |
  <A HREF="#CommandLine">Command line</A>
<HR>

<H2><A NAME="Edges">Edge handling</A></H2>
<P>The dimensions of the input region can be extended by adding elements
at the end of each dimension.  This is typically done for two reasons:

<UL>
  <LI>Adding the extra elements gives a size that is efficiently handled
    by Fourier transforms.
  <LI>Adding the extra elements reduces the blending of opposite edges of
    the data which might be troublesome if the values at the opposite edges
    are very different.
</UL>

<P>To display the controls for the amount of padding and the values of the
elements added, press the button labeled <EM>Set edge handling</EM> in the
main dialog.  For each dimension the <EM>Width</EM> field sets the number
of elements that will be added.  When the toggle labeled
<EM>Use default width</EM> is on, the <EM>Width</EM> field will automatically
be set so the padded size can be efficiently handled.  There are three
ways in which the values of the added elements are set.  These are:

<DL>
  <DT>Pad with value<DD>Use the given value for all the elements added to
    a dimension.  The imaginary component of the value is only used if the
    input data is complex.
  <DT>Pad with mean<DD>Use the mean of the 2D (xy) input region being processed
    when padding the dimension.
  <DT>Pad with linear ramp<DD>For each line in x (or column for y) the
    padding elements added to the line (or column) are a linear combination
    of the first and last element of that input line (or column).
</DL>

<H3>Topics</H3>
<P>
  <A HREF="#Preprocess2D">Overview</A> |
  <A HREF="Region.html">Region processing</A> |
  <A HREF="#Background">Background subtraction</A> |
  <A HREF="#Window">Window/taper</A> |
  Edge handling |
  <A HREF="#CommandLine">Command line</A>
<HR>

<H2><A NAME="CommandLine">Command line</A></H2>
<P>Preprocess2D accepts the command-line arguments described in
<A HREF="Region.html#COMMANDLINE">Region.html</A>.  In addition, Preprocess2D
accepts the options shown below (optional parts are shown in brackets).  If
mutually exclusive options (i.e. for selection of the type of background
subtraction), the last option that appears on the command line takes
precedence.  The defaults are to use no background subtraction, no tapering,
and no padding.

<DL>
  <DT><CODE>-subtract=</CODE><VAR>value</VAR> or <CODE>-subtract=mean</CODE>
  <DD>Specifies that the input data should be preprocessed by subtracting
    <VAR>value</VAR> or the mean.

  <DT><CODE>-linear_detrend</CODE>
  <DD>Specifies that the input data should be preprocessed by subtracting the
    linear trend which corresponds to the estimated average slope.

  <DT><CODE>-polyfit=</CODE><VAR>n</VAR>
  <DD>Specifies that the input data should be preprocessed by subtracting
    the least-squares fit polynomial of order <VAR>n</VAR>.  Valid values
    of <VAR>n</VAR> range from one to 10.

  <DT><CODE>-rectangular=</CODE><VAR>x_coverage</VAR><CODE>:</CODE><VAR>y_coverage</VAR>
  <DD>Selects a rectangular windowing function that attenuates 200 times
    <VAR>x_coverage</VAR> percent of the data in x and 200 times
    <VAR>y_coverage</VAR> percent of the data in y.  Valid values for
    <VAR>x_coverage</VAR> and <VAR>y_coverage</VAR> are between 0 and 0.5.

  <DT><CODE>-triangular=</CODE><VAR>x_coverage</VAR><CODE>:</CODE><VAR>y_coverage</VAR>
  <DD>Selects a triangular windowing function that attenuates 200 times
    <VAR>x_coverage</VAR> percent of the data in x and 200 times
    <VAR>y_coverage</VAR> percent of the data in y.  Valid values for
    <VAR>x_coverage</VAR> and <VAR>y_coverage</VAR> are between 0 and 0.5.

  <DT><CODE>-halfsine=</CODE><VAR>x_coverage</VAR><CODE>:</CODE><VAR>y_coverage</VAR>
  <DD>Selects a half-sine windowing function (consult the
    <A HREF="#Window">Window/taper topic</A> for details) that attenuates 200
    times <VAR>x_coverage</VAR> percent of the data in x and 200 times
    <VAR>y_coverage</VAR> percent of the data in y.  Valid values for
    <VAR>x_coverage</VAR> and <VAR>y_coverage</VAR> are between 0 and 0.5.
    Use <CODE>-halfsine_power</CODE> to set the exponent, which controls
    the sharpness of the window edges.

  <DT><CODE>-halfsine_power=</CODE><VAR>p</VAR>
  <DD>Sets the exponent for the half-sine windowing function.  This option is
    ignored when other windowing functions are used.  If this option is not
    explicitly specified when the half-sine windowing function is used, the
    exponent used is one.

  <DT><CODE>-hamming=</CODE><VAR>x_coverage</VAR><CODE>:</CODE><VAR>y_coverage</VAR>
  <DD>Selects a Hamming window function (consult the
    <A HREF="#Window">Window/taper topic</A> for details) that attenuates 200
    times <VAR>x_coverage</VAR> percent of the data in x and 200 times
    <VAR>y_coverage</VAR> percent of the data in y.  Valid values for
    <VAR>x_coverage</VAR> and <VAR>y_coverage</VAR> are between 0 and 0.5.

  <DT><CODE>-blackman=</CODE><VAR>x_coverage</VAR><CODE>:</CODE><VAR>y_coverage</VAR>
  <DD>Selects a Blackman window function (consult the
    <A HREF="#Window">Window/taper topic</A> for details) that attenuates 200
    times <VAR>x_coverage</VAR> percent of the data in x and 200 times
    <VAR>y_coverage</VAR> percent of the data in y.  Valid values for
    <VAR>x_coverage</VAR> and <VAR>y_coverage</VAR> are between 0 and 0.5.

  <DT><CODE>-xpad=default</CODE> or <CODE>-xpad=</CODE><VAR>n</VAR>
  <DD>Specifies that the x dimension should be padded by the default amount
    (to a size which is efficient for FFT calculations) or by <VAR>n</VAR>
    pixels, where <VAR>n</VAR> is a non-negative integer.

  <DT><CODE>-xpad_value=mean</CODE> or <CODE>-xpad_value=ramp</CODE> or <CODE>-xpad_value=</CODE><VAR>rv</VAR>[<CODE>:</CODE><VAR>iv</VAR>]
  <DD>Specifies what values to use when padding the x dimension.
    <CODE>-xpad_value=mean</CODE> causes the data to be padded with the
    mean value.  <CODE>-xpad_value=ramp</CODE> causes the data to be padded
    with values which range linearly from the value at one boundary to the
    value at the other boundary.  The last form causes the data to be
    padded with a constant value whose real component is <VAR>rv</VAR> and
    whose imaginary component is <VAR>iv</VAR>.  If the imaginary component
    is omitted, it is assumed to be zero.

  <DT><CODE>-ypad=default</CODE> or <CODE>-ypad=</CODE><VAR>n</VAR>
  <DD>Is similar to <CODE>-xpad</CODE> but specifies the amount of padding
    in the y dimension.

  <DT><CODE>-ypad_value=mean</CODE> or <CODE>-ypad_value=ramp</CODE> or <CODE>-ypad_value=</CODE><VAR>rv</VAR>[<CODE>:</CODE><VAR>iv</VAR>]
  <DD>Is similar to <CODE>-xpad_value</CODE> but specifies the padding values
    for the y dimension.
</DL>

<P>As an example, the following command line subtracts a second-order
polynomial fit from the input data and pads that result with 512 rows of zeros
and 512 columns of zeros:
<PRE>
    Preprocess2D raw.dat out.dat -polyfit=2 -xpad=512 -xpad_value=0 -ypad=512 \
        -ypad_value=0
</PRE>

<H3>Topics</H3>
<P>
  <A HREF="#Preprocess2D">Overview</A> |
  <A HREF="Region.html">Region processing</A> |
  <A HREF="#Background">Background subtraction</A> |
  <A HREF="#Window">Window/taper</A> |
  <A HREF="#Edges">Edge handling</A> |
  Command line
<HR>

</BODY>
</HTML>
