<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
<HEAD>
  <META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <TITLE>Priism Help: BEAD_MATCHER</TITLE>
  <META NAME="Description" CONTENT="On-line help for the application to identifying the same reference marker (gold bead) in different projections.">
  <META NAME="Keywords" CONTENT="Priism,EM,tomography,alignment,gold beads">
  <LINK REV=MADE HREF="mailto:ive@msg.ucsf.edu">
</HEAD>
<BODY>

<H1><A NAME="BEAD_MATCHER">BEAD_MATCHER</A></H1>
<H2>Overview</H2>
<P>This is the second step in automatic/interactive bead alignment.
This program traces individual beads through all projections.  The
algorithm is:
<OL>
  <LI>Using the chosen reference beads on the first reference section
    and starting from this reference section, for any section:
    <OL>
      <LI>From the positions of matched bead positions on
         previous sections and the knowledge of rough values of the
         alignment parameters, predict the bead positions on the current
         section.
      <LI>Match the predicted bead pattern with the pattern of the bead-like
         features found with <A HREF="BEAD_FINDER.html">BEAD_FINDER</A>.
    </OL>
    The results of this process are the merged bead list for the first
    reference section.
  <LI>Often the matching effort from one reference section can not provide
    enough bead positions for all sections, so more than one reference
    section is used.  For any reference section K (=2,3,4...):
    <OL>
      <LI>Do matching from reference section K, following the
         steps used for the first reference section.
      <LI>Merge the matched bead list for reference section K with the
         merged bead list for reference section K minus one to get
         the merged bead list for reference section K.
    </OL>
    For the last reference section, save the merged bead list in the
    output (.sl) file.      
</OL>

<P>If there are large shifts between neighboring projections or the
bead-like features to be matched are closely crowded so more
accurate shift parameters are needed when running BEAD_MATCHER,
create a *.sbl file by picking positions of a bead in all projections.
If there are only a few large shifts, it's only necessary to pick a
bead on projections around each large shift, and the beads for different
shifts do not have to be the same if the shifts are not adjacent.

<P>Here's an example command file for BEAD_MATCHER:
<PRE>
     (time bead_matcher \
     /usr/people/weiping/test/junk.stk \
     /usr/people/weiping/test/junk.pl \
     /usr/people/weiping/test/junk.sl \
     /usr/people/weiping/test/junk.rbl \
     -rot0=78 -nskip=5 -slop=25:25:25 -xycrit=10:10 \
     -irefs=-1:-1:-1:-1:-1:-1:-1:-1:-1:-1 -isblfile=none \
     -iprmfile=none -nchuck=1 ) &gt; /mama/weiping/balign.log
</PRE>

<H3><A NAME="Parameters">Parameters</A></H3>
<P>
   <A HREF="#IdatFile">IdatFile</A> |
   <A HREF="#IplFile">IplFile</A> |
   <A HREF="#OslFile">OslFile</A> |
   <A HREF="#IrblFile">IrblFile</A> |
   <A HREF="#NX:NY:NV">NX:NY:NV</A> |
   <A HREF="#rot0">rot0</A> |
   <A HREF="#nSkip">nSkip</A> |
   <A HREF="#slop">slop</A> |
   <A HREF="#xyCrit">xyCrit</A> |
   <A HREF="#iRefs">iRefs</A> |
   <A HREF="#IsblFile">IsblFile</A> |
   <A HREF="#*IprmFile">IprmFile</A> |
   <A HREF="#*nChuck">nChuck</A>


<H3>Related Priism Topics</H3>
<P>
   <A HREF="../Priism.html">Priism</A> |
   <A HREF="BALIGN.html">Alignment</A> |
   <A HREF="BEAD_FINDER.html">Bead finder</A> |
   <A HREF="BEAD_CHASER.html">Bead chaser</A> |
   <A HREF="BEAD_ALIGN.html">Bead align</A> |
   <A HREF="BEAD_ALIGN_INTERACTIVE.html">Bead align (interactive)</A> |
   <A HREF="PEdit.html">Bead list editor</A> |
   <A HREF="EMTAR.html">Reconstruction</A>

<HR>

<H2><A NAME="IdatFile">IdatFile</A></H2>
<P>IdatFile is the raw projection data stack from the CCD.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="IplFile">IplFile</A></H2>
<P>Iplfile specifies the name of the input list file which stores the
coordinates of bead-like features.  This file is generated by
<A HREF="BEAD_FINDER.html">BEAD_FINDER</A>.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="OslFile">OslFile</A></H2>
<P>OslFile is the file name to use for the output list of sorted and matched
bead coordinates.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="IrblFile">IrblFile</A></H2>
<P>IrblFile is the name of a file that contains bead locations from multiple
reference sections (it assumes that the bead coordinates for each section
will be contiguous in the IrblFile).  IrblFile will be ignored if it does
not exist.  If there are valid reference sections specified by
<A HREF="#iRefs">iRefs</A>, they will be used for matching as well.
If no IrblFile is supplied and no reference sections are supplied with
<A HREF="#iRefs">iRefs</A>, the section with the tilt angle closest to zero
will be used as the reference section.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="NX:NY:NV">NX:NY:NV</A></H2>
<P>The first two values are, respectively, the x and y dimension of the
projections.  The third value is the number of projections in the data
stack.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="rot0">rot0</A></H2>
<P>Let the orientation angle be the smallest, in absolute value, rotation
  angle needed to rotate the image so that the tilt axis is parallel to the
  y axis (the y axis is vertical when images are displayed in Priism).  The
  orientation angle is positive if the corresponding rotation is clockwise
  and is negative if the corresponding rotation is counterclockwise.<BR>
  <IMG SRC="rot0.jpg" ALT="Orientation angle sign convention" WIDTH=373 HEIGHT=189><BR>
  The first value in the <EM>rot0</EM> field is the estimated orientation
  angle, in degrees, at a tilt angle of zero.  The second value is the
  estimated difference, in degrees, between the orientation angle at a tilt
  angle of sixty degrees and the orientation angle at a tilt angle of minus
  sixty degrees.  To specify these parameters from the command line, use
  <CODE>-rot0=</CODE><VAR>o0</VAR><CODE>:</CODE><VAR>ochange</VAR>.  The
  default value for <VAR>o0</VAR> is 78 degrees; the default value for
  <VAR>ochange</VAR> is -1 degrees.  You should substitute values that
  more accurately reflect what happens at the magnification used when
  collecting the tilt series.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="nSkip">nSkip</A></H2>
<P>When predicting the position of a bead in section i, BEAD_MATCHER
looks at previously matched sections or a reference section with
indices in [i - nSkip, i + nSkip] to find a previously determined
position for the bead, if no such position is found then no attempt is made
to match the bead in other sections. 

<P>Use <CODE>-nskip=</CODE><VAR>n</VAR> to set this parameter on the
command line.  The default value is five.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="slop">slop</A></H2>
<P>The first, slop1, of these three parameters sets maximum distance in
pixels between a bead position in the input .pl file and the predicted
value from the matching algorithm.

<P>The second, slop2, is the maximum amount in pixels to shift the
predicted positions of the beads to be traced when trying to find the best
match with the beads in the input .pl file.  A limit is imposed to restrict
the 4D search space and reduce the computational cost (roughly proportional
to slop2^4).  This is helpful if there are many beads to match.  If in a
section, fewer than four of the beads to be traced are matched with beads in
the input .pl file, slop2 will be doubled and the search will be done again.

<P>The third, slop3, is the threshold in pixels for the distance between the
predicted positions of the beads to be traced and the beads in the input .pl
file in each matching trial.  Each trial starts by aligning the position
of one of the beads to be traced (the starting bead) and the positions of
one of the beads in the input .pl file.  Then for each bead to be traced
other than the starting bead, the closest bead position in the input .pl
file is found.  If the distance to this closest position is greater than
slop3, no match is found.  There is no requirement that each bead being
traced be matched in each section since there are cases (if BEAD_FINDER
did not locate the bead or if the bead fell outside the field of view)
when doing so would generate incorrect results.

<P>If more accurate initial alignment parameters are available (by
providing an <A HREF="#IsblFile">IsblFile</A> or
<A HREF="#*IprmFile">IprmFile</A>) then more stringent values for the
slop parameters can be used.

<P>These three parameters are specified on the command line with
<CODE>-slop=</CODE><VAR>slop1</VAR><CODE>:</CODE><VAR>slop2</VAR><CODE>:</CODE><VAR>slop3</VAR>.
The default value for <VAR>slop1</VAR> is 25 pixels.  <VAR>slop2</VAR> or
<VAR>slop3</VAR> will be set equal to <VAR>slop1</VAR> if they are not
specified.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="xyCrit">xyCrit</A></H2>
<P>These two parameters are, respectively, the maximum x and y differences
(in pixels) between the best match of the positions in the input .pl file
and the predicted position for a bead to be traced.
If a difference in the x position or a difference in the y position exceeds
the threshold, the matched point will be dropped from the found list.
In a section, when the number of found beads drops to less than three,
the threshold will be automatically doubled for that section.

<P>Set the thresholds with the command-line option,
<CODE>-xycrit=</CODE><VAR>x_threshold</VAR>:<VAR>y_threshold</VAR>.  The
default value for the thresholds is ten pixels.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="iRefs">iRefs</A></H2>
<P>These values specify which projections should be used as reference
sections in the matching process.  The beads used on a reference
section are the ones present in the input .pl file.  Up to ten reference
sections can be used.

<P>To specify a reference section, enter its index which ranges from
zero (for the first section in the data stack) to the number of
sections minus one (for the last section in the data stack).  Values
less than zero are ignored.  The reference sections are set on the
command line with <CODE>-irefs=</CODE><VAR>ref1</VAR><CODE>:</CODE><VAR>ref2</VAR><CODE>:</CODE><VAR>ref3</VAR><CODE>:</CODE><VAR>ref4</VAR><CODE>:</CODE><VAR>ref5</VAR><CODE>:</CODE><VAR>ref6</VAR><CODE>:</CODE><VAR>ref7</VAR><CODE>:</CODE><VAR>ref8</VAR><CODE>:</CODE><VAR>ref9</VAR><CODE>:</CODE><VAR>ref10</VAR>.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="IsblFile">IsblFile</A></H2>
<P>This parameter gives the name of a file that contains the coordinates
of a single reference bead on all projections.  These coordinates are used
to enable better prediction of bead positions in the matching step and can be
used to work around the problems created by large image shifts between
adjacent projections.  Specifying rough alignment parameters with
<A HREF="#*IprmFile">IprmFile</A> is another way to do this, but keep
in mind that the translational parameters from IsblFile have
priority over those from the alignment parameters file.

<P>The typical way to generate IsblFile is to use
<A HREF="PEdit.html">the bead list editor</A> to interactively select
the positions.

<P>This parameter is specified on the command line with
<CODE>-isblfile=</CODE><VAR>file_name</VAR>.  The default value is "none"
which indicates that no IsblFile is available.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="*IprmFile">IprmFile</A></H2>
<P>Iprmfile is the name of a file containing an estimate of
the alignment parameters in standard format.  This can be generated
from EM calibration and a stretched cross-correlation alignment.
This file is optional but can be used to provide more accurate estimates
of the alignment parameters so predictions of bead positions during the
matching process can be done more accurately.

<P>The file name is specified on the command line with
<CODE>-iprmfile=</CODE><VAR>file_name</VAR>.  The default value is "none"
which signals that no alignment parameter file is available.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="*nChuck">nChuck</A></H2>
<P>This parameter sets the number of beads to be down weighted in
assessing various matching possibilities between the predicted
positions of the beads to be matched and the bead positions in the
input .pl file.

<P>The number, <VAR>n</VAR>, of beads is set on the command line with
<CODE>-nchuck=</CODE><VAR>n</VAR>.  The default value is one.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

</BODY>
</HTML>
