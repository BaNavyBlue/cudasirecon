<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
<HEAD>
  <META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <TITLE>Priism Help: APPL_PRM</TITLE>
  <META NAME="Description" CONTENT="On-line help for the application which calculates a mass-normalized and aligned projection series.">
  <META NAME="Keywords" CONTENT="Priism,EM,tomography,reconstruction">
  <LINK REV=MADE HREF="mailto:ive@msg.ucsf.edu">
</HEAD>
<BODY>

<H1><A NAME="APPL_PRM">APPL_PRM</A></H1>
<H2>Overview</H2>
<P>With alignment parameters and the conversion factors for electron counts
to mass density (both are loaded from the file pointed to by the
<A HREF="#InputAlignment">input alignment parameter file</A>), APPL_PRM
creates a mass normalized and aligned data stack for reconstruction.

<P>Here's an example command file for APPL_PRM:
<PRE>
    (time appl_prm \
     /mama/weiping/test/centSr.stk \
     /mama/weiping/test/centSr.MnAln \
     -iprmfile=/mama/weiping/test/centSr.bprmMn \
     -dimxy=480:480 -iv=0:22:1 -shxyz=0:0:0 -iref=-1 \
     -imform=0 -pcbase=.05 ) \
     &gt; /mama/weiping/emrecon.log
</PRE>

<H3><A NAME="Parameters">Parameters</A></H3>
<P>
   <A HREF="#TiltSeries">Tilt series</A> |
   <A HREF="#AlignedSeries">Aligned series</A> |
   <A HREF="#NX:NY:NV">NX:NY:NV</A> |
   <A HREF="#InputAlignment">Input alignment</A> |
   <A HREF="#OutputXY">Output XY</A> |
   <A HREF="#SectionRange">Section range</A> |
   <A HREF="#OutputShift">Output shift</A> |
   <A HREF="#ReferenceProjection">Reference projection</A> |
   <A HREF="#ImageFormation">Image formation</A> |
   <A HREF="#pcBase">pcBase</A> |
   <A HREF="#TiltOffset">Tilt offset</A> |
   <A HREF="#Statistics">Statistics</A> |
   <A HREF="#ApplyAlignment">Apply alignment</A> |
   <A HREF="#Resolution">Resolution</A> |
   <A HREF="#FullSize">Full size</A> |
   <A HREF="#ResolutionScale">Resolution scale</A> |
   <A HREF="#Multires">Add multires</A>

<H3>Related Priism Topics</H3>
<P>
  <A HREF="../Priism.html">Priism</A> |
  <A HREF="EMTAR.html">Alignment and reconstruction</A> |
  <A HREF="MASSNORM.html">MASSNORM</A> |
  <A HREF="EWBP.html">EWBP</A> |
  <A HREF="TAPIR.html">TAPIR</A> |
  <A HREF="BALIGN.html">Alignment with markers</A>

<HR>

<H2><A NAME="TiltSeries">Tilt Series</A></H2>
<P>This is the name of the file containing the raw projection data stack
from the CCD (i.e. measured in terms of electron counts; data stacks
with the contrast inverted can not be handled).  On the command line,
the tilt series file name is the first argument.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="AlignedSeries">Aligned Series</A></H2>
<P>This parameter names the file that will contain the aligned and mass
normalized data stack.  On the command line, the file name for the aligned
result is the second argument.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="NX:NY:NV">NX:NY:NV</A></H2>
<P>The first two values are, respectively, the x and y dimension of the
projections.  The third value is the number of projections in the data
stack.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="InputAlignment">Input Alignment</A></H2>
<P>This parameter supplies the name of the file with the alignment
information and, optionally, conversion factors for mass normalization.
Usually you would generate the file with <A HREF="MASSNORM.html">MASSNORM</A>.
You could also directly use the files generated by
<A HREF="ALIGN2D.html">cross-correlation alignment</A> or
<A HREF="BALIGN.html">alignment with markers</A>.

<P>On the command line, use <CODE>-iprmfile=</CODE><VAR>filename</VAR>
to supply the name of the parameter file.  If the option is not set or
the filename is not supplied or is <EM>none</EM>, the program will
terminate with an error.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="OutputXY">OutputXY</A></H2>
<P>These two values are, respectively, the x and y dimensions of the
aligned projections.  Usually the full dimensions of the input data are used,
but when doing a quick reconstruction to determine an appropriate value for
the z shift, it is convenient to generate an aligned projection with a
y dimension of one.

<P>On the command line, set the dimensions of the output data stack with
<CODE>-dimxy=</CODE><VAR>nx</VAR><CODE>:</CODE><VAR>ny</VAR>.  If not set,
the output x and y dimensions are the same as the x and y dimensions of the
input data stack.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="SectionRange">Section Range</A></H2>
<P>These three values set which of the input projections are aligned
and mass normalized.  The first value is the index of the first projection
to use, the second value is the index of the last projection to use, and
the third is the index step.  Allowable values for the indices are between
zero and the number of input projections minus one, inclusive.

<P>From the command line, use
<CODE>-iv=</CODE><VAR>first</VAR><CODE>:</CODE><VAR>last</VAR><CODE>:</CODE><VAR>step</VAR> to set the range of projections to process.
When not set, the default is to process the entire input stack: <VAR>first</VAR> is
zero, <VAR>last</VAR> is the number of input projections minus one, and
<VAR>step</VAR> is one.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="OutputShift">Output Shift</A></H2>
<P>These three values (they are in units of pixels) shift the imaginary
3D tilt axis of the projection data from its default location; they are
used to center the reconstruction volume on an object of interest.  The
default orientation of the 3D tilt axis has it pass through the point whose
x and y coordinates are the center of the
<A HREF="#ReferenceProjection">reference projection</A> and whose z
coordinate is the z coordinate of the center of mass of the reference markers
used for alignment.

<P>A good way to determine appropriate values for the shifts is to use the
<A HREF="EMTAR.html#SelectRegion">XY and XZ buttons for region selection</A>
in the main alignment and reconstruction dialog.

<P>Use <CODE>-shxyz=</CODE><VAR>x_shift</VAR><CODE>:</CODE><VAR>y_shift</VAR><CODE>:</CODE><VAR>z_shift</VAR>
to set the shifts on the command line.  If the shifts are not specified, a
value of zero pixels for each shift is assumed.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="ReferenceProjection">Reference Projection</A></H2>
<P>For calculating the effect of the x and y shifts (see the
<A HREF="#OutputShift">output shift parameter</A>), APPL_PRM uses the center
of the reference projection.  Specify the reference projection by its
zero-based index in the file (i.e. a value between zero and the number of
projections minus one) or use a value of negative one to select the projection
whose tilt angle is closest to zero.

<P>The reference projection can be set on the command line with
<CODE>-iref=</CODE><VAR>index</VAR>.  If it is not specified or
<VAR>index</VAR> is less than zero or greater than or equal to the
number of projections in the input file, the projection whose tilt
angle is closest to zero is used.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="ImageFormation">Image Formation</A></H2>
<P>This parameter sets which model should be assumed for the process
of image formation - how electron counts are related to the mass
density of the specimen.  The three options are:

<DL>
  <DT>logarithmic
  <DD>The mass density is linearly related to the logarithm of
    the electron counts.

  <DT>scaled linear
  <DD>The mass density is linearly related to the electron counts.

  <DT>linear
  <DD>The mass density is linearly related to the electron counts.
    The images APPL_PRM generates with this model are simply the
    input images interpolated to account for the alignment parameters.
    APPL_PRM always assumes this model when the
    <A HREF="#InputAlignment">input parameter file</A> does not
    contain mass normalization information.
</DL>

<P>For the logarithmic and scaled linear models, the relationship between
the <VAR>i</VAR>th input image, P(<VAR>i</VAR>,<VAR>j</VAR>,<VAR>k</VAR>)
after interpolation for the alignment parameters and the <VAR>i</VAR>th output
image (i.e. the mass-normalized values),
P'''(<VAR>i</VAR>,<VAR>j</VAR>,<VAR>k</VAR>), is
P'''(<VAR>i</VAR>,<VAR>j</VAR>,<VAR>k</VAR>) =
minimum(h(<VAR>i</VAR>), P''(<VAR>i</VAR>,<VAR>j</VAR>,<VAR>k</VAR>) - a - (b-a)/cos(tilt(<VAR>i</VAR>))).
For the logarithmic model, P''(<VAR>i</VAR>,<VAR>j</VAR>,<VAR>k</VAR>) is
10000 * log(s(<VAR>i</VAR>) / (P'(<VAR>i</VAR>,<VAR>j</VAR>,<VAR>k</VAR>) - s(<VAR>i</VAR>) * c0)).
P'(<VAR>i</VAR>,<VAR>j</VAR>,<VAR>k</VAR>) is
f(<VAR>i</VAR>) / r(<VAR>i</VAR>) * P(<VAR>i</VAR>,<VAR>j</VAR>,<VAR>k</VAR>) - b(<VAR>i</VAR>).
For the scaled linear model, P''(<VAR>i</VAR>,<VAR>j</VAR>,<VAR>k</VAR>) is
f(<VAR>i</VAR>) * s(i0) / (r(<VAR>i</VAR>) * s(<VAR>i</VAR>)) * P(<VAR>i</VAR>,<VAR>j</VAR>,<VAR>k</VAR>) - b(<VAR>i</VAR>).
The other terms are:
<DL>
  <DT>tilt(<VAR>i</VAR>)<DD>Is the tilt angle for the <VAR>i</VAR>th image.
  <DT>i0<DD>Is the index of the image whose tilt angle is closest to zero.
  <DT>f(<VAR>i</VAR>)<DD>Is the value fit by
    <A HREF="MASSNORM.html">massnorm</A> (i.e. column 7 in the parameter file).
  <DT>r(<VAR>i</VAR>)<DD>Is the measured reference value (the quantity fit by
    <A HREF="MASSNORM.html">massnorm</A>; i.e. column 6 in the parameter file).
  <DT>b(<VAR>i</VAR>)<DD>Is the offset determined by
    <A HREF="MASSNORM.html">massnorm</A> (i.e. column 9 in the parameter file).
  <DT>s(<VAR>i</VAR>)<DD>Is the scale factor determined by
    <A HREF="MASSNORM.html">massnorm</A> (i.e. column 8 in the parameter file).
  <DT>h(<VAR>i</VAR>)<DD>Is the intensity such that .001 of the pixels in
    P''(<VAR>i</VAR>,<VAR>j</VAR>,<VAR>k</VAR>) have intensities greater than
    h(<VAR>i</VAR>).
  <DT>l(<VAR>i</VAR>)<DD>Is the intensity such that .05 of the pixels in
    P''(<VAR>i</VAR>,<VAR>j</VAR>,<VAR>k</VAR>) have intensities less than
    l(<VAR>i</VAR>).
  <DT>a<DD>Is the y intercept for the best fit line to the graph of
    l(<VAR>i</VAR>) versus 1/cos(tilt(<VAR>i</VAR>)).
  <DT>b<DD>b is the intensity such that the fraction,
    <A HREF="#pcBase">pcBase</A>, of the pixels in
    P''(i0,<VAR>j</VAR>,<VAR>k</VAR>) have intensities less than b.
  <DT>c0<DD>c0 is the minimum of zero and P'(im,jm,km) / s(km) where im, jm,
    and km are the indices that give the smallest value of
    P'(<VAR>i</VAR>,<VAR>j</VAR>,<VAR>k</VAR>).
</DL>

<P>On the command line, use <CODE>-imform=0</CODE> to use the logarithmic
model, <CODE>-imform=1</CODE> to use the scaled linear model,
or <CODE>-imform=2</CODE> to use the linear model.  If the
<A HREF="#InputAlignment">input alignment file</A> does not contain
mass normalization data, APPL_PRM ignores the <CODE>-imform</CODE> options
and always assumes the linear model.  If you do not supply a
<CODE>-imform</CODE> option and the
<A HREF="#InputAlignment">input alignment file</A> has mass normalization
data, APPL_PRM uses the logarithmic model.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="pcBase">pcBase</A></H2>
<P>With the scaled linear or logarithmic
<A HREF="#ImageFormation">image formation models</A>, the <EM>pcBase</EM>
parameter affects the contribution of an additive term corresponding to a sheet
of uniform mass density.

<P>On the command line, set pcBase with
<CODE>-pcbase=</CODE><VAR>cutoff</VAR>.  When it is not set, appl_prm uses a
a value of 0.05.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="TiltOffset">Tilt Offset</A></H2>
<P>The value of this parameter, assumed to be in degrees, is added to
the tilt angles stored in the header of the output data stack and used
in the mass normalization calculation.  On the command line you can supply
the tilt offset by specifying <CODE>-tilt_offset=</CODE><VAR>angle</VAR>.
When no offset is set, a value of zero is assumed.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Statistics">Statistics</A></H2>
<P>If the <A HREF="#ImageFormation">image formation model</A> is not linear,
APPL_PRM can write out a text file with some intermediate
results for each projection:  the 1/cos(tilt_angle) factor and the intensity
corresponding to the cutoff for the lower 5% of the histogram.  To cause these
results to be written, enter a name different than "none" in the "Statistics"
field.  As a shortcut, you can turn on the toggle button adjacent to the
"Statistics" field to insert the base name for the input tilt series plus a
.applprm_stat extension.  From the command line, use

<PRE>
    -statfile=<VAR>name</VAR>
</PRE>

<P>to specify the file name for the intermediate results; if you do not use
a <CODE>-statfile</CODE> option, APPL_PRM will assume <VAR>name</VAR> was
"none" and will not write out the intermediate results.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="ApplyAlignment">Apply Alignment</A></H2>
<P>When the "Apply alignment" toggle button is on, APPL_PRM generates an
aligned data stack; when it is off, APPL_PRM only applies the conversion from
electron counts to mass density when generating the output data stack (if you
specify a change to the image size or shift the region of interest, however,
those will be applied as if there was no other alignment information
available).  When run from the command line, generating an aligned data stack
is the default and to disable the alignment you must specify the option
<CODE>-noalign</CODE>.

<P>If you want to disable the conversion from counts to mass density, use the
<A HREF="#ImageFormation">linear image formation model</A>.

<P>The relationship between a coordinate, (x,y), in the unaligned projection k,
to a coordinate, (x',y'), in the corresponding aligned projection is given by
the linear transformation:
<PRE>
    [ x ]          [  cos(r(k))  -sin(r(k)) ] [ x'-0.5*(nx'-1) ]   [ tx(k)+0.5*(nx-1) ]
    [   ] = m(k) * [                        ] [                ] + [                  ]
    [ y ]          [  sin(r(k))   cos(r(k)) ] [ y'-0.5*(nx'-1) ]   [ ty(k)+0.5*(ny-1) ]
</PRE>

<P>m(k) is the magnification for the kth projection; the value is read from
the third column of the parameter file.  r(k) is the rotation angle for the kth
projection; the value, in degrees, is read from the second column of the
parameter file. tx(k) and ty(k) are the two components of the translation for
the kth projection; the values for those are read from the fourth and fifth
columns, respectively, of the parameter file.  nx' and ny' are the dimensions,
in pixels, for the aligned frame.  nx and ny are the dimensions, in pixels,
for the unaligned frame.  The coordinates for the samples in the aligned image
are integers drawn from the range, [0, nx'-1], for the first coordinate and
the range, [0, ny'-1], for the second coordinate.  The coordinates for the
samples in the unaligned image are integers drawn from the range, [0, nx-1],
for the first coordinate and the range, [0, ny-1], for the second coordinate.

<P>When the alignment parameters are used to align a lower resolution version
of the input data, appl_prm uses the linear transformation given above with
values for the image dimensions and translations that have been corrected for
the resolution change.  If nxh, nyh, nxh', and nyh' are the dimensions of the
unaligned and aligned images in the higher resolution, the dimensions of the
images in the lower resolution are:
<PRE>
    nx = truncate(nxh/s)
    ny = truncate(nyh/s)
    nx' = truncate(nxh'/s)
    ny' = truncate(nyh'/s)
</PRE>
<P>where s is the scaling factor between the two resolutions.  The translations
in the lower resolution are calculated from those, txh(k) and tyh(k), in the
higher resolution as follows:
<PRE>
   tx(k) = (txh(k) + 0.5*(nxh-1) - s*0.5*(nx-1)) / s
   ty(k) = (tyh(k) + 0.5*(nyh-1) - s*0.5*(ny-1)) / s
</PRE>

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Resolution">Resolution</A></H2>
<P>The resolution parameter selects which resolution to process from the
input tilt series.  0 is the highest (full) resolution.  From the user
interface, you would normally select the resolution from the main
<A HREF="EMTAR.html">EMTAR</A> dialog and allow the software to propagate
the setting to the individual processing stages.  You can also set the
resolution to process specifically for the application of the alignment
and mass-normalization parameters from the special parameters dialog for
"Apply Parameters".

<P>On the command line, use
<PRE>
    <CODE>-res=</CODE><VAR>i</VAR>
</PRE>
<P>to apply of the alignment and mass-normalization parameters to the
<VAR>i</VAR>th resolution.  When run from the command line and no resolution
is selected, the calculations will use the the highest resolution
present in the input tilt series.

<P>Two other parameters, the <A HREF="#FullSize">full size</A> and
<A HREF="#ResolutionScale">resolution scale</A>, affect the handling
of resolution.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="FullSize">Full Size</A></H2>
<P>Use the full size parameter to specify the dimensions, in pixels, of the
full resolution tilt series corresponding to the input tilt series.  In the
typical case where you select a resolution level to process from the main
dialog of <A HREF="EMTAR.html">EMTAR</A>, the graphical interface will
automatically fill in these values correctly.  In the case where you are
applying the alignment and mass-normalization parameters to a downsampled
file but the input parameters are for the full resolution data set, you should
adjust the full size parameters to be the dimensions of the full resolution
data set.

<P>On the command line, use
<PRE>
    <CODE>-fullsize=</CODE><VAR>nx</VAR>:<VAR>ny</VAR>
</PRE>
<P>to specify the dimensions, in pixels, of the full resolution data set.
When run from the command line without the -fullsize option, apply parameters
will use the dimensions of the highest resolution present in the input
tilt series for the full size.

<P>Two other parameters, the <A HREF="#Resolution">resolution</A> and
<A HREF="#ResolutionScale">resolution scale</A>, affect the handling
of resolution.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="ResolutionScale">Resolution Scale</A></H2>
<P>The resolution scale parameter controls the scale factor applied to
the alignment parameters and to the output size and shift.  In the typical
case where you select a resolution level to process from the main dialog of
EMTAR, the graphical interface will automatically fill in the resolution
scale correctly.  In the case where you are applying the alignment and
mass-normalization parameters to a downsampled file but the input
alignment parameters are for the full resolution data set, you should
set the resolution scale to be the same as the downsampling factor (if the
data is scaled down by a factor of four set the resolution scale parameter to
four).

<P>On the command line, use
<PRE>
    <CODE>-rscale=</CODE><VAR>i</VAR>
</PRE>
<P>to set the resolution scale to be <VAR>i</VAR>.  When run from the
command line without the -rscale option, apply parameters will use a
resolution scale factor equal to two raised to the power of the
<A HREF="#Resolution">resolution level</A> selected with -res.

<P>Two other parameters, the <A HREF="#Resolution">resolution</A> and
<A HREF="#FullSize">full size</A>, affect the handling of resolution.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Multires">Add Multires</A></H2>
<P>Turn on the "Add multires" toggle button to cause apply parameters
to add lower resolutions to the aligned and mass-normalized tilt series if
the x and y dimensions of the tilt series are large enough.  Turn off the
"Add multires" toggle button to cause apply parameters to always generate
a tilt series with a single resolution.

<P>On the command line, include
<PRE>
    <CODE>-multires</CODE>
</PRE>
<P>in the command-line options for apply parameters to cause apply parameters
to add lower resolutions to the tilt series if the x and y dimensions of the
tilt series are large enough.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

</BODY>
</HTML>
