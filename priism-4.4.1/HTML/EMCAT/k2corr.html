<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
<HEAD>
  <META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <TITLE>Priism Help: k2corr</TITLE>
  <META NAME="Description" CONTENT="On-line help for the application to detect and edit out bad pixels in data from Gatan's K2 camera.">
  <META NAME="Keywords" CONTENT="Priism,EM,tomography,correction">
  <LINK REV=MADE HREF="mailto:ive@msg.ucsf.edu">
</HEAD>
<BODY>

<H1><A NAME="k2corr">k2corr</A></H1>
<H2>Overview</H2>
<P>k2corr is intended to detect and correct bad pixels in the output from
Gatan's K2 camera.  While it can work with a single frame of data, you should
normally give it a series of frames since that allows the tests for the bad
pixels to be more robust.  The bad pixel detection algorithm that k2corr uses
assumes that the sum of the input frames can be approximated by a normal
distribution.  A small number of input frames or a low number of counts in
each frame can violate that assumption.  The descriptions for
<A HREF="#Threshold0">threshold 0</A> and <A HREF="#Threshold1">threshold 1</A>
provide more detail about the assumption of a normal distribution.

<P>The default parameters should be adequate for k2corr so that all you should
have to specify is the <A HREF="#ImageSeries">input image sequence</A> and
<A HREF="#CorrectedResult">where to write the corrected result</A>.
Optionally, you can specify <A HREF="#BadPixelInput">a list of pixels already
know to be bad</A> and have k2corr <A HREF="#BadPixelOutput">write out the
list of bad pixels</A> (that will include the pixels from the input lists and
any detected by k2corr's algorithm).  To tune k2corr's bad pixel detection
algorithm, the most useful parameters that you can vary are the three
threshold levels for the different detection stages (the third of those is
the most important for the bad pixels selected), the two neighborhood sizes
for the last two detection stages (in the graphical user interface, the
neighborhood sizes are in the special parameters dialog), and the
<A HREF="#DoseRate">dose rate</A>.

<P>The bad pixel detection algorithm that k2corr uses is this:
<OL>
  <LI>Sum the images in the input series.  The reason for that is single-frame
    statistical tests (or the combination of those tests) did not reliably
    detect bad pixels that have systematically lower response levels.
  <LI>In the summed image, mark pixels as bad that exceed a
    <A HREF="#Threshold0">user-set threshold</A> given the
    <A HREF="#DoseRate">expected dose rate</A> or were marked as bad in one
    of the <A HREF="#BadPixelInput">input bad pixel lists</A>.
  <LI>Split the results from the previous step into non-overlapping blocks
    of <A HREF="#Size1">a given size</A> and compute the mean of each block
    excluding any bad pixels.  Then, for each pixel in the block, mark the
    pixel as bad if it is <A HREF="#Threshold1">sufficiently far into either
    tail</A> of the normal distribution with a mean equal to the block mean
    and a standard deviation equal to the square root of <VAR>m</VAR> /
    <VAR>c</VAR> * (1 - <VAR>m</VAR> / (<VAR>c</VAR> * <VAR>n</VAR>)) where
    <VAR>m</VAR> is the block mean, <VAR>c</VAR> is the conversion factor
    <A HREF="#ElectronToValue">between electrons and image value</A>, and
    <VAR>n</VAR> is the total exposure time divided by the
    <A HREF="#SamplingRate">camera's internal sampling rate</A>.
  <LI>Consider each pixel in the summed image and mark the pixel as bad
    if (<VAR>p</VAR> - <VAR>a</VAR>) * (<VAR>p</VAR> - <VAR>a</VAR>) /
    <VAR>v</VAR> is <A HREF="#Threshold2">sufficiently large</A>.  <VAR>p</VAR>
    is the value at the pixel.  <VAR>a</VAR> is the average value over the
    <A HREF="#Size2">local neighborhood</A> centered on the pixel where any
    pixels previously identified as bad are excluded from the sum.
    <VAR>v</VAR> is the larger of the
    <A HREF="#MinimumVariance">minimum variance parameter</A> and the sample
    variance for that same local neighborhood with the bad pixels excluded.
  <LI>Go through the pixels flagged as bad and remove those that were only
    flagged by threshold 0 or threshold 1.
</OL>
<P>You can turn of bad pixel detection (in other words, force k2corr to use
the input bad pixel lists without modifications); see the
<A HREF="#Detect">detect bad pixels topic</A> for more details.  If requested,
k2corr will write a list of the bad pixels (including both the input bad pixels
and any flagged by the detection algorithm) to a text file; see the
 <A HREF="#BadPixelOutput">bad pixel output topic</A> for more details.

<P>The bad pixel correction algorithm that k2corr uses is this:
<OL>
  <LI>Choose the first pattern from the four horizontally connected neighbors,
    the four diagonally connected neighbors, the four neighbors at distance
    of two pixels, and the four neighbors at a distance of the square root of 8
    pixels, where at least one of the pixels in the pattern has not been
    marked as a bad pixel.
  <LI>The corrected value at the pixel is the average of the good pixels
    in the selected pattern.  If all the patterns had no good pixels, set
    the pixel value to the mean for the image.
</OL>
<P>k2corr will not apply bad pixel correction if you do not specify a filename
for the <A HREF="#CorrectedResult">corrected images</A>.

<H3><A NAME="Parameters">Parameters</A></H3>
<P>
    <A HREF="#ImageSeries">Image series</A>
    <A HREF="#BadPixelInput">Bad pixel input</A> |
    <A HREF="#CorrectedResult">Corrected result</A> |
    <A HREF="#BadPixelOutput">Bad pixel output</A> |
    <A HREF="#DoseRate">Dose rate</A> |
    <A HREF="#Threshold0">Threshold 0</A> |
    <A HREF="#Threshold1">Threshold 1</A> |
    <A HREF="#Threshold2">Threshold 2</A> |
    <A HREF="#GainCorrection">Gain correction</A> |
    <A HREF="#Detect">Detect bad pixels</A> |
    <A HREF="#Multires">Add resolutions</A> |
    <A HREF="#Size1">Region size 1</A> |
    <A HREF="#Size2">Region size 2</A> |
    <A HREF="#ExposureTime">Exposure time</A> |
    <A HREF="#MinimumVariance">Minimum variance</A> |
    <A HREF="#SamplingRate">Sampling rate</A> |
    <A HREF="#ElectronToValue">e- to value</A> |
    <A HREF="#OutputFormat">Output format</A> |
    <A HREF="#OutputScale">Output scale</A> |
    <A HREF="#CommandLine">Command line</A>
<HR>

<H2><A NAME="ImageSeries">Image Series</A></H2>
<P>k2corr requires one image series, in Priism's version of the MRC format,
as input.  From the graphical user interface, set the filename for that image
series using the field next to the button labeled "ImageSeries".  You can
press that button to select the file with a file browser.  On the command line,
pass the filename of the image series as the first argument to k2corr.

<P>If the extended header for the image series is not present or is not in
UCSF Tomography's format, you should set the
<A HREF="#ExposureTime">exposure time</A> since k2corr will not be able to
extract that information from the extended header.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="BadPixelInput">Bad Pixel Input</A></H2>
<P>k2corr can accept one or more lists of bad pixels.  k2corr will exclude
those bad pixels from the statistics calculations during bad pixel detection.
During the correction step, k2corr will correct both the input bad pixels and
any that k2corr detects.

<P>In the graphical user interface, you can specify a bad pixel list by
entering the filename in the field next to the button labeled
"Bad pixel list (in)".  You can also press that button to select the file with
a file browser.  If the filename in the field is empty or is "none", k2corr
will not expect an input bad pixel list.  If the filename is "-", k2corr will
read the pixel list from standard input.  On the command line, use the
option, <CODE>-inbad=</CODE>, to set the filename for an input bad pixel list.
As with the graphical interface, k2corr will ignore the option if the filename
is empty or "none" and will read the bad pixels from standard input if the
filename is "-".  Using the command line, you may have multiple input lists
by specifying <CODE>-inbad=</CODE> for each list.

<P>The bad pixel list must be in text format.  Any lines which do not begin
with two integer values or with two floating-point values will be ignored.  In
the lines that are not ignored, the first value (rounded to the nearest integer
if floating-point) will be used as the zero-based x coordinate and the second
value  (rounded to the nearest integer if floating-point) will be used as the
zero-based y coordinate.  Coordinates are assumed to relative to the full
dimensions (prior to any region selection) of the input image stack.  Any
coordinates beyond the bounds of the region selected are ignored.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="CorrectedResult">Corrected Result</A></H2>
<P>k2corr will write the corrected image series as an MRC file (in Priism's
format).  From the graphical user interface, enter the file name to use in the
field labeled "Corrected".  When the toggle button adjacent to that field is
on, the graphical user interface will automatically select a file name based
on the name of the <A HREF="#ImageSeries">input image series</A>.  On the
command line, use the <CODE>-corrected=</CODE> option to set the filename for
output image series.  If the filename is empty or is equal to "none" (or has
not been set from the command line), k2corr will not correct the input image
series.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="BadPixelOutput">Bad Pixel Output</A></H2>
<P>k2corr can write the list of bad pixels (including those read
from the <A HREF="#BadPixelInput">input lists</A> and those detected by
k2corr) to a text file.  From the graphical user interface, enter the file
name for the output bad pixel list in the field next to the button labeled
"Bad pixel list (out)".  If the toggle button next to that field is on,
the user interface will automatically select a file name based on the name of
the <A HREF="#ImageSeries">input image series</A>.  On the command line, use
the <CODE>-outbad=</CODE> option to set the filename for the output bad pixel
list.  If the filename is empty or is equal to "none", k2corr will not write
the output bad pixel list.

<P>The output bad pixel list will be in a text format with one line per bad
pixel.  The content of such a line will be the x coordinate (zero-based as an
integer), y coordinate (zero-based as an integer), an integer to indicate how
the pixel was added to the list, the frame sum at the pixel, the local mean
estimate used for threshold 2, the local variance estimate used for
threshold 2, and the score at the pixel for testing against threshold 2.  The
values are separated by spaces.  The integer indicating how the pixel was
added to the list is a bitwise-or of one of the following:
<DL>
  <DT>1<DD>Added from the input list of bad pixels.
  <DT>2<DD>Added by exceeding threshold 0.
  <DT>4<DD>Added by being less than the lower bound set by threshold 1.
  <DT>8<DD>Added by exceeding the upper bound set by threshold 1.
  <DT>16<DD>Added by exceeding threshold 2.
</DL>

<P>The score for the test against threshold 2 is the value at the pixel for
<PRE>(series sum - local_mean(series sum))^2 /
     maximum(local_variance(series sum), vl)
</PRE>
<P>vl is the <A HREF="#MinimumVariance">minimum variance</A>.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="DoseRate">Dose Rate</A></H2>
<P>The first stage of bad pixel detection uses a test of the pixel value
against an expected value based on the dose rate and exposure time.  The
primary purpose of this test is to exclude pixels with extremely high
values that would distort the statistics used in the subsequent stages of
bad pixel detection.  For the dose rate, it is easiest to use the value,
in electrons per second, that the sample is expected to receive.  You could
use the dose rate at the camera, but then it should correspond to the expected
value where the sample has attenuated the beam the least.

<P>From the graphical user interface, set the dose rate by entering the value,
in electrons per second, in the field next to the button labeled
"Dose rate (e-/sec)".  On the command-line, use
<CODE>-doserate=</CODE><VAR>d</VAR> to set the dose rate to <VAR>d</VAR>
electrons per second.  The dose rate must be positive.  If it is not set,
k2corr will use a value of ten electrons per second.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Threshold0">Threshold 0</A></H2>
<P>The first stage of bad pixel detection uses a test of the pixel value (after
summing across the image sequence) against an expected value based on the dose
rate and accumulated exposure time.  The primary purpose of this test is to
exclude pixels with extremely high values that would distort the statistics
used in the subsequent stages of bad pixel detection.  Threshold 0 is the
cutoff for the test:  one half of threshold 0 is the chance that a value drawn
from the expected distribution (in other words, a good pixel) would be flagged
as a bad pixel.  The expected distribution is a scalar (the conversion factor
<A HREF="#ElectronToValue">between electrons and the recorded pixel value</A>)
times a binomial distribution with <VAR>n</VAR> trials (<VAR>n</VAR> is the
largest integer less than or equal to the <A HREF="#SamplingRate">internal
sampling rate</A> times the summed exposure time for the image sequence) and a
probability of success, <VAR>p</VAR>, for each trial equal to the
<A HREF="#DoseRate">dose rate</A> divided by the internal sampling rate.  To
simplify the calculations, k2corr assumes that the binomial distribution can
be decently approximated with a normal distribution.  One common criteria for
that assumption is that <VAR>n</VAR> * minimum(<VAR>p</VAR>, 1 - <VAR>p</VAR>)
be greater than ten.

<P>From the graphical user interface, you can set the value for threshold
0 by changing the value in field next to the button labeled "Threshold 0".
On the command line, include <CODE>-thresh0=</CODE><VAR>t</VAR> in the options
to set the threshold to be equal to the floating-point value, <VAR>t</VAR>.
In either case, the threshold must be greater than zero and less than or
equal to one.  The default value for the threshold is 1e-12.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Threshold1">Threshold 1</A></H2>
<P>The second stage of bad pixel detection algorithm tests a pixel's value
(after summing across the image sequence) against a local estimate of the
mean.  The local estimate of the mean is the average (excluding any bad
pixels already flagged) for the rectangular block containing the pixel.  The
blocks do not overlap and are squares whose size is set by the
<A HREF="#Size1">size 1 parameter</A> unless they are the last block in a row
or column where the dimensions of the block are extended to the left or
top edge of the image.  k2corr assumes that a good pixel's value is a random
variable drawn from a distribution equal to a scalar (the conversion factor
<A HREF="#ElectronToValue">between electrons and the recorded pixel value</A>)
times a binomial distribution with <VAR>n</VAR> trials (<VAR>n</VAR> is the
largest integer less than or equal to the <A HREF="#SamplingRate">internal
sampling rate</A> times the summed exposure time for the image sequence) and a
probability of success, <VAR>p</VAR>, for each trial equal to the
local mean estimate divided by the product of <VAR>n</VAR> and the electron to
counts conversion factor.  Let <VAR>fl</VAR> be the fraction of that
distribution which is less than the observed pixel value and let <VAR>fh</VAR>
the the fraction of that distribution which is greater than the observed pixel
value.  If <VAR>fl</VAR> of <VAR>fh</VAR> is less than half of the value for
threshold 1, k2corr flags the pixel as a bad pixel.  To simplify the
calculations, k2corr assumes that the binomial distribution can be decently
approximated with a normal distribution.  One common criteria for that
assumption is that <VAR>n</VAR> * minimum(<VAR>p</VAR>, 1 - <VAR>p</VAR>)
be greater than ten.

<P>From the graphical user interface, you can set the value for threshold 1
by changing the value in the field next to the button labeled "Threshold 1".
On the command line, include <CODE>-thresh1=</CODE><VAR>t</VAR> in the options
to set threshold to be equal to the floating-point value, <VAR>t</VAR>.  In
either case, the threshold must be greater than zero and less than or equal to
one.  The default value for the threshold is 1e-12.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Threshold2">Threshold 2</A></H2>
<P>The final stage of bad pixel detection compares a pixel's value (after
summing across the image sequence) against a local estimate of the mean and
variance.  If the square of the difference between the pixel's value and
the local mean divided by the variance, exceeds threshold 2, k2corr flags
the pixel as bad.  The local mean and variance are computed over a square,
centered on the pixel, whose size is given by the
<A HREF="#Size2">size 2 parameter</A>.  The estimates of the statistics exclude
any bad pixels already flagged.

<P>From the graphical user interface, you can set the value for threshold 2
by changing the value in the field next to the button labeled, "Threshold 2".
On the command line, include <CODE>-thresh2=</CODE><VAR>t</VAR> in the options
to set the threshold to be equal to the floating-point value, <VAR>t</VAR>.  In
either case the threshold must be greater than zero.  The default value for the
threshold is 140.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="GainCorrection">Gain Correction</A></H2>
<P>In some cases, the data from the K2 may not have been corrected for
pixel to pixel variations in the gain or quantum efficiency.  If you have
the image of the gain corrections (either stored at the end of the extended
header in the input image series or as the first image in a separate MRC
file), you can have k2corr correct the input data.  To do so from the user
interface, change the menu next to the button labeled "Gain correction" to be
either "from header" (if the gain correction image is stored at the end of
the extended header of the input image series) or "from file" (if the gain
correction image is stored as the first image in an MRC file).  In the latter
case, enter the name of the file in the field on the next line or press the
button labeled "Gain correction file" on that line to select the file with
a file browser.  On the command line, include <CODE>-ingain=header</CODE> in
the options to have k2corr read and apply the gain correction from the extended
header or <CODE>-ingain=</CODE><VAR>filename</VAR> to have k2corr read the
gain correction image from the first image in the file named
<VAR>filename</VAR>.

<P>If you are working with data that has not been gain corrected, there are a
handful of k2corr's parameters that you'll likely want to change from their
default settings:
<UL>
  <LI>For data that has not been gain corrected, the
    <A HREF="#ElectronToValue">conversion factor from electron events to image
    counts</A> is usually one rather than the default value, 100, that k2corr
    uses.
  <LI>The <A HREF="#MinimumVariance">minimum variance</A> parameter varies
    with the square of the electron event to image count conversion factor.
    If you adjust that factor, you'll likely want to adjust the minimum
    variance as well.
  <LI>The uncorrected data would normally be stored with one byte per pixel.
    By default, k2corr will store the corrected results with two bytes per
    pixel.  To preserve much of the effects of the gain correction, you should
    specify a <A HREF="#OutputScale">scaling factor</A> for the output.  A
    common choice would be a scaling factor of one hundred.  Alternatively,
    you could have k2corr <A HREF="#OutputFormat">store the corrected results
    as floating-point values</A> to more faithfully represent the results of
    the gain correction at the cost of a file that takes up twice as much
    space.
</UL>

<P>Gatan's software generates a gain correction image that should be multiplied
with the raw data to generate the corrected result.  If the gain correction
image you have should be used to divide the input data, you can have k2corr
apply it by specifying the source of the gain image as described above
and then turning on the toggle button labeled "Invert gain" in the graphical
user interface or including <CODE>-invertgain</CODE> in the command line
options.

<P>When k2corr applies a gain correction, it can also write out the gain
correction it applied to an MRC file.  To have it do so from the user
interface, open the special parameters dialog for k2corr, and enter the
file name to use in the field next to the button labeled "Output gain file".
You can use the toggle button at the end of that line to have the user
interface select a file name based on the name of the input image series.
To cause k2corr to write the gain correction when invoking k2corr from the
command line, include <CODE>-outgain=</CODE><VAR>filename</VAR> in the
options where <VAR>filename</VAR> is the name of the file that will contain
the gain correction image.  If you chose to invert the gain correction image,
the image that k2corr writes will be inverted.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Detect">Detect Bad Pixels</A></H2>
<P>By default, k2corr attempts to detect bad pixels.  You can disable bad
pixel detection so that k2corr uses the <A HREF="#BadPixelInput">input bad
pixel lists</A> without modification.  To do that from the graphical user
interface, turn off the toggle button labeled "Detect bad pixels"; that toggle
button is in the special parameters dialog for k2corr.  To disable bad
pixel detection from the command-line, include <CODE>-no-baddetect</CODE> in
k2corr's command-line options.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Multires">Add resolutions</A></H2>
<P>When k2corr writes the
<A HREF="#CorrectedResult">corrected image sequence</A>, it can add lower
resolution versions of the data set to the MRC file.  When it does so, it
adds resolutions until the larger of the x and y dimensions for the downsampled
data has 256 or less samples or until the smaller of the x and y dimensions for
the downsampled data has one sample.  From the graphical user interface,
adding lower resolutions is enabled by default and can be turned off by turning
off the toggle button labeled "Add resolutions" in k2corr's special parameters
dialog.  On the command line, you'll have to include <CODE>-multires</CODE> in
k2corr's command-line options to add lower resolutions to the corrected image
sequence.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Size1">Region Size 1</A></H2>
<P>The local mean estimates for the second stage of bad pixel detection are
computed for non-overlapping blocks with a size that you specify (the blocks
in the last column or row can deviate from that size to cover the extent of the
image).  From the graphical user interface, you can set the size, in pixels,
for the side of the block by entering the value in the field labeled
"Region size 1".  That field is in the special parameters dialog for k2corr.
On the command line, include <CODE>-rsize1=</CODE><VAR>n</VAR> in k2corr's
options to set the size to be <VAR>n</VAR> pixels.  <VAR>n</VAR> must be
positive integer.  The default value for the size is 100.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Size2">Region Size 2</A></H2>
<P>The local mean and variance estimates for the third stage of bad pixel
detection use a square region, centered on the pixel to be tested.  You can
specify the size of the square region.  The size must be an positive odd
integer greater than or equal to three.  Since 3 x 3 blocks of bad pixels have
been observed in data from K2 cameras, the smallest recommended size is five.
The default value for the size is five.

<P>From the graphical user interface, you can set the size, in pixels, for the
square by entering the value in the field labeled "Region size 2".  That
field is in the special parameters dialog for k2corr.  On the command line,
include <CODE>-rsize2=</CODE><VAR>n</VAR> in k2corr's options to set the size
to be <VAR>n</VAR> pixels.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="ExposureTime">Exposure Time</A></H2>
<P>k2corr normally uses the extended header of the
<A HREF="#ImageSeries">input image sequence</A> to determine the exposure time
for each image.  If the extended header is not present or is not in the format
generated by UCSF Tomography or you wish to override what is present in the
extended header, you can specify that all the images have the same exposure
time.

<P>From the graphical interface, you can set the exposure time, in seconds,
by opening k2corr's special parameters dialog, turning off the toggle button
labeled "use header", and entering the desired exposure time in the field
adjacent to that button.  To restore the default behavior of reading the
exposure times from the extended header, turn the toggle button labeled
"use header" back on.

<P>On the command line, include <CODE>-exptime=</CODE><VAR>t</VAR> in k2corr's
options to set the exposure time for each image to be <VAR>t</VAR> seconds.
When you do not use that option, k2corr will read the exposure times from the
extended header, or when that is not possible, will use an exposure time of
one second for each image.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="MinimumVariance">Minimum Variance</A></H2>
<P>In the third stage of bad pixel detection, k2corr divides by a local
estimate of the variance.  To prevent division by zero, k2corr coerces the
local estimate of the variance to be a small positive value (by default, 4.0).
You can change that value.  To do so from the graphical user interface,
enter the value in the field labeled "Minimum variance"; that field is in
k2corr's special parameters dialog.  To do so from the command line,
include <CODE>-vmin=</CODE><VAR>v</VAR> in k2corr's options where <VAR>v</VAR>
is the desired minimum value for the variance.  The value that you specify
in either case must be greater than zero.

<P>The default value comes from assuming a total exposure time of two hundred
seconds and an internal sampling rate of 400 samples per second to find the
binomial distribution with 80000 trials and probability of success per trial of
<VAR>p</VAR> that would have a probability of at least 99 percent for
generating 25 samples (i.e. the default region size for the third stage of
bad pixel detection) that are all zero.  p works out to be around 5e-9 so
that the variance of the distribution is around 4e-4 electrons squared or 4
(assuming a conversion factor of 100).

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="SamplingRate">Sampling Rate</A></H2>
<P>k2corr's model for the K2 camera assumes that each pixel is sampled
internally at a fixed rate where each sample will be either zero or one.  The
reported measurement is the sum of the samples multiplied by the
<A HREF="#ElectronToValue">conversion factor from electrons to image value</A>.
You can set the sampling rate.  To do so from the graphical interface, open
k2corr's special parameters dialog and enter the sampling rate (in samples
per second) in the field next to the button labeled "Sampling rate".  To do so
on the command line, include <CODE>-samprate=</CODE><VAR>s</VAR> in k2corr's
options where <VAR>s</VAR> is the desired sampling rate in samples per
second.  By default, k2corr uses a sampling rate for 400 samples per second
which is what current K2 hardware uses.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="ElectronToValue">e- to Value</A></H2>
<P>UCSF Tomography multiplies the number of electrons reported by the K2
camera by a scalar factor (current versions use 100) before recording the data.
Since k2corr uses the electron statistics for some of the stages of bad pixel
detection, k2corr needs to know the conversion factor from electrons to
the value recorded in the image file.

<P>By default, k2corr assumes that the conversion factor is 100.  If you
need to work with data that was recorded with a different conversion factor,
you can change k2corr's assumption.  To do so from the graphical interface,
open k2corr's special parameters dialog and enter the desired conversion
factor in the field next to the button labeled "e- to value".  To do so
on the command line, include <CODE>-cnt2val=</CODE><VAR>c</VAR> where
<VAR>c</VAR> is the conversion factor.  The conversion factor must be positive.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="OutputFormat">Output Format</A></H2>
<P>k2corr will write the corrected images using either a 16-bit unsigned
integer or 32-bit floating-point value to represent each pixel's value.  By
default, k2corr will use 16-bit unsigned integers.  To set the output format
from the user interface, open k2corr's special parameters dialog and change
the menu next to the button labeled "Output format" to the desired format.
To set the output format from the command line, include
<CODE>-mode=ushort</CODE> in the command line options to have the data written
as 16-bit unsigned integers or include <CODE>-mode=float</CODE> in the
command line options to have the data written as 32-bit floating-point values.

<P>If you save the corrected data as 16-bit unsigned integers, you have the
option of <A HREF="#OutputScale">scaling the corrected results</A> by a
constant factor before rounding them to the nearest integer and saving them.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="OutputScale">Output Scale</A></H2>
<P>If <A HREF="#OutputFormat">k2corr saves the output as 16-bit unsigned
integers</A>, you may specify a scale factor that will be applied to the
corrected results before they are rounded and saved to the output file.  To
set the scale factor from the graphical user interface, open k2corr's
special parameters dialog and enter the desired scale factor in the field next
to the button labeled "Output scale".  To set the scale factor to be the
value, <VAR>s</VAR>, from the command line, include
<CODE>-scale=</CODE><VAR>s</VAR> in the command line options.

<P>If the input data has already been gain corrected, then the input data may
have already been scaled by a factor (UCSF Tomography uses a factor of 100)
so you would usually use a scale factor of one, the default value, in that
case.  If the input data has not been gain corrected, you would normally set
the scale factor to something like one hundred so that the rounding of the
output does not obscure most of the effects of the gain correction.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="CommandLine">Command Line</A></H2>
<P>The command-line syntax for invoking k2corr is

<PRE>
    k2corr <VAR>image_series</VAR> <VAR>options</VAR>
</PRE>

<P><VAR>options</VAR> can be one or more of the options described below.  Any
option can appear multiple times, but, with the exception of
<CODE>-inbad</CODE>, only the last occurrence is used when processing the
input series.

<DL>
  <DT><CODE>-badcorrect</CODE><DD>This turns on bad pixel correction.  Note
    that bad pixel correction is on by default.
  <DT><CODE>-baddetect</CODE><DD>This turns on bad pixel detection.  Note that
    bad pixel detection is on by default.
  <DT><CODE>-corrected=</CODE><VAR>cname</VAR><DD>Causes the corrected data to
    be written to the file named <VAR>cname</VAR>.  That may be the same as
    the input file name.  If you do not supply -corrected or <VAR>cname</VAR>
    is empty or equal to "none", k2corr will not perform bad pixel correction.
  <DT><CODE>-cnt2val=</CODE><VAR>c</VAR><DD>Sets the scalar by which electron
    counts are multiplied before they are stored.  c must be greater than zero.
    If you do not use this option, k2corr will assume the electron counts were
    multiplied by 100 before being stored in the input file.
  <DT><CODE>-doserate=</CODE><VAR>d</VAR><DD>Sets the expected dose rate to be
    <VAR>d</VAR> electrons per second.  <VAR>d</VAR> must be positive.  If you
    do not use this option, k2corr will assume a dose rate of ten electrons per
    second.  The <A HREF="#DoseRate">dose rate topic</A> describes how the
    dose rate is used during bad pixel detection.
  <DT><CODE>-exptime=</CODE><VAR>t</VAR><DD>Causes k2corr to <VAR>t</VAR>
    seconds as the exposure time for all images.
  <DT><CODE>-inbad=</CODE><VAR>iname</VAR><DD>If <VAR>iname</VAR> is not empty
    and is not equal to "none", causes k2corr to read a list or coordinates
    from the file named <VAR>iname</VAR>.  If <VAR>iname</VAR> is "-", k2corr
    will read the bad pixel coordinates from standard input.  The
    <A HREF="#BadPixelInput">bad pixel input topic</A> describes the expected
    file format.  You may repeat this option to have k2corr read from multiple
    files.
  <DT><CODE>-ingain=</CODE><VAR>source</VAR><DD>If <VAR>source</VAR> is an
    empty string or "none", k2corr will not try to correct the input image
    series for calibrated gain differences.  If <VAR>source</VAR> is "header",
    k2corr will attempt to read the gain calibration image from the end of the
    input image series' extended header and use that to correct the image
    series for gain variations.  For all other values of
    <VAR>source</VAR>, k2corr will attempt to read the gain correction image
    from the file named <VAR>source</VAR> (k2corr assumes that the file is in
    MRC format) and use that to correct the image series for gain variations.
  <DT><CODE>-invertgain</CODE><DD>If k2corr corrects the image series for gain
    variations (see <CODE>-ingain</CODE>), this option causes k2corr to
    divide by the gain correction image rather than multiply by that image.
    Multiplying by the gain correction image is the default.
  <DT><CODE>-mode=ushort</CODE> or <CODE>-mode=float</CODE><DD>The first form,
    <CODE>-mode=ushort</CODE>, causes k2corr to write the corrected image
    series using one unsigned 16-bit integer per pixel.  The second form
    causes k2corr to write the corrected image using one 32-bit floating-point
    value per pixel.  If you do not set the output format, k2corr will use
    16-bit unsigned integers.
  <DT><CODE>-multires</CODE><DD>Causes k2corr to add lower resolutions to
   the corrected images if the images are sufficiently large.
  <DT><CODE>-no-badcorrect</CODE><DD>This disables bad pixel correction.
  <DT><CODE>-no-baddetect</CODE><DD>This disables bad pixel detection.
  <DT><CODE>-no-invertgain</CODE><DD>If k2corr corrects the image series for
    gain variations (see <CODE>-ingain</CODE>), this option causes k2corr to
    divide by the gain correction image rather than multiply by that image.
    Multiplying by the gain correction image is the default.
  <DT><CODE>-outbad=</CODE><VAR>oname</VAR><DD>If <VAR>oname</VAR> is not empty
    and is not equal to "none", causes k2corr to write the coordinates of the
    bad pixels to the file named <VAR>oname</VAR>.  The
    <A HREF="#BadPixelOutput">bad pixel output topic</A> describes the format
    of the file.
  <DT><CODE>-outgain=</CODE><VAR>oname</VAR><DD>If <VAR>oname</VAR> is not
    empty and is not equal to "none" and you have chosen to correct the input
    image series for calibrated gain variations (see <CODE>-ingain</CODE>),
    this option causes k2corr to write the calibrated gain correction image as
    an MRC file named <VAR>oname</VAR>.  If you have chosen to invert the
    gain correction image (see <CODE>-invertgain</CODE>, the image written
    will be one divided by the gain correction image that k2corr read.
  <DT><CODE>-rsize1=</CODE><VAR>n</VAR><DD>Sets the block dimension used for
    the second stage of bad pixel detection to be <VAR>n</VAR> pixels.  n
    must be a positive integer.  If you do not use this option, k2corr will
    use 100 pixels as the block size.  The <A HREF="#k2corr">overview</A> and
    <A HREF="#Threshold1">threshold 1 topic</A> describe the second stage of
    bad pixel detection in more detail.
  <DT><CODE>-rsize2=</CODE><VAR>n</VAR><DD>Sets the region size used for the
    third stage of bad pixel detection to be <VAR>n</VAR> pixels.  n must
    be an odd integer greater than one.  If you do not use this option,
    k2corr will use a region size of 5 pixels, and that is the minimum
    recommended size.  The <A HREF="#k2corr">overview</A> and
    <A HREF="#Threshold2">threshold 2 topic</A> describe the third stage of
    bad pixel detection in more detail.
 <DT><CODE>-samprate=</CODE><VAR>s</VAR><DD>Sets the number of times per second
    that the camera internally reads out each pixel.  <VAR>s</VAR> must be
    positive.  If you do not use this option, k2corr assumes that the camera
    reads each pixel 400 times per second.
 <DT><CODE>-scale=</CODE><VAR>s</VAR><DD>If you have selected unsigned 16-bit
   integer output (see <CODE>-mode</CODE>), this option sets the scale factor
   to apply to the corrected image data before rounding it to integers and
   writing it to the output file.  By default, k2corr will use a scale factor
   one.
 <DT><CODE>-thresh0=</CODE><VAR>t0</VAR><DD>Sets the threshold for the first
    stage of bad pixel detection to be <VAR>t0</VAR>.  <VAR>t0</VAR> must be
    greater than zero and less than or equal to one.  If you do not use this
    option, k2corr will use a value of 7e-10 for the threshold.  The
    <A HREF="#k2corr">overview</A> and
    <A HREF="#Threshold0">threshold 0 topic</A> describe the first stage of
    bad pixel detection in more detail.
  <DT><CODE>-thresh1=</CODE><VAR>t1</VAR><DD>Sets the threshold for the second
    stage of bad pixel detection to be <VAR>t1</VAR>.  <VAR>t1</VAR> must be
    greater than zero and less than or equal to one.  If you do not use this
    option, k2corr will use a value of 2e-9 for the threshold.  The
    <A HREF="#k2corr">overview</A> and
    <A HREF="#Threshold1">threshold 1 topic</A> describe the second stage of
    bad pixel detection in more detail.
  <DT><CODE>-thresh2=</CODE><VAR>t2</VAR><DD>Sets the threshold for the third
    stage of bad pixel detection to be <VAR>t2</VAR>.  <VAR>t2</VAR> must be
    greater than zero.  If you do not use this option, k2corr will use a value
    of 100 for the threshold.  The <A HREF="#k2corr">overview</A> and
    <A HREF="#Threshold2">threshold 2 topic</A> describe the third stage of
    bad pixel detection in more detail.
  <DT><CODE>-vmin=</CODE><VAR>v</VAR><DD>Sets the minimum variance to accept
    in the third stage of bad pixel detection. <VAR>v</VAR> must be a value
    greater than zero.  If you do not use this option, k2corr will use 4.0
    as the minimum variance.  The <A HREF="#k2corr">overview</A> and
    <A HREF="#Threshold2">threshold 2 topic</A> describe the third stage of
    bad pixel detection in more detail.
</DL>

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

</BODY>
</HTML>
