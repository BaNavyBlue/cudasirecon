<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
<HEAD>
  <META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <TITLE>Priism Help: PFOCUSRAMP</TITLE>
  <META NAME="Description" CONTENT="On-line help for the application which inverse filters, phase flips, or filters a single-axis tomographic series to account for the CTF of the electron microscope.">
  <META NAME="Keywords" CONTENT="Priism,EM,tomography,CTF">
  <LINK REV=MADE HREF="mailto:ive@msg.ucsf.edu">
</HEAD>
<BODY>

<H1><A NAME="PFOCUSRAMP">PFOCUSRAMP</A></H1>
<H2>Overview</H2>
<P>pfocusramp will inverse filter, phase flip, or filter a single-axis
tomographic series to account for the contrast transfer function, CTF, of the
electron microscope.  pfocusramp can perform the filtering in a piecewise
fashion, with strips parallel to the tilt axis, to approximate the change in
defocus across the image.

<P>Our recommended recipe for incorporating pfocusramp into the processing of
tomographic data is this:

<OL>
  <LI>Use <A HREF="EMTAR.html">EMTAR's</A>
    <A HREF="ALIGN2D.html">rough alignment</A> step to extract the
    tilt axis orientation and tilt angles recorded by the data collection
    system and EMTAR's <A HREF="MASSNORM.html">mass normalization</A>, and, as
    needed, <A HREF="FINDAXIS.html">tilt axis determination</A> to adjust that
    geometry.
  <LI>Use pfocusramp to inverse filter the images of the tilt series.  Specify
    as the <A HREF="#InputAlignment">input alignment</A> file, the result
    computed by the first step.
  <LI>Use the result from pfocusramp as the input to EMTAR's
    <A HREF="ALIGN2D.html">alignment</A>, if you want to update the alignment
    parameters, and to <A HREF="APPL_PRM.html">APPL_PRM</A> to generate the
    aligned and normalized tilt series to use with one of the reconstruction
    algorithms.
</OL>

<P>pfocusramp can extract the tilt angles and axis orientation information from
the extended header of data generated by UCSF Tomography so you can omit the
first step if you do not need the corrections from the mass-normalization or
tilt axis determination calculations.  It is also possible to run pfocusramp
on the result of APPL_PRM, rather than other way around.  To do so, you would
not want to apply the logarithmic image formation model (either use one of
the other models or use the linear model and apply the logarithmic model by
running APPL_PRM again after pfocusramp) in APPL_PRM, and you'll need to
adjust the <A HREF="#Rotate">rotate parameter</A> for pfocusramp so it
assumes the tilt axis is vertical in the input images.

<P>The form of the CTF is set by the values for the
<A HREF="#AccelerationVoltage">acceleration voltage</A>,
<A HREF="#SphericalAberration">spherical aberration</A>,
<A HREF="#SemiconvergenceAngle">semi-convergence angle</A>,
<A HREF="#AmplitudeContrast">amplitude contrast</A>,
<A HREF="#Defocus">defocus</A>, and <A HREF="#DetectorMTF">detector MTF</A>.
<P>With the default values for the semi-convergence angle and detector MTF,
the oscillations in the CTF are not damped at high spatial frequencies and
that can lead to artifacts in the results from pfocusramp.  In some cases, you
can reduce those artifacts by increasing the
<A HREF="#FilterSize">size for the filter</A>.  A better way to avoid those
artifacts is to choose values for the semi-convergence angle and detector MTF
that approximate how the CTF of your microscope is damped at high spatial
frequencies.

<P>By default, pfocusramp applies an inverse filter (approximated by a Wiener
filter) to reverse the effects of the CTF.  You can change that by selecting a
different <A HREF="#Operation">operation to perform</A>.  To control how
finely the images are divided for piecewise filtering, adjust the
<A HREF="#StripeSize">stripe size</A> parameter.  The default value for the
stripe size, zero, causes each image to be processed as a whole, as if there
was no change in defocus across the image.

<P>The <A HREF="#CommandLine">command line topic</A> describes how to run
pfocusramp without going through EMTAR's user interface.

<H3><A NAME="Parameters">Parameters</A></H3>
<P>
   <A HREF="#TiltSeries">TiltSeries</A> |
   <A HREF="#Corrected">Corrected</A> |
   <A HREF="#InputAlignment">Input alignment</A> |
   <A HREF="#AccelerationVoltage">Acceleration voltage</A> |
   <A HREF="#SphericalAberration">Spherical aberration</A> |
   <A HREF="#SemiconvergenceAngle">Semi-convergence angle</A> |
   <A HREF="#AmplitudeContrast">Amplitude contrast</A> |
   <A HREF="#Defocus">Defocus</A> |
   <A HREF="#DetectorMTF">Detector MTF</A> |
   <A HREF="#Operation">Operation</A> |
   <A HREF="#WienerParameter">Wiener parameter</A> |
   <A HREF="#StripeSize">Stripe size</A> |
   <A HREF="#Invert">Invert</A> |
   <A HREF="#Rotate">Rotate</A> |
   <A HREF="#ReverseAxis">Reverse tilt axis</A> |
   <A HREF="#FilterSize">Filter size</A> |
   <A HREF="#AxisOrientation">Axis orientation</A> |
   <A HREF="#TiltAngle">Tilt angle</A> |
   <A HREF="#PixelSize">Pixel size</A> |
   <A HREF="#PointSource">Point source</A> |
   <A HREF="#Resolution">Resolution</A> |
   <A HREF="#Multires">Add multires</A> |
   <A HREF="#SectionRange">Section range</A> |
   <A HREF="#CommandLine">Command line</A>

<H3>Related Priism Topics</H3>
<P>
  <A HREF="../Priism.html">Priism</A> |
  <A HREF="EMTAR.html">Alignment and reconstruction</A> |
  <A HREF="ALIGN2D.html">Alignment</A> |
  <A HREF="MASSNORM.html">MASSNORM</A> |
  <A HREF="FINDAXIS.html">Tilt axis determination</A> |
  <A HREF="APPL_PRM.html">APPL_PRM</A> |
  <A HREF="emctfvis.html">CTF visualization</A>

<HR>

<H2><A NAME="TiltSeries">Tilt Series</A></H2>
<P>The input images for pfocusramp must be provided as a file in
<A HREF="../IM_ref2.html">Priism's MRC format</A>.  From the graphical user
interface, use the field labeled "TiltSeries" to specify the file name for
the input images.  When run from the command line, the first argument that does
not begin with a "-" will specify the file name for the input images.  If there
is no such argument, pfocusramp will read the file name from standard input.

<P>If the input file has an extended header in the
<A HREF="../UCSFTomographyExtendedHeader.html">format used by UCSF Tomography</A>,
pfocusramp can extract the tilt angles and tilt axis orientation from the
extended header.  You can override those values or make up for their absence,
by supplying an <A HREF="#InputAlignment">alignment parameter file</A>
or using the <A HREF="#TiltAngle">tilt angle</A> and
<A HREF="#AxisOrientation">axis orientation</A> parameters.

<P>By default, pfocusramp uses the x pixel spacing recorded in the header as
the pixel spacing for the images in Angstroms.  You can override that value
by adjusting the <A HREF="#PixelSize">pixel size</A> parameter.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Corrected">Corrected</A></H2>
<P>pfocusramp will write its result as a file in
<A HREF="../IM_ref2.html">Priism's MRC format</A>.  From the graphical user
interface, use the field labeled "Corrected" to specify the file name for the
result.  When run from the command line, the second argument that does not
begin with a "-" will specify the file name for the result.  If there is no
such argument, pfocusramp will read the file name from standard input after,
if necessary, it reads the file name for the input images.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="InputAlignment">Input Alignment</A></H2>
<P>If pfocusramp is provided with an alignment parameter file (in the same text
format as used by the Priism programs that generate alignment parameter files),
it will use that information for the tilt angles and tilt axis orientation.
Without an alignment parameter file, pfocusramp will extract the tilt angle
and tilt axis information from the extended header of the input file or will
use the values set by the <A HREF="#TiltAngle">tilt angle</A> and
<A HREF="#AxisOrientation">axis orientation</A> parameters.

<P>From the graphical user interface, use the field labeled "Input alignment"
to set the file name for the alignment parameter file.  If that field is empty
or its contents are "none", pfocusramp will assume that no alignment parameter
file is available.

<P>On the command line, include <CODE>-iprmfile=</CODE><VAR>path</VAR> in
the options, where <VAR>path</VAR> is the file name for the alignment parameter
file, to use an alignment parameter file.  If the options do not include
-iprmfile= or <VAR>path</VAR> is an empty string or "none", pfocusramp will
assume that no alignment parameter file is available.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="AccelerationVoltage">Acceleration Voltage</A></H2>
<P>The form of the CTF depends on the acceleration voltage for the
microscope.  From the graphical user interface, enter the acceleration voltage,
in kilovolts, in the field labeled "Acceleration voltage (kv)".  On the
command line, include <CODE>-kv=</CODE><VAR>acc</VAR> in the options to set
the acceleration voltage to be <VAR>acc</VAR> kilovolts.  If the options do
not include -kv=, pfocusramp will assume an acceleration voltage of 300
kilovolts.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="SphericalAberration">Spherical Aberration</A></H2>
<P>The form of the CTF depends on the amount of spherical aberration in the
system.  From the graphical user interface, enter the amount of spherical
aberration, in millimeters, in the field labeled "Spherical aberration (mm)".
On the command line, include <CODE>-cs=</CODE><VAR>sa</VAR> in the options
to set the amount of spherical aberration to be <VAR>sa</VAR> millimeters.
If the options do not include -cs=, pfocusramp will assume a spherical
aberration of 2.2 millimeters.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="SemiconvergenceAngle">Semi-convergence Angle</A></H2>
<P>The model of the CTF parameterizes the limited spatial coherence of the
microscope by one parameter, the semi-convergence angle for the electron
beam.  From the graphical user interface, enter the size of the
semi-convergence angle, in milliradians, in the field labeled
"Semi-convergence angel (mrad)".  On the command line, include
<CODE>-semiconv=</CODE><VAR>ang</VAR> in the options to set the
semi-convergence angle to be <VAR>ang</VAR>  milliradians.  If the options do
not include -semiconv=, pfocusramp will assume that the semi-convergence angle
is zero milliradians.

<P>If you use both the default values for the semi-convergence angle and
<A HREF="#DetectorMTF">detector MTF</A>, the CTF will not be damped at high
spatial frequencies and that can lead to artifacts in the output of pfocusramp.
To avoid those artifacts, we recommend that you adjust one or both of the
semi-convergence angle and detector MTF so that the modeled CTF approximates
how the CTF of your microscope is damped at high spatial frequencies.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="AmplitudeContrast">Amplitude Contrast</A></H2>
<P>The model of the CTF has a parameter, the amplitude contrast, for how much
of the CTF is due to scattering or absorption of the electron beam.  The
amplitude contrast should have a value between zero and one, inclusive.
Commonly used values of the amplitude contrast are 0.07 for cryo samples and
0.15 for negatively-stained samples.

<P>From the graphical user interface, enter the value for the amplitude
contrast in the field labeled "Amplitude contrast".  On the command line,
include <CODE>-amp=</CODE><VAR>ac</VAR> in the options to set the amplitude
contrast to be <VAR>ac</VAR>.  If the options do not include -amp=, pfocusramp
will assume that the amplitude contrast is 0.07.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Defocus">Defocus</A></H2>
<P>The amount of defocus strongly affects the form of the CTF so the defocus
is a key input parameter that you'll need to set.  pfocusramp expects the
value of the defocus to be provided in units of microns and uses the convention
that a negative value corresponds to an underfocus and a positive value to
an overfocus.

<P>For computing how the defocus varies across an image with a nonzero tilt
angle, pfocusramp assumes that the defocus parameter you supply correspond to
the defocus near the center of the image (zero-based pixel coordinates,
(floor(nx/2) - 1, floor(ny/2) - 1), to be precise).  At the pixel, (ix, iy), in
zero-based indices, pfocusramp will add to the defocus amount

<PRE>
p * sin(t) * dot_product((ix - floor(nx/2) - 1, iy - floor(ny/2) - 1), (cos(a), sin(a)))
</PRE>
<P>where a is the <A HREF="#AxisOrientation">tilt axis orientation angle</A>,
t is the <A HREF="#TiltAngle">tilt angle</A>, and p is the
<A HREF="#PixelSize">pixel spacing</A>.  In other words, if the tilt axis is
vertical (a = 0), the tilt angle is positive, and the center of the image is
underfocused, the points to the right of center will be less underfocused;
points to the left of center will be more underfocused.  If the microscope is
modeled as astigmatic, pfocusramp adds the same amount to both components of
the defocus.  The astigmatism axis angle remains the same across the image.

<P>To specify the defocus from the graphical user interface, enter the defocus
amount (in microns with negative values for an underfocus) in the field labeled
"Defocus (major axis, um)".  If you do not want to model astigmatism in the
microscope, make sure the adjacent toggle button labeled, "astigmatic", is off.
If you do want to model astigmatism, turn on that toggle button, and enter the
amount of defocus (in microns with negative values for an underfocus) along the
minor axis in the field labeled "Defocus (minor axis, um)" and the orientation
angle (in degrees) for the major axis in the field labeled
"Major axis angle (deg)".  The orientation angle for the astigmatism major
axis is specified relative to the unrotated image coordinates (the coordinates
in which the tilt axis is oriented as specified in the alignment parameters)
and is the amount of rotation needed to bring the formerly horizontal image
axis parallel to the astigmatism major axis.  A positive value for the
orientation angle implies a counterclockwise rotation of the image to bring
the formerly horizontal axis parallel to the astigmatism major axis.

<P>On the command line, include <CODE>-def=</CODE><VAR>d1</VAR>,
<CODE>-def=</CODE><VAR>d1</VAR><CODE>:</CODE><VAR>d2</VAR>, or
<CODE>-def=</CODE><VAR>d1</VAR><CODE>:</CODE><VAR>d2</VAR><CODE>:</CODE><VAR>ang</VAR>
in the options to set the defocus.  The first form assumes no astigmatism and
sets the defocus to be <VAR>d1</VAR> microns (negative values values indicate
an underfocus).  The second form assumes astigmatism with the major axis
horizontal (in the unrotated coordinate system) and a major axis defocus of
<VAR>d1</VAR> microns and a minor axis defocus of <VAR>d2</VAR> microns.  The
third form assumes astigmatism with a major axis oriented <VAR>ang</VAR>
degrees from horizontal (in the unrotated coordinate system; a positive angle
implies a counterclockwise rotation to bring the former horizontal parallel to
the major axis), a major axis defocus of <VAR>d1</VAR> microns and a minor
axis defocus of <VAR>d2</VAR> microns.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="DetectorMTF">Detector MTF</A></H2>
<P>The effect of the detector (for instance a CCD camera with a scintillator)
on the transfer function is approximated with

<PRE>
    a1 * exp(-b1 * q^2) + a2 * exp(-b2 * q^2)
</PRE>

<P>that multiplies the other components of the transfer function.  q is
the magnitude, in cycles/sample, of the spatial frequency.  a1, b1, a2,
and b2 are parameters that you supply.  From the graphical user interface,
use the field labeled "Detector MTF" to set the values for the parameters;
the four values in that field are a1, b1, a2, and b2, respectively.
On the command line, include <CODE>-mtf=</CODE><VAR>a1</VAR><CODE>:</CODE><VAR>b1</VAR><CODE>:</CODE><VAR>a2</VAR><CODE>:</CODE><VAR>b2</VAR>
in the options to set the detector transfer function.  If the options do not
include -mtf=, pfocusramp will use values corresponding to an ideal detector
(a1 = 1, b1 = 0, a2 = 1, b2 = 0).

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Operation">Operation</A></H2>
<P>pfocusramp will perform one of the following operations on the input
images to generate the result:
<DL>
  <DT>Inverse filter by the CTF<DD>Apply a Wiener filter to reverse the
    effects of the CTF.  From the graphical interface, you can choose to
    inverse filter by the CTF by selecting "Wiener filter CTF" from the
    options next to the "Operation" button.  On the command line, include
    <CODE>-op=wiener</CODE> in the options to inverse filter by the CTF.
  <DT>Inverse filter by the CTF squared<DD>Apply a Wiener filter where the
    filter to be inverted is the CTF squared.  From the graphical interface,
    you can choose to inverse filter by the CTF squared by selecting
    "Wiener filter CTF^2" from the options next to the "Operation" button.
    On the command line, include <CODE>-op=wiener2</CODE> in the options to
    inverse filter by the CTF squared.
  <DT>Phase flip<DD>In the frequency domain, reverses the phases of the
    portions where the phases would be reversed because of the CTF.  From
    the graphical interface, you can choose to flip phases in the input by
    selecting "phase flip" from the options next to the "Operation" button.
    On the command line, include <CODE>-op=phaseflip</CODE> in the options to
    flip phases in the input.
  <DT>apply CTF<DD>Applies the CTF to the input data.  From the graphical
    interface, you can choose to apply the CTF to the input data by selecting
    "apply CTF" from the options next to the "Operation" button.  On the
    command line, include <CODE>-op=apply</CODE> in the options to apply
    the CTF to the input data.
  <DT>apply CTF squared<DD>Applies the square of the CTF to the input data.
    From the graphical interface, you can choose to apply the CTF squared to
    the input data by selecting "apply CTF^2" from the options next to the
    "Operation" button.  On the command line, include <CODE>-op=apply2</CODE>
    in the options to apply the CTF squared to the input data.
</DL>

<P>The inverse filtering options have an additional parameter, the
<A HREF="#WienerParameter">Wiener parameter</A> which affects the result.
When run from the command line and the options do not include -op=, pfocusramp
will inverse filter by the CTF.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="WienerParameter">Wiener Parameter</A></H2>
<P>pfocusramp implements the inverse filter by the CTF or CTF squared as
a simplified Wiener filter: result = IFT(FT(m)*conjugate(F)/(F*conjugate(F)) + c)
where IFT is the inverse Fourier transform, FT(m) is the Fourier transform of
the measurement, F is the CTF or CTF squared, and c is parameter to reduce the
amplification effect of the inverse filter when the magnitude of the F is
small.  Values for c should be greater than or equal to zero.  Normally, you
would use larger values of c for data that has lower signal to noise ratios.
From the graphical user, you can specify the value for c by entering it in the
field labeled "Wiener parameter".  On the command line, include
<CODE>-wf=</CODE><VAR>c</VAR> in the options to set the value of c.  If -wf=
does not appear in the command-line options, pfocusramp will use a value of
0.2 for c.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="StripeSize">Stripe Size</A></H2>
<P>pfocusramp can perform its operations for multiple strips parallel to tilt
axis to approximate how the CTF function varies across the image due to changes
in the amount of defocus.  The stripe size sets the width, in pixels, of the
stripe that is written to the output for each application of the filter (the
width of the stripe needed to compute that output stripe may be larger and
is affected by the <A HREF="#FilterSize">filter size</A> and
<A HREF="#Rotate">orientation of the stripe to the image</A>).  Values of the
stripe size that are less than or equal to zero will cause pfocusramp to apply
the filter once per image, i.e. to assume that the defocus does not vary across
the image.

<P>From the graphical user interface, you can set the stripe size by entering
the desired value, in pixels, in the field labeled "Stripe size".  On the
command line, include <CODE>-nxstripe=</CODE><VAR>n</VAR> in the options to
set the stripe width to be <VAR>n</VAR> pixels.  If -nxstripe= is not included
in the options, pfocusramp will apply the filter once per image.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Invert">Invert</A></H2>
<P>To better interoperate with the intensity scaling performed by
<A HREF="APPL_PRM.html">APPL_PRM</A> or the positivity constraint used by
<A HREF="TAPIR.html">TAPIR</A>, pfocusramp reverses the sign on the standard
definition of the CTF, the Fourier transform of the difference between the
observed image with a point sample and the observed image with no sample.  With
that sign reversal, the mean of an output image will have the same sign as
the mean of the input image from which it derived.  If you do not want
pfocusramp to reverse the sign on the CTF, turn on the toggle button labeled
"Invert" if you are using the graphical user interface or include
<CODE>-invert</CODE> in the command-line options if you are running pfocusramp
directly.  The sign chosen for the CTF does not matter in the cases where you
inverse filter by the CTF squared or filter by the CTF squared.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Rotate">Rotate</A></H2>
<P>pfocusramp can either assume that the tilt axis orientation in the input
images is as given in the alignment parameters (either from the
<A HREF="#InputAlignment">parameter file</A>, the
<A HREF="#AxisOrientation">orientation you specified</A>, or the extended
header) or is along the vertical axis.  When run from the graphical user
interface, pfocusramp uses the axis orientation as is when the toggle button,
labeled "Rotate", is on and assumes the axis orientation is vertical when
that toggle button is off.  When run from the command line, include
<CODE>-rotate</CODE> in the options to have PFOCSURAMP use the axis orientation
as is.  If <CODE>-rotate</CODE> does not appear in the options, pfocusramp
will assume that the tilt axis is vertical.

<P>If you <A HREF="#Defocus">include astigmatism in the CTF</A> and have
pfocusramp assume that the tilt axis is vertical, pfocusramp will modify the
astigmatism axis angle you supply because pfocusramp assumes the CTF parameters
were measured in the coordinate system where the tilt axis orientation is as
specified in the alignment parameters.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="ReverseAxis">Reverse Tilt Axis</A></H2>
<P>The sign of the slope of the focus ramp across the image depends on
the values of the <A HREF="#TiltAngle">tilt angle</A> and
<A HREF="#AxisOrientation">tilt axis orientation</A> for the image.  The
<A HREF="#Defocus">defocus topic</A> provides the formula.  To make it easier
to match your experimental conditions to that formula, pfocusramp provides an
option to add 180 degrees to the tilt axis orientation for each image.  That
has the effect of flipping the sign on the slope of the focus ramp.  If you
intend to reconstruct the data with one of Priism's reconstruction algorithms,
you likely should reverse the axis direction while generating the alignment
parameters (the <A HREF="MASSNORM.html">mass-normalization</A> and
<A HREF="ALIGN2D.html">alignment</A> applications provide options to do that)
and use those parameters as they are with pfocusamp and
<A HREF="APPL_PRM.html">the generation of an aligned tilt series</A> for
reconstruction.  By doing so, you handle the tilt axis orientation in a
consistent way for both CTF correction and the reconstruction.

<P>From the graphical interface, you can turn on the option to add 180 degrees
to the tilt axis orientation by turning on the toggle button labeled
"Reverse tilt axis".  To enable that option from the command line, include
<CODE>-revaxis</CODE> in the options.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="FilterSize">Filter Size</A></H2>
<P>The filter size sets the minimum width, in pixels measured perpendicular
to the tilt axis orientation, for the arrays used to compute the contrast
transfer function and result.  Note that the width of those arrays will be no
smaller than the <A HREF="#StripeSize">stripe size</A>.  Depending on the
CTF parameters and pixel size, the filter size may not be sufficient to
accurately represent the CTF resulting in artifacts in the result.  In other
cases, the filter size is more than enough to represent the CTF accurately,
and you can speed up the processing by decreasing the value.  In terms of
speed, filter sizes that are only divisible by small primes (say 2, 3, and 5)
are likely to be better than a filter size that is slightly smaller but has
one or more larger prime factors.

<P>From the graphical user interface, you can set the filter size by entering
the desired value, in pixels, in the field labeled "Filter size".  That field
is in the special parameters dialog.  On the command line, include
<CODE>-nxext=</CODE><VAR>n</VAR> in the options to set the filter size to be
<VAR>n</VAR> pixels.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="AxisOrientation">Axis Orientation</A></H2>
<P>If you do not provide an <A HREF="#InputAlignment">alignment parameter</A>
file, pfocusramp will read the tilt axis orientation from the extended header
of the input.  You can override those values and use one orientation for all
the input images.  To do so from the graphical user interface, turn off the
toggle button labeled "default" on the line in the special parameters dialog
that starts with the button labeled "Axis orientation (deg)".  Then enter the
desired axis orientation, in degrees in the text field on that line.  On the
command line, you can override the orientations from the extended header by
including <CODE>-axis=</CODE><VAR>t</VAR> in the options were <VAR>t</VAR> is
the axis orientation, in degrees, to use.

<P>The <A HREF="#Defocus">defocus topic</A> describes the sign convention for
the axis orientation and how it affects how the defocus varies across the
image.  If you enable the option to <A HREF="#ReverseAxis">reverse the tilt axis</A>,
pfocusramp will add 180 degrees to the tilt axis orientation regardless of
whether that orientation comes from the alignment parameter file, extended
header, or the value you set for the axis orientation.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="TiltAngle">Tilt Angle</A></H2>
<P>If you do not provide an <A HREF="#InputAlignment">alignment parameter</A>
file, pfocusramp will read the tilt angles from the extended header of the
input.  You can override those values and use one tilt angle for all the
input images.  To do so from the graphical user interface, turn off the toggle
button labeled "default" on the line in the special parameters dialog that
starts with the button labeled "Tilt angle (deg)".  Then enter the desired
tilt angle, in degrees, in the text field on that line.  On the command line,
you can override the tilt angles from the extended header by including
<CODE>-tilt=</CODE><VAR>t</VAR> in the options were <VAR>t</VAR> is the tilt
angle, in degrees, to use.

<P>The <A HREF="#Defocus">defocus topic</A> describes the sign convention for
the tilt angle and how it affects how the defocus varies across the image.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="PixelSize">Pixel Size</A></H2>
<P>pfocusramp normally reads the pixel size in Angstroms for the image data
from the input file's header.  From the graphical interface, you can override
that value by turning off the toggle button labeled "default" on the line in
the special parameters dialog that starts with the button labeled
"Pixel size (angstroms)".  Then enter the desired pixel size, in Angstroms,
in the text field on that line.  On the command line, you can override the
header's value for the pixel spacing by including
<CODE>-pix=</CODE><VAR>p</VAR> in the options where <VAR>p</VAR> is the pixel
size in Angstroms.  The pixel size you specify is for the highest resolution
images in the input file.  If you
<A HREF="#Resolution">select a lower resolution</A>, the pixel size you gave
will be multiplied by the downsampling factor for the selected resolution.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="PointSource">Point Source</A></H2>
<P>As a convenient diagnostic or method for visualizing the point response
of the pfocusramp's filtering, pfocusramp can generate the effect of its
filtering on a point source.  pfocusramp still requires an input file for that,
but it only uses the file's dimensions, pixel spacing and tilt geometry.  The
image values are not used; instead, all pixels are treated as if they were
zero except for the one at (floor((nx-1)/2), floor((ny-1)/2)) (in zero-based
indices) which is treated as if it had a value of 1000.

<P>From the graphical user interface, you can replace the input with a point
source by turning on the toggle button labeled "Point source".  That toggle
button is in the special parameters dialog.  On the command line, include
<CODE>-point</CODE> on the option to replace the input with a point source.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Resolution">Resolution</A></H2>
<P>The resolution parameter selects which resolution to process from the
input tilt series.  0 is the highest (full) resolution.  From the graphical
user interface, you would normally select the resolution from the main
<A HREF="EMTAR.html">EMTAR</A> dialog and allow the software to propagate
the setting to the individual processing stages.  You can also set the
resolution to process specifically for pfocusramp in its special parameters
dialog:  enter the desired resolution index in the field labeled "Resolution".
On the command line, include <CODE>-ires=</CODE><VAR>j</VAR> in the options to
set <VAR>j</VAR> as the resolution index to process.  If the options do not
include -ires=, pfocusramp will process the highest resolution in the input
file.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Multires">Add Multires</A></H2>
<P>pfocusramp will add lower resolution versions of the result to the output
file if you want and the dimensions are sufficiently large.  From the graphical
user interface, turn on the toggle button labeled "Add multires" (in the
special parameters dialog) to have pfocusramp had lower resolutions to the
output if the x and y dimensions are sufficiently large.  When that toggle
button is off, the result will not have lower resolutions appended.  On the
command line, include <CODE>-multires</CODE> in the options to add lower
resolutions to the result when the dimensions are large enough.  If
<CODE>-multires</CODE> does not appear in the options, the result will not
contain multiple resolutions.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="SectionRange">Section Range</A></H2>
<P>pfocusramp can limit its processing to a subset (specified by a starting
index, final index, and an increment) of the images in the input file.  From
the graphical interface, you can define the subset to process in the special
parameters dialog.  In the field labeled, "Section range", the first value is
starting index (numbered from zero), the second value is the final index
(also numbered from zero), and the third value is the index increment.  On the
command line, include <CODE>-iv=</CODE><VAR>istart</VAR><CODE>:</CODE><VAR>iend</VAR><CODE>:</CODE><VAR>istep</VAR>
in the options to process the subset starting with the zero-based index,
<VAR>istart</VAR>, ending with the zero-based index, <VAR>iend</VAR>, and with
an increment of <VAR>istep</VAR> between the images included.  If -iv= does
not appear in the options, pfocusramp will process all the images from the
input file.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="CommandLine">Command Line</A></H2>
<P>You can invoke pfocusramp from the command line.  The application does
require libraries from Priism so you should set the Priism environment prior
to running pfocusramp.  If there are no arguments that start with -names=,
then the first two arguments that do not start with "-" will be be taken as the
file names for the inputs tilt series and the result tilt series, respectively.
Any additional arguments that do not start with "-" are ignored.  If there is
only one argument which does not start with "-", pfocusramp uses it as the
file name for the input tilt series and reads the name of the result tilt
series from standard input.  If there are no arguments which start with "-",
pfocusramp reads the names of the input tilt series and result series, in that
order, from standard input.  If there is at least one argument that starts
with -names, any arguments that do not start with "-" are ignored.

<P>The options that pfocusramp accepts are listed below; all other options are
ignored.  If an option appears multiple times, the first one takes precedence.

<DL>
  <DT><CODE>-amp=</CODE><VAR>m</VAR><DD>Sets the
    <A HREF="#AmplitudeContrast">amplitude contrast</A> to be <VAR>m</VAR>, a
    floating point value that should be between zero and one inclusive.  When
    not set, pfocusramp sets the amplitude contrast to be 0.07.
  <DT><CODE>-axis=</CODE><VAR>ang</VAR><DD>Causes pfocusramp to use
    <VAR>ang</VAR> as the tilt axis orientation angle, in degrees, for any
    image whose tilt axis orientation can not be extracted from the
    <A HREF="#InputAlignment">alignment parameter file</A>.  <VAR>ang</VAR>
    must be a floating-point value.  When not set, the tilt axis orientation
    from the extended header or a value of zero, if the tilt axis orientation
    is not available in the extended header, will be used for the images
    without tilt axis orientation information in the alignment parameter file.
    If you use -revaxis, pfocusramp will add 180 degrees to the value you
    set with -axis.
  <DT><CODE>-bin=</CODE><VAR>m</VAR><DD>Causes pfocusramp to bin the input
    image by a factor of <VAR>m</VAR> in x and y before proceeding.
    <VAR>nbin</VAR> must be an integer and should be positive.  When not set,
    pfocusramp does not bin the input images.
  <DT><CODE>-cs=</CODE><VAR>c</VAR><DD>Sets the
    <A HREF="#SphericalAberration">spherical aberration</A> to be <VAR>c</VAR>
    millimeters.  <VAR>c</VAR> must be a floating-point value.  When not set,
    pfocusramp sets the spherical aberration to be 2.2 millimeters.
  <DT><CODE>-def=</CODE><VAR>d1</VAR><CODE>:</CODE><VAR>d2</VAR><CODE>:</CODE><VAR>aa</VAR>
    <DD>Sets the <A HREF="#Defocus">defocus</A>.  <VAR>d1</VAR> is the defocus
    along the major axis in units of microns with negative values indicating
    an underfocus.  <VAR>d2</VAR> is the defocus perpendicular to the major
    axis in units of microns with negative values indicating an underfocus.
    <VAR>aa</VAR> is the angle, in degrees, between horizontal (in the
    unrotated coordinates) and the major axis.  A positive value for
    <VAR>aa</VAR> means that a counterclockwise rotation of the image is
    necessary to make the former horizontal axis parallel to the major axis.
    <VAR>d1</VAR>, <VAR>d2</VAR>, and <VAR>aa</VAR> must be floating-point
    values.  You may omit <VAR>aa</VAR>:  pfocusramp will assume that the
    major axis is horizontal.  You may omit <VAR>d2</VAR> and <VAR>aa</VAR>:
    pfocusramp will assume that there is no astigmatism, i.e. that
    <VAR>d2</VAR> is equal to <VAR>d1</VAR>.  When not set, pfocusramp will
    attempt to read the defocus information from the extended header.
    With the header entries indexed from zero, the major axis defous in microns
    will be .001 * (header entry 13 - 0.5 * header entry 14), the minor axis
    defocus in microns will be .001 * (header entry 13 + 0.5 * header entry
    14), and the major axis angle in degrees will be header entry 15 * 180 /
    pi.  Note that UCSF Tomography sets those header entries to zero.  If
    the defocus information is not available from the extended header,
    pfocusramp will assume that the system is not astigmatic and the defocus
    is zero microns.
  <DT><CODE>-dirin=</CODE><VAR>dir</VAR><DD>Causes pfocusramp to prepend
    <VAR>dir</VAR> to all file names read from the file specified with -names.
    When not set, pfocusramp does not prepend anything to those file names.
    This option has no effect when you do not use -names.
  <DT><CODE>-dirout=</CODE><VAR>dir</VAR><DD>Causes pfocusramp to prepend
    <VAR>dir</VAR> to all output file names when input files are read from the
    file set with -names.  When not set and you use -names, pfocusramp writes
    the output files in the same directory as the input files.  This option
    has no effect when you do not use -names.
  <DT><CODE>-invert</CODE><DD>Causes pfocusramp to use the standard definition
    of the CTF, the Fourier transform of the difference between the image
    with a point sample and an image without a sample.  When not set,
    pfocusramp uses the negative of that definition so that the mean of the
    result has the same sign as the mean of the input.
  <DT><CODE>-iprmfile=</CODE><VAR>nm</VAR><DD>Causes pfocusramp to use the
    <A HREF="#InputAlignment">alignment parameter file</A> named,
    <VAR>nm</VAR>, as the first source for tilt angles and tilt axis
    orientations.  If <VAR>nm</VAR> is empty or equal to "none", pfocusramp
    will assume that there is no alignment parameter file.  For images without
    alignment information in the parameter file or when no alignment parameter
    file has been specified, pfocusramp will use (in order of precedence): the
    tilt angle specified by -tilt= and the tilt axis orientation specified by
    -axis=, the values from the extended header of the input file, or the
    default values of zero degrees for both angles.
  <DT><CODE>-iv=</CODE><VAR>ivs</VAR><CODE>:</CODE><VAR>ive</VAR><CODE>:</CODE><VAR>ivi</VAR>
    <DD>Causes pfocusramp to process only the images with indices between
      <VAR>ivs</VAR> and <VAR>ive</VAR> with an increment of <VAR>ivi</VAR>.
      <VAR>ivs</VAR>, <VAR>ive</VAR>, and <VAR>ivi</VAR> must be integers.
      The indices are numbered from zero.  When not set, pfocusramp processes
      all images from the input file.
  <DT><CODE>-kv=</CODE><VAR>v</VAR><DD>Sets the
    <A HREF="#AccelerationVoltage">acceleration voltage</A> to be <VAR>v</VAR>
    kilovolts.  <VAR>v</VAR> must be a floating-point value and should be
    positive.  If <VAR>v</VAR> is larger than 10000, pfocusramp assumes the
    value was mistakenly supplied in units of volts and divides the value by
    1000 before using it.  When not set, pfocusramp sets the acceleration
    voltage to be 300 kilovolts.
  <DT><CODE>-mtf</CODE><DD>This is a shortcut for
    <CODE>-mtf=.44647:55.166:.42259:9.7247</CODE> where the values are a fit
    to the measured MTF of the Ultracam (operating unbinned) attached to
    UCSF's Polara operating at an acceleration voltage of 300 kilovolts.
  <DT><CODE>-mtf=</CODE><VAR>a1</VAR><CODE>:</CODE><VAR>b1</VAR><CODE>:</CODE><VAR>a2</VAR><CODE>:</CODE><VAR>b2</VAR>
    <DD>Sets the <A HREF="#DetectorMTF">detector MTF</A>.  <VAR>a1</VAR>,
    <VAR>b1</VAR>, <VAR>a2</VAR>, and <VAR>b2</VAR> must be floating-point
    values.  When not set, pfocusramp uses an ideal detector, equivalent to
    a1 = 1, b1 = 0, a2 = 1, and b2 = 0.
  <DT><CODE>-multires</CODE><DD>Causes pfocusramp to add lower resolutions
    to the result if the images are sufficiently large.  If not set, the
    result will be generated without extra resolutions.
  <DT><CODE>-names=</CODE><VAR>nm</VAR><DD>Causes pfocusramp to read the
    input file names and defocus parameters from the file named, <VAR>nm</VAR>.
    Input file names will be prepended with whatever has been set with -dirin.
    Output files will appear in the same directory as the input files unless
    -dirout has been set.  The file name portion of the output file name will
    be the same as the input file but with an appended part to indicate the
    type of processing done: _dff (phase-flipped), _dfc (inverse CTF),
    _dfm (inverse CTF and detector MTF), _dc2 (inverse CTF squared),
    _dm2 (inverse CTF and detector MTF squared), _ctf (CTF and detector MTF,
    if set, applied), _ctf2 (CTF and detector MTF, if set, applied).
    <VAR>nm</VAR> should be in the ACE format with one line per input file,
    and nine items per line: image filename, nominal defocus, rough defocus
    estimate, refined defocus 1 (major axis), refined defocus 2 (minor axis),
    estimated amplitude contrast ratio, astigmatism ratio, astigmatism angle,
    confidence level for result.  pfocusramp only makes use of the first,
    fourth, fifth, and eighth entries.  The fourth and fifth values are assumed
    to have units of microns and negative values correspond to an underfocus.
    The eighth value is assumed to have units of degrees and the opposite sign
    convention from that for pfocusramp's
    <A HREF="#Defocus">major axis orientation</A>.
  <DT><CODE>-nxext=</CODE><VAR>n</VAR><DD>Causes pfocusramp to use a
    <A HREF="#FilterSize">filter size</A> of <VAR>n</VAR> pixels.
    <VAR>n</VAR> must be an integer.  When not set, pfocusramp uses a filter
    size of 512 pixels.
  <DT><CODE>-nxstripe=</CODE><VAR>n</VAR><DD>Causes pfocusramp to use a
    <A HREF="#StripeSize">stripe size</A> of <VAR>n</VAR> pixels.  <VAR>n</VAR>
    must be an integer.  When not set, pfocusramp processes an entire input
    image at once and does not allow the defocus to vary across the image.
  <DT><CODE>-op=</CODE><VAR>p</VAR><DD>Specifies the
    <A HREF="#Operation">type of filtering</A> that pfocusramp should perform.
    <VAR>p</VAR> must be wiener, wiener2, phaseflip, apply, or apply2.  If
    not set, pfocusramp applies a Wiener filter for CTF, i.e. equivalent to
    <CODE>-op=wiener</CODE>.
  <DT><CODE>-pix=</CODE><VAR>p</VAR><DD>Causes pfocusramp to assume that the
    pixel spacing is <VAR>p</VAR> Angstroms.  <VAR>p</VAR> must be a
    floating-point value and should be positive.  When not set, pfocusramp uses
    the x pixel spacing from the input file's header.
  <DT><CODE>-point</CODE><DD>Causes pfocusramp to ignore the image values in
    the input data and use an image of the same size but with all zeros except
    for a centrally located pixel with a value of one thousand.
  <DT><CODE>-res=</CODE><VAR>ir</VAR><DD>Causes pfocusramp to process the
    resolution index, <VAR>ir</VAR>, where zero is the highest resolution.
    <VAR>ir</VAR> must be an integer.  When not set, pfocusramp processes the
    highest resolution.
  <DT><CODE>-revaxis</CODE><DD>Causes pfocusramp to add 180 degrees to each
    image's <A HREF="#AxisOrientation">tilt axis orientation</A>.
  <DT><CODE>-rotate</CODE><DD>Causes pfocusramp to assume that the tilt axis
    orientation is as specified by the
    <A HREF="#InputAlignment">alignment parameter file</A>, -axis=, or the
    extended header information.  Otherwise, pfocusramp assumes that the tilt
    axis is vertical in the input images.
  <DT><CODE>-semiconv=</CODE><VAR>s</VAR><DD>Sets the
    <A HREF="#SemiconvergenceAngle">semi-convergence angle</A> of the electron
    beam to be <VAR>s</VAR> milliradians.  <VAR>s</VAR> must be a
    floating-point value and should be non-negative.  When not set, pfocusramp
    sets the semi-convergence angle to be zero milliradians.
  <DT><CODE>-tilt=</CODE><VAR>ang</VAR><DD>Causes pfocusramp to use
    <VAR>ang</VAR> as the tilt angle, in degrees, for any image whose tilt
    angle can not be extracted from the
    <A HREF="#InputAlignment">alignment parameter file</A>.  <VAR>ang</VAR>
    must be a floating-point value.  When not set, the tilt angle from the
    extended header or a value of zero, if the tilt angle is not available in
    the extended header, will be used for the images without tilt angle
    information in the alignment parameter file.
  <DT><CODE>-wf=</CODE><VAR>p</VAR><DD>Sets the
    <A HREF="#WienerParameter">Wiener filter parameter</A> to be <VAR>p</VAR>.
    <VAR>p</VAR> must be a floating-point value and should be greater than or
    equal to zero.  If not set, pfocusramp sets the Wiener filter parameter to
    be 0.2.
  <DT><CODE>-xfix=</CODE><VAR>ixs</VAR><CODE>:</CODE><VAR>ixe</VAR><CODE>:</CODE><VAR>iy</VAR>...
    <DD>Causes pfocusramp to interpolate out horizontal lines in the input.
      You may specify up to 10 such lines with three values for each line:
      the first x index (<VAR>ixs</VAR>) to interpolate, the last x index to
      interpolate (<VAR>ixe</VAR>), and the y index (<VAR>iy</VAR>) of the
      line.  All indices start from zero and must be integers.  When
      not set, pfocusramp does not interpolate out horizontal lines in the
      input.
  <DT><CODE>-yfix=</CODE><VAR>iys</VAR><CODE>:</CODE><VAR>iye</VAR><CODE>:</CODE><VAR>ix</VAR>...
    <DD>Causes pfocusramp to interpolate out vertical lines in the input.
      You may specify up to 10 such lines with three values for each line:
      the first y index (<VAR>iys</VAR>) to interpolate, the last y index to
      interpolate (<VAR>iye</VAR>), and the x index (<VAR>ix</VAR>) of the
      line.  All indices start from zero and must be integers.  When
      not set, pfocusramp does not interpolate out vertical lines in the
      input.
</DL>

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

</BODY>
</HTML>
