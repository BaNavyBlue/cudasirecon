<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
    "http://www.w3.org/TR/html4/loose.dtd">
<HTML>
<HEAD>
  <TITLE>Priism Help: ALIGN2D</TITLE>
  <META NAME="Description" CONTENT="On-line help for the application which aligns a tilt series without the need for explicit fiduciary markers.">
  <META NAME="Keywords" CONTENT="Priism,EM,tomography,alignment">
  <LINK REV=MADE HREF="mailto:ive@msg.ucsf.edu">
</HEAD>
<BODY>

<H1><A NAME="ALIGN2D">ALIGN2D</A></H1>
<H2>Overview</H2>
<P>ALIGN2D aligns a tilt series without the need for explicit fiduciary
markers (i.e. gold beads).  Depending on the setting for the
<A HREF="#Method">Method parameter</A>, ALIGN2D use one or both of the
following to determine the alignment parameters:

<OL>
  <LI>Determine the translations using an FFT-based calculation of the
    cross-correlations.
  <LI>Refine translation, rotation, magnification, and tilt axis position 
    using a simplex minimization algorithm on the cross-correlation values.
</OL>

<P>Alternatively, ALIGN2D can try to extract the alignment information from
the extended header of the tilt series.  If that information is not
available, it will then use the methods listed above to calculate the alignment
parameters.  This alternative mechanism is used for rough alignment of the
tilt series; see the <A HREF="#ExtendedHeader">"Use header" topic</A> for
more details.

<P>Below is an example command line for ALIGN2D.  It takes the tilt series
test.stk and <A HREF="MASSNORM.html">MASSNORM</A>-generated parameters in
test.bprmMn and updates the parameters in test.bprmMn with the calculated
alignment values.  It uses the combined method, FFT and simplex minimization,
(-imod=0).  The diagnostic image outputs, stretched/filtered tilt series and
cross-correlation results, are not generated (-ofile=none -cor_out=none).

<PRE>
    align_2d_p test.stk -iprmfile=test.bprmMn -oprmfile=test.bprmMn \
        -imod=0 -ofile=none -cor_out=none
</PRE>

<H3><A NAME="Parameters">Parameters</A></H3>
<P>
   <A HREF="#TiltSeries">Tilt series</A> |
   <A HREF="#NX:NY:NV">NX:NY:NV</A> |
   <A HREF="#InputAlignment">Input alignment</A> |
   <A HREF="#OutputAlignment">Output alignment</A> |
   <A HREF="#ExtendedHeader">Use header</A> |
   <A HREF="#Axis">Axis orientation</A> |
   <A HREF="#ReverseAxis">Reverse tilt axis</A> |
   <A HREF="#StretchedSeries">Stretched series</A> |
   <A HREF="#CrossCorrelationImages">Cross correlations</A> |
   <A HREF="#CrossCorrelationTable">X-cor table</A> |
   <A HREF="#SectionRange">Section range</A> |
   <A HREF="#WienerCoefficient">Wiener coefficient</A> |
   <A HREF="#CenterPeakDistance">Center peak distance</A> |
   <A HREF="#2ndPeakThreshold">2nd peak threshold</A> |
   <A HREF="#TiltOffset">Tilt offset</A> |
   <A HREF="#Method">Method</A> |
   <A HREF="#Stretch">Stretch</A> |
   <A HREF="#Filter">Filter</A> |
   <A HREF="#PhaseWeighting">Phase weighting</A> |
   <A HREF="#SimplexDeviations">Simplex deviations</A> |
   <A HREF="#Resolution">Resolution</A> |
   <A HREF="#FullSize">Full size</A> |
   <A HREF="#ResolutionScale">Resolution scale</A>

<H3>Related Priism Topics</H3>
<P>
  <A HREF="../Priism.html">Priism</A> |
  <A HREF="EMTAR.html">Alignment and reconstruction</A> |
  <A HREF="MASSNORM.html">Mass normalization</A> |
  <A HREF="BALIGN.html">Alignment with markers</A>
<HR>

<H2><A NAME="TiltSeries">Tilt Series</A></H2>
<P>In the graphical user interface, the "Tilt series" field holds the name
of the file containing the unaligned tilt series data.  On the command line,
pass the name of the unaligned tilt series file as the first argument.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="NX:NY:NV">NX:NY:NV</A></H2>
<P>In the graphical user interface, the "NX:NY:NV" field displays the
dimensions of <A HREF="#TiltSeries">unaligned tilt series</A>.  The first
value in the field is the number of pixels in the x dimension, the second
value in the field is the number of pixels in the y dimension, and the third
value is the number of projections.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="InputAlignment">Input Alignment</A></H2>
<P>In the graphical user interface, the "Input alignment" field holds the name
of the input alignment parameter file.  Normally you would use none or the name
of a parameter file generated by <A HREF="MASSNORM.html">MASSNORM</A>.  On the
command line, specify the name of the input parameter file with the option
<PRE>
    <CODE>-iprmfile=</CODE><VAR>file_name</VAR>
</PRE>
<P>If you do not specify an input parameter file, ALIGN2D assumes that no
input parameter file is available.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="OutputAlignment">Output Alignment</A></H2>
<P>In the graphical user interface, the "Output alignment" field is the name
of the output alignment parameter file that ALIGN2D will generate.  On the
command-line, specify the name of the output parameter file with the option
<PRE>
    <CODE>-oprmfile=</CODE><VAR>file_name</VAR>
</PRE>
<P>If you do not supply the name of an output parameter file or specify the
name as none, ALIGN2D will not write out a separate file with the alignment
parameter results (those results are still written to ALIGN2D's log output).
The name of the output parameter file may be the same as that for the input
parameter file:  ALIGN2D will update the geometric alignment parameters in the
file and leave the mass normalization values intact.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="ExtendedHeader">Use Header</A></H2>
<P>When invoked with the -header command-line option, ALIGN2D will first
try to extract the alignment information from the extended header of
the <A HREF="#TiltSeries">tilt series</A>; if that fails, it will then
calculate the alignment using the normal methods.  The "Rough Alignment"
stage in <A HREF="EMTAR.html">EMTAR</A> will invoke ALIGN2D with the
-header option when the "Use header" toggle button is on.  It also passes
ALIGN2D an <A HREF="#Method">-imod=1 option</A> to force use of the FFT-based
cross-correlation alignment.

<P>Currently, the option to extract the alignment information from the
extended header expects the header format as generated by the
<A HREF="../UCSFTomographyExtendedHeader.html">UCSF Tomography
data collection software</A> (32 floating-point entries per section with the x
shift in pixels as the sixth entry, the y shift in pixels as the seventh
entry, and the orientation of the tilt axis in degrees as the eleventh entry).
ALIGN2D assumes that sections with an x and y shift of zero served
as reference points.  If there are more than two reference points or two
reference points which are not adjacent, ALIGN2D will not attempt to use the
information in the extended header.  If there are two reference points,
ALIGN2D will use the FFT-based cross correlation method to align them
to each other.  That process is affected by the
<A HREF="#CenterPeakDistance">center peak distance</A>,
<A HREF="#2ndPeakThreshold">second peak threshold</A>,
<A HREF="#Stretch">stretching</A>,
<A HREF="#PhaseWeighting">phase weighting</A>, and
<A HREF="#WienerCoefficient">Wiener coefficient</A> parameters.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Axis">Axis</A></H2>
<P>You can use the "Axis orientation" field to specify the angle, in degrees,
that the tilt axis makes with the vertical axis of the images as displayed in
Priism.  If the angle is positive, the images have to be rotated clockwise to
make the tilt axis vertical.  If you supply an
<A HREF="#InputAlignment">input parameter file</A> or
<A HREF="#ExtendedHeader">extract the alignment from the extended header of the
tilt series</A>, turn on the "overwrite input" toggle button adjacent to the
"Axis orientation" field to force the axis orientation you entered to have
precedence over those other sources.

<P>On the command line, specify the orientation angle for the tilt axis with
the option
<PRE>
    <CODE>-axis=</CODE><VAR>angle_value</VAR>
</PRE>

<P>The command-line option to override the tilt axis orientation in the input
parameter file or the extended header of the tilt series is
<PRE>
    <CODE>-overwrite_axis</CODE>
</PRE>

<P>When the axis orientation is not set from another source, ALIGN2D assumes
the tilt axis is parallel to the vertical axis.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="StretchedSeries">Stretched Series</A></H2>
<P>When the alignment is not derived from the extended header of the tilt
series, ALIGN2D can write out the images after filtering, stretching, and
apodization.  If you want to see those images, enter the desired file name
in the "Stretched series" field of the graphical user interface (it is in the
special parameters dialog) or by using
<PRE>
    <CODE>-ofile=</CODE><VAR>file_name</VAR>
</PRE>
<P>on the command line.  If the name of the file is none or
is not specified, ALIGN2D will not write the images after filtering,
stretching, and apodization.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="CrossCorrelationImages">Cross Correlations</A></H2>
<P>If you use the FFT-based cross-correlation calculation (either alone or
in conjunction with the simplex minimization), ALIGN2D can write out the
intermediate cross-correlation images for use in debugging or diagnosing
problems.  If the file name supplied in the graphical user interface's
"Cross correlations" field or by the command-line's
<PRE>
    <CODE>-cor_out=</CODE><VAR>file_name</VAR>
</PRE>
<P>option is not none, then ALIGN2D will write the cross-correlation images to
that file.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="CrossCorrelationTable">X-cor Table</A></H2>
<P>If you enter a name other than "none" in the "X-cor Table" field, ALIGN2D
will generate a text file with that name.  The file will contain a table where
each line has a section number, the corresponding tilt angle, and one minus the
cross-correlation value between that section's image (corrected for the
determined alignment parameters) and the adjacent section's image.  To set
the file name for the table on the command line, use
<PRE>
    <CODE>-plotfile=</CODE><VAR>name</VAR>
</PRE>

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="ReverseAxis">Reverse Tilt Axis</A></H2>
<P>ALIGN2D can add 180 degrees to the input rotation parameters (which set the
tilt axis orientation) regardless of the source for those parameters (the
extended header, input alignment parameter file, or
<A HREF="#Axis">the axis parameter</A>).  The usual reason for doing so would
be to match your experimental conditions with the geometry conventions used
to
<A HREF="PFOCUSRAMP.html#Defocus">compute the defocus in CTF correction</A>
and <A HREF="ReconCoordSys.html">generate reconstructions</A>.

<P>From the graphical user interface, turn on the toggle button labeled
"Reverse tilt axis" to add 180 degrees to the rotation parameters.  That toggle
button is in the main dialog for the rough alignment and in the special
parameters dialog for the full alignment.  On the command line, include
<CODE>-revaxis</CODE> in the options to add 180 degrees to the rotation
parameters.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="SectionRange">Section Range</A></H2>
<P>Currently has no effect.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="WienerCoefficient">Wiener Coefficient</A></H2>
<P>When you use <A HREF="#PhaseWeighting">phase weighting</A> of the
cross-correlations, there is a term like that in a Wiener filter to keep things
well behaved when the amplitude of the cross-correlation value in the frequency
domain approaches zero.  The term is an estimate of the high-frequency power
spectral density times the value in the user interface's "Wiener coefficient"
field.  A higher value for the "Wiener coefficient" increases the suppression
of the low amplitude components.  To set the coefficient on the command line,
use
<PRE>
    <CODE>-mult=</CODE><VAR>value</VAR>
</PRE>

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="CenterPeakDistance">Center Peak Distance</A></H2>
<P>With the FFT-based cross correlations, the alignment application will try
to cancel out the effect of a peak at the origin by subtracting out a radial
average over the central 7 x 7 region from that region.  The alignment
application only performs that subtraction if the largest value in the central
7 x 7 region occurs at the center and the quadratic fit to that point and its
four nearest neighbors gives a peak position, (xp, yp), where both the absolute
value of xp and yp are less than a threshold value.  The threshold value is,
by default, 0.05 pixels.  You can change the threshold by modifying the value
in the user interface's "Center peak distance" field.  On the command line, use
<PRE>
    <CODE>-cpd=</CODE><VAR>value</VAR>
</PRE>
<P>to set the threshold to be <VAR>value</VAR>.

<P>You may want to use a slightly larger value of the threshold when you
observe that the alignment application does not modify the origin for a
section (in the log file, the alignment application will write "peak is in
origin" for sections where the origin is modified) and consequently picks the
peak at the origin which is higher than the peak corresponding to the better
values for the shifts.  You can use a negative value for the threshold to
prevent the alignment application from modifying the center of the
cross-correlation result; that may be useful if the cross-correlation peak
corresponding to the best alignment shifts is frequently in the central 9x9
region.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="2ndPeakThreshold">2nd Peak Threshold</A></H2>
<P>With the FFT-based cross correlations, the alignment application prefers
peaks that are away from the origin and only takes the peak at the origin
if the next highest peak (after masking out the origin) has a height less than
<VAR>f</VAR> times the height of the peak at the origin.  The default value
of <VAR>f</VAR> is .001.  In the graphical user interface, alter the value
in the "2nd peak threshold" field to alter the value of <VAR>f</VAR>.  To
set the value of <VAR>f</VAR> on the command line, use
<PRE>
    <CODE>-spth=</CODE><VAR>f</VAR>
</PRE>

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="TiltOffset">Tilt Offset</A></H2>
<P>ALIGN2D can apply an offset to all the tilt angles (if you use an
<A HREF="#InputAlignment">input parameter file</A> that is the source of the
angles; otherwise, ALIGN2D gets them from the header of the
<A HREF="#TiltSeries">unaligned data</A>.  By default, ALIGN2D does not
apply an offset.  If you wish to offset the angles (for instance to correct
of a systematic problem in the reported tilt angles) then set the "Tilt
offset" field to the desired offset in degrees.  From the command line, you
can set the tilt angle shift with
<PRE>
    <CODE>-ang_shift=</CODE><VAR>shift</VAR>
</PRE>
<P>where you would replace <VAR>shift</VAR> with the value of the offset
in degrees.

<P>If you use an input parameter file from
<A HREF="MASSNORM.html">massnorm</A>, you will not normally set an angle
shift because massnorm fits the observed intensities and applies a correction
to the reported tilt angles as necessary.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Method">Method</A></H2>
<P>ALIGN2D uses one of three methods to determine the alignment parameters
when the alignment parameters are not extracted from the
<A HREF="#ExtendedHeader">extended header of the tilt series</A>.  The methods
are:
<DL>
  <DT>Talign + Simplex<DD>Computes an initial estimate of the translational
    parameters using a comparatively fast FFT-based cross-correlation
    algorithm and then applies a simplex minimization method to refine all the
    alignment parameters.  On the command line, use the option
    <CODE>-imod=0</CODE> to select this method.
  <DT>Talign<DD>Computes only the translational alignment parameters using
    a comparatively fast FFT-based cross-correlation algorithm.  On the
    command line, use the option <CODE>-imod=1</CODE> to select this method.
  <DT>Simplex<DD>Computes all the alignment parameters using a simplex
    minimization method.  On the command line, use the option
    <CODE>-imod=2</CODE> to select this method.
</DL>

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Stretch">Stretch</A></H2>
<P>In the calculation of the cross-correlation between a pair of projections,
ALIGN2D has the option of assuming that the specimen is thin and then
stretching one of the pair to account for difference in tilt angle.  By
default, ALIGN2D performs stretching.  To turn stretching off from the
graphical user interface, turn off the "Stretch" toggle button in the special
parameters dialog.  On the command line, use
<PRE>
    <CODE>-nostretch</CODE>
</PRE>
<P>to turn off stretching.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Filter">Filter</A></H2>
<P>Prior to using the simplex minimization algorithm, ALIGN2D will by default
filter the images to reduce the contribution from the slowly varying intensity
components (a "high pass" filter).  From the user interface, you can turn off
that filtering by turning off the "Filter" toggle button in the special
parameters dialog.  From the command line, use
<PRE>
    <CODE>-nofilter</CODE>
</PRE>
<P>to turn off that filtering.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="PhaseWeighting">Phase Weighting</A></H2>
<P>ALIGN2D can use phase weighting to sharpen the peaks in the
cross-correlation images at the expense of less robustness in the face of
noise.  From the user interface, you can turn phase weighting on or off
by turning on or off the "Phase weighting" toggle button in the special
parameters dialog.  If the median filter is used, phase weighting is, by
default, off; otherwise, phase weighting is, by default on.  On the command
line, you can specify
<PRE>
    <CODE>-phaseweight</CODE>
</PRE>
<P>to turn on phase weighting; if you do not specify that option, ALIGN2D
will not use phase weighting.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="SimplexDeviations">Simplex Deviations</A></H2>
<P>These six parameters set the characteristic length for each of the six
alignment parameters that simplex can refine when aligning a pair of sections.
A characteristic length scale of zero for a parameter causes the simplex
method to not refine that parameter; in the graphical user interface, you
turn on or off the refinement of a parameter with the toggle button adjacent
to the field which displays the characteristic length.  The six alignment
parameters are the x shift (in pixels), y shift (in pixels), rotation (in
degrees), isotropic magnification factor, the orientation angle for the
anisotropic stretching axis (in degrees), and the anisotropic stretching
factor.  The first four parameters have a direct effect on the output alignment
parameters.  The last two (the orientation of the anisotropic stretching
direction and the anisotropic stretching factor) do not.

<P>On the command line, you can use
<PRE>
    <CODE>-dev=</CODE><VAR>xshift_l</VAR><CODE>:</CODE><VAR>yshift_l</VAR><CODE>:</CODE><VAR>rot_l</VAR><CODE>:</CODE><VAR>mag_l</VAR><CODE>:</CODE><VAR>axis_l</VAR><CODE>:</CODE><VAR>stretch_l</VAR>
</PRE>
<P>to set the characteristic lengths.  The default characteristic lengths are
one pixel for the x and y shifts, zero degrees for the rotation angle and
orientation angle for the anisotropic stretching axis, and zero for the
isotropic magnification factor and anisotropic stretching factor.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Resolution">Resolution</A></H2>
<P>The resolution parameter selects which resolution to process from the
input tilt series.  0 is the highest (full) resolution.  From the user
interface, you would normally select the resolution from the main
<A HREF="EMTAR.html">EMTAR</A> dialog and allow the software to propagate
the setting to the individual processing stages.  You can also set the
resolution to process specifically for the alignment calculations from the
alignment special parameters dialog.

<P>On the command line, use
<PRE>
    <CODE>-res=</CODE><VAR>i</VAR>
</PRE>
<P>to have the alignment process the <VAR>i</VAR>th resolution.  When
run from the command line and no resolution is selected, the alignment
calculations will use the highest resolution present in the input tilt
series.

<P>Two other parameters, the <A HREF="#FullSize">full size</A> and
<A HREF="#ResolutionScale">resolution scale</A>, affect the handling
of resolution.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="FullSize">Full Size</A></H2>
<P>Use the full size parameter to specify the dimensions, in pixels, of the
full resolution tilt series corresponding to the input tilt series.  In the
typical case where you select a resolution level to process from the main
dialog of <A HREF="EMTAR.html">EMTAR</A>, the graphical interface will
automatically fill in these values correctly.  In the case where you are
running the alignment on a downsampled file but the input and output alignment
parameters are to be for the full resolution data set, you should adjust
the full size parameters to be the dimensions of the full resolution data
set.

<P>On the command line, use
<PRE>
    <CODE>-fullsize=</CODE><VAR>nx</VAR>:<VAR>ny</VAR>
</PRE>
<P>to specify the dimensions, in pixels, of the full resolution data set.
When run from the command line without the -fullsize option, the alignment
will use the dimensions of the highest resolution present in the input
tilt series for the full size.

<P>Two other parameters, the <A HREF="#Resolution">resolution</A> and
<A HREF="#ResolutionScale">resolution scale</A>, affect the handling
of resolution.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="ResolutionScale">Resolution Scale</A></H2>
<P>The resolution scale parameter controls the scale factor applied to
the alignment parameters and to the x and y shift characteristic lengths.
In the typical case where you select a resolution level to process from the
main dialog of <A HREF="EMTAR.html">EMTAR</A>, the graphical interface will
automatically fill in this value correctly.  In the case where you are
running the alignment on a downsampled file but the input and output
alignment parameters are to be for the full resolution data set, you should
set the resolution scale to be the same as the downsampling factor (if the
data is scaled down by a factor of four set the resolution scale parameter to
four).

<P>On the command line, use
<PRE>
    <CODE>-rscale=</CODE><VAR>i</VAR>
</PRE>
<P>to set the resolution scale to be <VAR>i</VAR>.  When run from the
command line without the -rscale option, the alignment calculations will
use a resolution scale factor equal to two raised to the power of the
<A HREF="#Resolution">resolution level</A> selected with -res.

<P>Two other parameters, the <A HREF="#Resolution">resolution</A> and
<A HREF="#FullSize">full size</A>, affect the handling of resolution.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

</BODY>
</HTML>
