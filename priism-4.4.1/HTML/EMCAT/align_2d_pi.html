<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
<HEAD>
  <META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <TITLE>Priism Help: align_2d_pi</TITLE>
  <META NAME="Description" CONTENT="On-line help for a command-line application to align two tilt series to one another.">
  <META NAME="Keywords" CONTENT="Priism,EM,tomography,alignment">
  <LINK REV=MADE HREF="mailto:ive@msg.ucsf.edu">
</HEAD>
<BODY>

<H1><A NAME="align_2d_pi">align_2d_pi</A></H1>
<H2>Overview</H2>

<P>align_2d_pi is a command-line application to align two tilt series to
one another.  The two tilt series must have the same image dimensions and
number of sections.  align_2d_pi writes alignment results to standard output;
it can also record those results as a .bprmMn format alignment parameter file.
align_2d_pi_parallel is a parallel version of align_2d_pi.  It accepts the
same command-line arguments and options as align_2d_pi and also accepts
the options described in <A HREF="Parallel.html">Parallel.html</A> to
control parallel execution.

<P>The command line syntax for align_2d_pi is (optional parts are shown in
brackets):

<PRE>
    <CODE>align_2d_pi</CODE> <VAR>reference</VAR> <VAR>target</VAR> \
        [<CODE>-iprmfile=</CODE><VAR>ipname</VAR>] \
        [<CODE>-oprmfile=</CODE><VAR>opname</VAR>] \
        [<CODE>-ofile=</CODE><VAR>stkname</VAR>] \
        [<CODE>-cor_out=</CODE><VAR>xcname</VAR>] \
        [<CODE>-axis=</CODE><VAR>angle</VAR>] [<CODE>-overwrite_axis</CODE>] \
        [<CODE>-revaxis</CODE>] [<CODE>-imod=</CODE><VAR>m</VAR>] \
        [<CODE>-dev=</CODE><VAR>x</VAR><CODE>:</CODE><VAR>y</VAR><CODE>:</CODE><VAR>rot</VAR><CODE>:</CODE><VAR>mag</VAR><CODE>:</CODE><VAR>axis</VAR><CODE>:</CODE><VAR>stretch</VAR>] \
        [<CODE>-nofilter</CODE>] [<CODE>-nooffset</CODE>] \
        [<CODE>-phaseweight</CODE>] [<CODE>-mult=</CODE><VAR>s</VAR>] \
        [<CODE>-cpd=</CODE><VAR>d</VAR>] [<CODE>-spth=</CODE><VAR>t</VAR>] \
        [<CODE>-shxyz=</CODE><VAR>xs</VAR><CODE>:</CODE><VAR>ys</VAR><CODE>:</CODE><VAR>zs</VAR>] \
        [<CODE>-iref=</CODE><VAR>i</VAR>] \
        [<CODE>-iv=</CODE><VAR>start</VAR><CODE>:</CODE><VAR>end</VAR>] \
        [<CODE>-res=</CODE><VAR>i</VAR>] [<CODE>-resref=</CODE><VAR>i</VAR>] \
        [<CODE>-fullsize=</CODE><VAR>nx</VAR><CODE>:</CODE><VAR>ny</VAR>] \
        [<CODE>-rscale=</CODE><VAR>i</VAR>]
</PRE>

<P>The two required arguments and other options are

<DL>
  <DT><VAR>reference</VAR><DD>Is the name of the MRC file containing one of
    the tilt series.  This tilt series is used as the reference:  the
    calculated alignment parameters can be applied to the other tilt series
    to bring it into alignment with the reference.

  <DT><VAR>target</VAR><DD>Is the name of the MRC file containing the other
    tilt series.

  <DT><CODE>-iprmfile=</CODE><VAR>ipname</VAR>
  <DD>Causes align_2d_pi to read the file named <VAR>ipname</VAR> for the
    initial guess at the alignment parameters.  The file must be in the
    .bprmMn format or older .bprm format.

  <DT><CODE>-oprmfile=</CODE><VAR>opname</VAR>
  <DD>Causes align_2d_pi to write the alignment parameters to a .bprmMn format
    file named <VAR>opname</VAR>.  If you use the -iprmfile option,
    align_2d_pi will carry over parameters it does not modify from the
    input parameter file; otherwise, align_2d_pi will fill in default values
    for the unmodified parameters.

  <DT><CODE>-ofile=</CODE><VAR>stkname</VAR>
  <DD>Specifies the name of the file to write with the reference tilt series
    after it has been apodized and transformed to the target tilt series'
    coordinates.  This file is only generated if the method used includes
    FFT-based cross-correlation.

  <DT><CODE>-cor_out=</CODE><VAR>xcname</VAR>
  <DD>Specifies the name of the MRC file to write with the images of the
    cross-correlation peaks.  This file is only generated if the method
    used includes FFT-based cross correlation.

  <DT><CODE>-axis=</CODE><VAR>angle</VAR>
  <DD>Specifying this option causes align_2d_pi to use <VAR>angle</VAR> as
    the orientation angle, in degrees, for the tilt axis.  This is the
    angle the tilt axis makes with the vertical image axis; a positive
    value implies that a clockwise rotation will make the tilt axis
    parallel to the vertical image axis.  If you also specify an input
    parameter file, you will need to use the <CODE>-overwrite_axis</CODE>
    option if you want the value you specified with <CODE>-axis</CODE> to
    take precedence over the values in the input parameter file.

  <DT><CODE>-revaxis</CODE>
  <DD>Causes align_2d_pi to add 180 degrees to the input rotation parameters,
    whether they come from the input alignment parameter file or -axis.

  <DT><CODE>-overwrite_axis</CODE>
  <DD>If you specify this option, the tilt axis orientation you set with
    <CODE>-axis</CODE> takes precedence over the tilt axis orientation
    values from an input parameter file.

  <DT><CODE>-imod=</CODE><VAR>m</VAR>
  <DD>Sets the method to use for alignment.  <VAR>m</VAR> may be one of
    the values listed below.
    <DL>
      <DT>0<DD>Use a FFT-based cross-correlation to determine the translations
        followed by a simplex optimization of all parameters.
      <DT>1<DD>Use a FFT-based cross-correlation to determine the translations.
        The other parameters are not modified.  This is the default.
      <DT>2<DD>Use a simplex optimization of all parameters.
    </DL>

  <DT><CODE>-dev=</CODE><VAR>x</VAR><CODE>:</CODE><VAR>y</VAR><CODE>:</CODE><VAR>rot</VAR><CODE>:</CODE><VAR>mag</VAR><CODE>:</CODE><VAR>axis</VAR><CODE>:</CODE><VAR>stretch</VAR>
  <DD>Sets the characteristic length for each of the six alignment parameters
    (x shift in pixels, y shift in pixels, rotation in degrees, isotropic
    magnification factor, orientation angle for the anisotropic stretching
    axis in degrees, and anisotropic stretching factor).  The first four
    parameters have a direct effect on the parameters in a .bprmMn file;
    the last two do not.  A characteristic length of zero for a parameter
    prevents align_2d_pi from adjusting that parameter during the alignment.
    By default, align_2d_pi uses a characteristic length of one pixel for the
    x and y shift, a characteristic length of zero degrees for the rotation
    and orientation of the asymmetric stretching axis, and a characteristic
    length of zero for the magnification and asymmetric stretching factor.

  <DT><CODE>-nofilter</CODE>
  <DD>If specified, a highpass filter is not applied when you use simplex
    optimization; otherwise, a highpass filter is applied when you use
    simplex optimization.

  <DT><CODE>-nooffset</CODE>
  <DD>If specified, no offset along the tilt axis is applied when using
    an FFT-based cross-correlation; otherwise an offset is applied along
    the tilt axis and then compensated for prior to writing out the alignment
    parameters.

  <DT><CODE>-phaseweight</CODE>
  <DD>If specified, phase weighting is done in the FFT-based cross-correlation;
    otherwise, phase weighting is not done.

  <DT><CODE>-mult=</CODE><VAR>s</VAR>
  <DD>Sets the scale factor, <VAR>s</VAR>, for the noise component when
    performing phase weighting of the FFT-based cross-correlation function.
    The default value for the scale factor is one hundred.

  <DT><CODE>-cpd=</CODE><VAR>d</VAR>
  <DD>To reduce the effect of a central peak, the algorithm using FFT-based
    cross-correlations will subtract off a radial average from the central
    7 x 7 if the brightest point in the central 7 x 7 occurs at the center
    and a quadratic fit to the center and its four nearest neighbors gives a
    peak position, (xp, yp), where the absolute values of xp and yp are less
    than <VAR>d</VAR>.  The default value of <VAR>d</VAR> is 0.05 pixels.

  <DT><CODE>-spth=</CODE><VAR>t</VAR>
  <DD>For the FFT-based cross-correlations, peaks away from the origin are
    preferred.  A peak at the origin is only accepted if the next highest
    peak (after masking out the origin) has a height less than <VAR>t</VAR>
    times the height of the peak at the origin.  The default value for
    <VAR>t</VAR> is .001.

  <DT><CODE>-shxyz=</CODE><VAR>xs</VAR><CODE>:</CODE><VAR>ys</VAR><CODE>:</CODE><VAR>zs</VAR>
  <DD>Compensates the initial and final alignment parameters for tilt axis
    shifts of <VAR>xs</VAR> pixels in x, <VAR>ys</VAR> pixels in y, and
    <VAR>zs</VAR> pixels in z.  For example, when the reference tilt series
    is generated with the combination of <A HREF="APPL_PRM.html">appl_prm</A>,
    reconstruction, and then reprojection of the reconstruction, you would
    typically specify the same -shxyz option to both
    <A HREF="APPL_PRM.html">appl_prm</A> and to align_2d_pi.  Doing so
    avoids including the shift for the region interest in the alignment
    parameters.

  <DT><CODE>-iref=</CODE><VAR>i</VAR>
  <DD>Sets the zero-based index for the projection to use as the reference
    when compensating for shifts specified with the -shxyz option.  By
    default, align_2d_pi will use the projection whose tilt angle is closest
    to zero as the reference.

  <DT><CODE>-iv=</CODE><VAR>start</VAR><CODE>:</CODE><VAR>end</VAR>
  <DD>Limits the sections align_2d_pi will align:  it will only process
    those sections whose zero-based index is greater than or equal to
    <VAR>start</VAR> and less than or equal to <VAR>end</VAR>.  If you
    specified the -oprmfile option, the generated parameter file will only
    contain data for the aligned sections, and the numbering of the sections
    (i.e. the first column) in that file will be from <VAR>start</VAR> plus
    one to <VAR>end</VAR> plus one.

  <DT><CODE>-res=</CODE><VAR>i</VAR>
  <DD>Specifies that the alignment should use the <VAR>i</VAR>th resolution
    data set (0 is the highest resolution) from the target tilt series.
    <VAR>i</VAR> must be a non-negative integer less than the number of
    resolutions in the target tilt series.  By default, the alignment will use
    the highest resolution data set.

  <DT><CODE>-resref=</CODE><VAR>i</VAR>
  <DD>Is similar to -res, but applies to the reference tilt series.

  <DT><CODE>-fullsize=</CODE><VAR>nx</VAR><CODE>:</CODE><VAR>ny</VAR>
  <DD>Specifies the x and y dimensions (in pixels) of the full resolution
    target tilt series.  If not specified,  these values default to the
    dimensions of the highest resolution present in the target tilt series.
    In the case where you are running the alignment on a downsampled file
    but the input and output alignment parameters are to be for the full
    resolution data set, you should adjust the full size parameters to be
    the dimensions of the full resolution data set.

  <DT><CODE>-rscale=</CODE><VAR>i</VAR>
  <DD>Specifies that a scale factor of 1.0/<VAR>i</VAR> be applied to the
    shifts specified by -shxyz, the shift characteristic lengths specified by
    -dev, and the input alignment parameters.  If you do not specify this
    option, <VAR>i</VAR> is taken to be two raised to the <VAR>j</VAR>th power
    where <VAR>j</VAR> is the resolution selected with -res.  In the case
    where you are running the alignment on a downsampled file but the input
    and output alignment parameters are to be for the full resolution data
    set, you should set the resolution scale to be the same as the
    downsampling factor (if the data is scaled down by a factor of four set
    the resolution scale parameter to four).
</DL>

<H2>Example</H2>
<P>A common use for align_2d_pi is to align a measured tilt series to the
projections of a reconstructed volume.  If the measured tilt series is in
a.proj, the reconstructed volume is in a.vol, and the current guess for the
alignment and mass-normalization parameters is in a.bprmMn, the steps to align
the measured tilt series with the projections of the reconstructed volume
usually look like this:

<OL>
  <LI>Use <A HREF="APPL_PRM.html">appl_prm</A> to adjust the intensities in
    the measured tilt series to match what was used for reconstruction but do
    not apply the alignment parameters.  The command to do this would look
    like (the -imform and -pcbase options should be adjusted to match what was
    used when preparing a tilt series for reconstruction):<BR>
    <CODE>appl_prm a.proj a.mn -iprmfile=a.bprmMn -imform=0 -pcbase=0.05 -noalign</CODE>
  <LI>Use <A HREF="reproj.html">reproj</A> to compute the projections of the
    reconstruction:<BR><CODE>reproj a.vol a.proj a.reproj</CODE>
  <LI>Align the two tilt series with align_2d_pi.  The best choice for
    options to align_2d_pi will depend on the accuracy of the current alignment
    parameters.  Assuming the alignment parameters are fairly accurate and
    that stretching and variation in magnification across the tilt series are
    negligible then the following command line is likely appropriate
    (if the tilt series used to generate the reconstruction was generated
    with appl_prm using non-zero shifts to the -shxyz option then those same
    shifts should be passed to align_2d_pi using the -shxyz option):<BR>
    <CODE>align_2d_pi a.reproj a.mn -iprmfile=a.bprmMn -oprmfile=a_new.bprmMn -imod=2 -dev=1:1:.002:0:0:0</CODE>
</OL>


<H2>Related Priism Topics</H2>
<P>
  <A HREF="../Priism.html">Priism</A> |
  <A HREF="ALIGN2D.html">single tilt series alignment</A> |
  <A HREF="EMTIAR.html">iterative alignment + reconstruction</A> |
  <A HREF="APPL_PRM.html">applying alignment parameters</A>

<HR>

</BODY>
</HTML>
