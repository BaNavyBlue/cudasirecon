<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
<HEAD>
  <META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <TITLE>Priism Help: MASSNORM</TITLE>
  <META NAME="Description" CONTENT="On-line help for the application calculate the relationship between electron counts and the mass density of a sample.">
  <META NAME="Keywords" CONTENT="Priism,EM,tomography,reconstruction,mass density">
  <LINK REV=MADE HREF="mailto:ive@msg.ucsf.edu">
</HEAD>
<BODY>

<H1><A NAME="MASSNORM">MASSNORM</A></H1>
<H2>Overview</H2>
<P>massnorm calculates the relationship between observed electron counts
and the specimen's mass density and corrects for electron dose fluctuations
during data collection.

<P>The algorithm is:
<OL>
  <LI>Find the reference average value A(i) on each projection
    (these average values would fall along an exponential curve if there
    was a constant level of illumination for all projections).  There are two
    approaches to calculating the reference average value:
    <UL>
      <LI>A(i) is the value for which five percent of the pixels
        have a value greater than A(i).  This method is appropriate when
        there is a large area of background.
      <LI>A(i) is e^(average(log(projection i))).
    </UL>
    It can be beneficial, especially for the average option, to
    supply massnorm with <A HREF="#InputAlignment">alignment parameters</A>
    and restrict the <A HREF="#AnalysisRegion">analysis region</A> so the
    reference values are computed from the same part of the sample.
  <LI>If exposure times have been recorded in the extended header of the tilt
    series, normalize the A(i) by them.
  <LI>Fit an exponential cosine curve to the A(i).  The fit can be
    written to file (see the <A HREF="#FitGraph">fit graph parameter</A>),
    and the contents of that file can be viewed with
    <A HREF="../2d_plot.html">2d_plot</A>.  The reference values, A(i), and
    the fit are also saved in the output parameter file.
</OL>

<P>Here's an example command file for massnorm:
<PRE>
     (time massnorm \
      /mama/weiping/test/cent5r.stk \
      -iprmfile=/mama/weiping/test/cent5r.bprmMn \
      -oprmfile=/mama/weiping/test/cent5r.bprmMn \
      -bckgfit=1 -trange=-60:60 -all \
      -toffset=0 -nhist=400 -oplotfile=none -plot=1 ) \
      &gt; /mama/weiping/emrecon.log
</PRE>

<H3><A NAME="Parameters">Parameters</A></H3>
<P>
   <A HREF="#TiltSeries">Tilt series</A> |
   <A HREF="#NX:NY:NV">NX:NY:NV</A> |
   <A HREF="#InputAlignment">Input alignment</A> |
   <A HREF="#OutputAlignment">Output alignment</A> |
   <A HREF="#FitQuantity">Quantity to fit</A> |
   <A HREF="#TiltRange">Tilt range</A> |
   <A HREF="#AnalysisRegion">Analysis region</A> |
   <A HREF="#AnalysisRegionSize">Analysis region size</A> |
   <A HREF="#AnalysisRegionShift">Analysis region shift</A> |
   <A HREF="#ReferenceProjection">Reference projection</A> |
   <A HREF="#TiltOffset">Tilt offset</A> |
   <A HREF="#AxisOrientation">Axis orientation</A> |
   <A HREF="#Baseline">Baseline</A> |
   <A HREF="#LocateJumps">Locate jumps</A> |
   <A HREF="#NumberOfBins">Number of bins</A> |
   <A HREF="#FitGraph">Fit graph</A> |
   <A HREF="#Resolution">Resolution</A> |
   <A HREF="#FullSize">Full size</A> |
   <A HREF="#ResolutionScale">Resolution scale</A> |
   <A HREF="#ReverseAxis">Reverse tilt axis</A>

<H3>Related Priism Topics</H3>
<P>
  <A HREF="../Priism.html">Priism</A> |
  <A HREF="EMTAR.html">Alignment and reconstruction</A> |
  <A HREF="ALIGN2D.html">Cross-correlation alignment</A> |
  <A HREF="APPL_PRM.html">APPL_PRM</A> |
  <A HREF="EWBP.html">EWBP</A> |
  <A HREF="TAPIR.html">TAPIR</A> |
  <A HREF="BALIGN.html">Alignment with markers</A>

<HR>

<H2><A NAME="TiltSeries">Tilt Series</A></H2>
<P>This is the name of the file containing the raw projection data stack
from the CCD (i.e. measured in terms of electron counts; data stacks
with the contrast inverted can not be handled).  On the command line, the
tilt series file name is the first argument.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="NX:NY:NV">NX:NY:NV</A></H2>
<P>The first two values are, respectively, the x and y dimension of the
projections.  The third value is the number of projections in the data
stack.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="InputAlignment">Input Alignment</A></H2>
<P>This is the name of the input alignment parameter file; the file can be
generated by the
<A HREF="ALIGN2D.html">cross-correlation alignment application</A> or
the <A HREF="BALIGN.html">applications for alignment with markers</A>.

<P>To specify the input parameter file from the command line use
<CODE>-iprmfile=</CODE><VAR>filename</VAR>.  <EM>none</EM> can be used
for the file name to signal that no input parameter file is available.
If you do not specify an input parameter file, massnorm will try to
use the file with the same base name as the
<A HREF="#TiltSeries">tilt series</A> but with a .bprmMn extension.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="OutputAlignment">Output Alignment</A></H2>
<P>This is the name of the output file in which to store the alignment
parameters. This file can be used as input to
<A HREF="APPL_PRM.html">APPL_PRM</A> and includes the information for
converting electron counts to a mass density.

<P>To specify the output parameter file from the command line use
<CODE>-oprmfile=</CODE><VAR>filename</VAR>.  If you do not specify a
filename or the name specified is <EM>none</EM>, massnorm will generate
a file with the  same base name as the <A HREF="#TiltSeries">tilt series</A>
but with a .bprmMn extension.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="FitQuantity">Quantity to Fit</A></H2>
<P>Controls how the reference value for each projection is calculated.
For the <EM>average intensity</EM> option, the reference value is
e^(average(log(projection i))).  Use this option when there is no clear
background in the projections.  For the <EM>background intensity</EM> option,
the reference value is the cutoff point for the top five percent of the
intensity values.

<P>On the command line, use <CODE>-bckgfit=1</CODE> to use the cutoff
from the top five percent of the intensity values and use
<CODE>-bckgfit=0</CODE> for the other method.  If neither is supplied, the
default is to use the cutoff for the top five percent.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="TiltRange">Tilt Range</A></H2>
<P>Sets the range of tilt angles included when fitting the reference
average values.  The first value is the minimum angle, in degrees, to
use; the second is the maximum value.

<P>On the command line specify the range of tilts with
<CODE>-trange=</CODE><VAR>min_angle</VAR><CODE>:</CODE><VAR>max_angle</VAR>.
If the range is not specified on the command line, the full range of tilt
angles from the <A HREF="#TiltSeries">tilt series</A> is included in the
fit.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="AnalysisRegion">Analysis Region</A></H2>
<P>In the graphical user interface, the "Analysis region" menu controls
the area massnorm uses for computation of the reference average values.
There are three options available:
<DL>
  <DT>all<DD>massnorm uses the entire area of each projection in the
    calculation.
  <DT>common area<DD>massnorm uses the area that is common to all projections
    within the <A HREF="#TiltRange">specified tilt range</A>.  If you provide
    reasonable <A HREF="#InputAlignment">alignment parameters</A>, then this
    option is more conservative than the "all" option and is useful when high
    tilts pull in new features that, if included in the calculations, would
    substantially change the statistics.
  <DT>from size & shift<DD>massnorm uses the area specified by the
    <A HREF="#AnalysisRegionSize">analysis region size</A>,
    <A HREF="#AnalysisRegionShift">analysis region shift</A>,
    and <A HREF="#ReferenceProjection">reference projection</A> parameters.
    To set the size and shift, you could use the
    <A HREF="EMTAR.html#SelectRegion">procedure for selecting a region to
    reconstruct</A>.
</DL>

<P>On the command line, include <CODE>-all</CODE> in the options to cause
massnorm to use the entire area of each projection.  Include
<CODE>-common</CODE> and do not include <CODE>-all</CODE> in the options to
cause massnorm to use the area common to all projections within the selected
tilt range.  To specify the area by the size and shift, do not include
<CODE>-all</CODE> or <CODE>-common</CODE> in the options and
specify at least one of the <CODE>-dimxy</CODE>, <CODE>-shxyz</CODE>, or
<CODE>-iref</CODE> options.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="AnalysisRegionSize">Analysis Region Size</A></H2>
<P>If you are using the "from size & shift" option for the
<A HREF="#AnalysisRegion">analysis region</A>, the analysis region size
parameters set the x and y dimensions for the area used to estimate the
reference average values.  These dimensions are for a projection with a tilt of
zero degrees; the area chosen on a projection with tilt t is
nx * cos(t) by ny where nx and ny are the dimensions at a tilt of zero
degrees.

<P>On the command line, specify these dimensions with
<CODE>-dimxy=</CODE><VAR>nx</VAR><CODE>:</CODE><VAR>ny</VAR>.  If no dimensions
are specified, massnorm uses the dimensions of the input projections.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="AnalysisRegionShift">Analysis Region Shift</A></H2>
<P>If you are using the "from size & shift" option for the
<A HREF="#AnalysisRegion">analysis region</A>, the analysis region shift
parameters shift the imaginary 3D tilt axis of the projection data from and
thus shift the region of analysis.  All three values have units of pixels.
The default orientation of the 3D tilt axis has it pass through the point
whose x and y coordinates are the center of the
<A HREF="#ReferenceProjection">reference projection</A>.

<P>Use <CODE>-shxyz=</CODE><VAR>x_shift</VAR><CODE>:</CODE><VAR>y_shift</VAR><CODE>:</CODE><VAR>z_shift</VAR>
to set the shifts on the command line.  If the shifts are not specified,
massnorm uses a shift of zero pixels in each direction.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="ReferenceProjection">Reference Projection</A></H2>
<P>For calculating the effect of the x and y shifts (see the
<A HREF="#AnalysisRegionShift">analysis region center</A> parameter), massnorm
uses the center of the reference projection.  Specify the reference projection
by its zero-based index in the file (i.e. a value between zero and the number
of projections minus one) or use a value of negative one to select the
projection whose tilt angle is closest to zero.

<P>The reference projection can be set on the command line with
<CODE>-iref=</CODE><VAR>index</VAR>.  If it is not specified or
<VAR>index</VAR> is less than zero or greater than or equal to the
number of projections in the input file, massnorm uses the projection whose
tilt angle is closest to zero.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="TiltOffset">Tilt Offset</A></H2>
<P>If the tilt offset is not 90, it is the offset in degrees massnorm
adds to the input tilt angles to get the tilt angles written to the
<A HREF="#OutputAlignment">output alignment parameter file</A>.  If
tilt offset is 90, massnorm computes an offset from a fit to the intensities
and adds that offset to the input tilt angles to get the tilt angles written
to the output alignment parameter file.

<P>Use the tilt offset to correct for cases where the tilt angles in the
extended header are offset from the true values.  Normally, you would set the
tilt offset to zero (i.e. the extended header values are known to be correct)
or to 90.

<P>To specify the offset on the command line, use
<CODE>-toffset=</CODE><VAR>offset</VAR>.  If you do not set the offset via the
command line, massnorm determines the offset from the fit to the intensities.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Baseline">Baseline</A></H2>
<P>When massnorm fits the exponential cosine curve, you have the option to
model a contribution to the observed intensities, the baseline intensity
level, that does not vary with tilt angle.  Starting with Priism version
4.2.1, the default behavior of massnorm is to not model the baseline
intensity level because modeling the baseline value proved to be unreliable
for many data sets.  The massnorm in previous versions of Priism 4 always
modeled the baseline intensity level.  To turn on modeling of the baseline
intensity level in massnorm, turn on the toggle button labeled "Baseline" in
massnorm's special parameters dialog.  When you run massnorm directly on the
command line, include the option <CODE>-basefit=</CODE><VAR>i</VAR>, where
<VAR>i</VAR> is an integer greater than or equal to one, to turn on modeling
of the baseline intensity level.  To not model the baseline intensity level,
do not include the <CODE>-basefit=</CODE> option on the command line or use it
with an integer argument less one.  In the current implementation, modeling
of the baseline intensity level is not compatible with the
<A HREF="#LocateJumps">option to identify and fit abrupt changes in the
intensities</A>.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="LocateJumps">Locate Jumps</A></H2>
<P>Because a tomographic data set is frequently collected in two passes
(one for a range of tilts from near zero to the upper tilt angle limit and
another for the remaining tilt angles) or an interruption occurred during
the time necessary to collect the data set, some data sets have abrupt changes
in the image intensities as a function of tilt angle.  For those cases,
massnorm has an option to automatically identify the ranges of tilt angles
collected under different conditions and, with the exception of the tilt
angle offset, use different fitting parameters for each range.  To enable
that option, turn on the "Locate jumps" toggle button in massnorm's special
parameters dialog.  When you run massnorm directly on the command line,
include the option <CODE>-findjumps=</CODE><VAR>i</VAR>, where <VAR>i</VAR>
is an integer greater than or equal to one, to turn on the option to
identify abrupt changes in the parameters.  As currently implemented,
massnorm can not simultaneously
<A HREF="#Baseline">model the baseline intensity</A> and identify abrupt
parameter changes.  When you turn on modeling of the baseline intensity
that takes precedence and massnorm will not attempt to identify abrupt
parameter changes.  Also, massnorm only attempts to identify abrupt parameter
changes in the <A HREF="#TiltRange">range of tilt angles you included in
the fit</A>.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="AxisOrientation">Axis Orientation</A></H2>
<P>If you do not use an <A HREF="#InputAlignment">input parameter file</A>,
or you turn on the "overwrite input" toggle button next to the
"Axis orientation" field, you can use the "Axis orientation" field to specify
the angle, in degrees, that the tilt axis makes with the vertical axis of the
images as displayed in Priism.  If the angle is positive, the images have to
be rotated clockwise to make the tilt axis vertical.

<P>On the command line, specify the orientation angle for the tilt axis with
the option
<PRE>
    <CODE>-axis=</CODE><VAR>angle_value</VAR>
</PRE>

<P>The command-line option to override the tilt axis orientation in the input
parameter file is
<PRE>
    <CODE>-overwrite_axis</CODE>
</PRE>

<P>If you do not specify -axis and either do not supply an input parameter
file or specify -overwrite_axis, the tilt axis will be assumed to be vertical.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="NumberOfBins">Number of Bins</A></H2>
<P>This parameter sets the number of bins in the histograms in the optional
<A HREF="#FitGraph">graph output file</A>; it does not affect the internal
calculations of the projection reference values.

<P>The syntax for specifying this parameter on the command line is
<CODE>-nhist=</CODE><VAR>n</VAR>.  If you do not specify a number of bins,
massnorm will generate graphs with 400 bins.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="FitGraph">Fit Graph</A></H2>
<P>This is the name of the output file to generate with the projection
reference values and the corresponding fitted values from the absorption
model.  You can view line plots of this data by loading the file into
<A HREF="../2d_plot.html">2d_plot</A>.  This file is not used by any
other part of the EM reconstruction package.

<P>To specify the name of the plot file on the command line, use
<CODE>-oplotfile=</CODE><VAR>filename</VAR>.  If <CODE>-oplotfile</CODE>
is not supplied or <VAR>filename</VAR> is <EM>none</EM>, then no
output plot file is generated.

<P>massnorm has the option to automatically display the graph generated.
If you change the pulldown menu in the <EM>Special Parameters</EM> dialog,
from <EM>save only</EM> to <EM>show and save</EM>, these results will be
automatically displayed with <A HREF="../2d_plot.html">2d_plot</A>  On the
command line, use <CODE>-plot=0</CODE> to automatically display the fit
results (this is the default setting); otherwise, use <CODE>-plot=1</CODE>.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="Resolution">Resolution</A></H2>
<P>The resolution parameter selects which resolution to process from the
input tilt series.  0 is the highest (full) resolution.  From the user
interface, you would normally select the resolution from the main
<A HREF="EMTAR.html">EMTAR</A> dialog and allow the software to propagate
the setting to the individual processing stages.  You can also set the
resolution to process specifically for the calculation of the
mass-normalization parameters from the special parameters dialog for the
mass-normalization step.

<P>On the command line, use
<PRE>
    <CODE>-res=</CODE><VAR>i</VAR>
</PRE>
<P>to have the calculation of the mass-normalization parameters performed on
the <VAR>i</VAR>th resolution.  When run from the command line and no
resolution is selected, the calculations will use the the highest resolution
present in the input tilt series.

<P>Two other parameters, the <A HREF="#FullSize">full size</A> and
<A HREF="#ResolutionScale">resolution scale</A>, affect the handling
of resolution.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="FullSize">Full Size</A></H2>
<P>Use the full size parameter to specify the dimensions, in pixels, of the
full resolution tilt series corresponding to the input tilt series.  In the
typical case where you select a resolution level to process from the main
dialog of <A HREF="EMTAR.html">EMTAR</A>, the graphical interface will
automatically fill in these values correctly.  In the case where you are
performing the mass normalization calculations on a downsampled file but the
input and output alignment parameters are for the full resolution data set,
you should adjust the full size parameters to be the dimensions of the full
resolution data set.

<P>On the command line, use
<PRE>
    <CODE>-fullsize=</CODE><VAR>nx</VAR>:<VAR>ny</VAR>
</PRE>
<P>to specify the dimensions, in pixels, of the full resolution data set.
When run from the command line without the -fullsize option, the calculation
of the mass-normalization parameters will use the dimensions of the highest
resolution present in the input tilt series for the full size.

<P>Two other parameters, the <A HREF="#Resolution">resolution</A> and
<A HREF="#ResolutionScale">resolution scale</A>, affect the handling
of resolution.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="ResolutionScale">Resolution Scale</A></H2>
<P>The resolution scale parameter controls the scale factor applied to
the alignment parameters and, when you use a size and shift to specify
the region for analysis, the size and shift parameters for the analysis
region.  In the typical case where you select a resolution level to process
from the main dialog of <A HREF="EMTAR.html">EMTAR</A>, the graphical
interface will automatically fill in the resolution scale correctly.  In the
case where you are calculating the mass-normalization parameters from a
downsampled file but the input alignment parameters are for the full
resolution data set, you should set the resolution scale to be the same as the
downsampling factor (if the data is scaled down by a factor of four set the
resolution scale parameter to four).

<P>On the command line, use
<PRE>
    <CODE>-rscale=</CODE><VAR>i</VAR>
</PRE>
<P>to set the resolution scale to be <VAR>i</VAR>.  When run from the
command line without the -rscale option, the calculation of the
mass-normalization parameters will use a resolution scale factor equal to two
raised to the power of the <A HREF="#Resolution">resolution level</A> selected
with -res.

<P>Two other parameters, the <A HREF="#Resolution">resolution</A> and
<A HREF="#FullSize">full size</A>, affect the handling of resolution.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

<H2><A NAME="ReverseAxis">Reverse Tilt Axis</A></H2>
<P>massnorm can add 180 degrees to the input rotation parameters (which set
the tilt axis orientation) whether those parameters are derived from the
input alignment parameter file or the
<A HREF="#AxisOrientation">axis orientation parameter</A>).  The usual reason
for doing so would be to match your experimental conditions with the geometry
conventions used to
<A HREF="PFOCUSRAMP.html#Defocus">compute the defocus in CTF correction</A>
and <A HREF="ReconCoordSys.html">generate reconstructions</A>.

<P>From the graphical user interface, turn on the toggle button labeled
"Reverse tilt axis" to add 180 degrees to the rotation parameters.  That toggle
button is in the special parameters dialog.  On the command line, include
<CODE>-revaxis</CODE> in the options to add 180 degrees to the rotation
parameters.

<P><A HREF="#Parameters">Return to the list of parameters</A>
<HR>

</BODY>
</HTML>
