<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
<HEAD>
  <META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <TITLE>Priism Help: Filter 3D</TITLE>
  <META NAME="Description" CONTENT="On-line help for Priism's application to implement several three-dimensional filters (median, mean, ...).">
  <META NAME="Keywords" CONTENT="Priism,filtering,median">
  <LINK REV=MADE HREF="mailto:ive@msg.ucsf.edu">
</HEAD>
<BODY>

<H1><A NAME="Filter3D">Filter 3D</A></H1>
<H2>Overview</H2>

<P>Filter3D provides a set of three-dimensional filters, operations which for
each pixel in the output calculate an intensity based on the input intensities
in a box-shaped region about the pixel.  The <A HREF="#Method">same filters</A>
are available as in <A HREF="Filter2D.html">Filter 2D</A>, including mean
and median filters.  The size of the region is set by the
<A HREF="#KernelSize">XY and Z kernel size fields</A>.  The three dimensions
used for filtering can either be x, y, and z or x, y, and time.  You can switch
between the two with the
<A HREF="#SwapZT">toggle button labeled "swap z/time"</A>.  Filtering over
x, y, and z is the default when the input file has more than one z section per
time point or only one time point.

<P>Filter 3D's user interface uses the <A HREF="Region.html">same set of
controls</A> for selecting and processing a region as other Priism
applications.

<H3>Topics</H3>
<P>
  Overview |
  <A HREF="Region.html">Region processing</A> |
  <A HREF="#Method">Method (filter types)</A> |
  <A HREF="#SwapZT">Swap z/time</A> |
  <A HREF="#Enhance">Enhance</A> |
  <A HREF="#ScaleFactor">Scale factor</A> |
  <A HREF="#Sigma">Sigma</A> |
  <A HREF="#IntensitySigma">Intensity sigma</A> |
  <A HREF="#KernelSize">Kernel size</A> |
  <A HREF="#Iterations">Iterations</A> |
  <A HREF="#CommandLine">Command line</A>

<H3>Related Priism Topics</H3>
<P>
  <A HREF="Priism.html">Priism</A> |
  <A HREF="Filter2D.html">Filter 2D</A> |
  <A HREF="NewConvolution.html">Convolution</A>
<HR>

<H2><A NAME="Method">Method</A></H2>
<P>The available filter types are listed below.  More details and examples
of the results on two-dimensional data are in the
<A HREF="Filter2D.html#Method">Filter 2D documentation</A>.

<H3><A NAME="MedianFilter">Median</A></H3>
<P>The median filter looks at the image intensities within a box-shaped region
around each pixel and selects the median value for the resulting image.  When
the <A HREF="#Enhance">enhance toggle</A> is on, the result is the input times
a <A HREF="#ScaleFactor">scale factor</A> minus the selected median.

<H3><A NAME="MeanFilter">Mean</A></H3>
<P>The mean filter is similar to the median filter except that the mean value
is used instead of the median.

<H3><A NAME="GaussianFilter">Gaussian</A></H3>
<P>When the <A HREF="#Enhance">enhance toggle</A> is off, the Gaussian
filter replaces a value with the weighted average of it and the neighboring
pixels; the weights fall off exponentially as the square of the distance
divided by 2 times the square of <A HREF="#Sigma">sigma</A>.  When the
enhance toggle is on, the result is the input times a
<A HREF="#ScaleFactor">scale factor</A> minus the weighted average.

<H3><A NAME="LaplacianFilter">Laplacian (LoG)</A></H3>
<P>The Laplacian filter implemented here is an approximation to the negative of
the Laplacian operator.  The Laplacian operator has the useful property that a
location where the output values change sign marks the position of an edge.
The Laplacian operator involves the computation of differences and therefore
tends to amplify noise.  If <A HREF="#Sigma">sigma</A> is greater than zero,
the Laplacian is combined with a Gaussian smoothing step to give what is
known as the Laplacian of Gaussian or LoG filter; this is useful for reducing
the amount of noise introduced.

<P>When the <A HREF="#Enhance">Enhance toggle</A> is on, the
<A HREF="#ScaleFactor">scale factor</A> times the input minus the result of
the of the filter is computed.  This is one way to enhance edges in an image;
another, likely better, method is to use the
<A HREF="Edge.html">EdgeEnh application</A>.

<H3><A NAME="AvgDevFilter">Avg. Deviation</A></H3>
<P>When the <A HREF="#Enhance">enhance toggle</A> is off, the output is
an unbiased estimate of the average absolute deviation from the local mean.
When the <A HREF="#Enhance">enhance toggle</A> is on, the output is
the average absolute deviation from the input intensity at that point.

<H3><A NAME="WeightedMeanFilter">Weighted Mean</A></H3>
<P>See the <A HREF="Filter2D.html#Method">Filter 2D documentation</A>
for how this filter is defined - the name is probably a misnomer but
it is what was used in previous versions of Filter 2D.  If you know a
use or a rationale for this particular filter, let the Priism
maintainers know.

<H3><A NAME="MinimumFilter">Minimum</A></H3>
<P>When the <A HREF="#Enhance">enhance toggle</A> is off, the minimum
filter replaces a value with the minimum value in the neighborhood.  If the
input is a binary image (values are either one or zero), the minimum filter
is equivalent to the morphological erosion operator with a square structuring
element.  When the enhance toggle is on, the result is the input times a
<A HREF="#ScaleFactor">scale factor</A> minus the neighborhood minimum.

<H3><A NAME="MaximumFilter">Maximum</A></H3>
<P>When the <A HREF="#Enhance">enhance toggle</A> is off, the maximum
filter replaces a value with the maximum value in the neighborhood.  If the
input is a binary image (values are either one or zero), the maximum filter
is equivalent to the morphological dilation operator with a square structuring
element.  When the enhance toggle is on, the result is the input times a
<A HREF="#ScaleFactor">scale factor</A> minus the neighborhood maximum.

<H3><A NAME="BilateralFilter">Bilateral</A></H3>
<P>The bilateral filter implements the filter described in

<BLOCKQUOTE>
  Tomasi, C. and Manduchi, R.  "Bilateral Filtering for Gray and Color
  Images."  Proceedings of the 1998 IEEE International Conference on
  Computer Vision, Bombay, India.  Pages 839 - 846.
</BLOCKQUOTE>

<P>The filter replaces the value at a pixel,
(<VAR>i</VAR>, <VAR>j</VAR>, <VAR>k</VAR>), with a weighted sum of the pixel
values in the neighborhood.  Each weight is the product of a factor dependent
on the distance (in pixels) to (<VAR>i</VAR>, <VAR>j</VAR>, <VAR>k</VAR>) and
another factor dependent on the difference in intensity with the pixel at
(<VAR>i</VAR>, <VAR>j</VAR>, <VAR>k</VAR>).  This implementation of the
bilateral filter uses Gaussian functions for both components of the weight.
The values in the <A HREF="#Sigma">"Sigma XY/Z (pix)" field</A> control the
standard deviations for the Gaussian weighting as a function of distance, and
the value in the <A HREF="#IntensitySigma">"Intensity sigma" field</A>
controls the standard deviation for the Gaussian weighting as a function of
intensity difference.

<H3>Topics</H3>
<P>
  <A HREF="#Filter3D">Overview</A> |
  <A HREF="Region.html">Region processing</A> |
  Method (filter types) |
  <A HREF="#SwapZT">Swap z/time</A> |
  <A HREF="#Enhance">Enhance</A> |
  <A HREF="#ScaleFactor">Scale factor</A> |
  <A HREF="#Sigma">Sigma</A> |
  <A HREF="#IntensitySigma">Intensity sigma</A> |
  <A HREF="#KernelSize">Kernel size</A> |
  <A HREF="#Iterations">Iterations</A> |
  <A HREF="#CommandLine">Command line</A>
<HR>

<H2><A NAME="SwapZT">Swap Z/Time</A></H2>
<P>The three dimensions used for filtering can either be x, y, and z or
x, y, and time.  When the toggle button labeled "swap z/time" is off, the
program uses x, y, and z as the dimensions to filter.  When that toggle
button is on, the program uses x, y, and time as the dimensions to filter.
When you select a new input file, the program will automatically select
the dimension to use as the third dimension.  If the file has more than one
z section or only one time point, the program will use the z dimension as
the third dimension; otherwise, it will use the time dimension as the third
dimension.

<H3>Topics</H3>
<P>
  <A HREF="#Filter3D">Overview</A> |
  <A HREF="Region.html">Region processing</A> |
  <A HREF="#Method">Method (filter types)</A> |
  Swap z/time |
  <A HREF="#Enhance">Enhance</A> |
  <A HREF="#ScaleFactor">Scale factor</A> |
  <A HREF="#Sigma">Sigma</A> |
  <A HREF="#IntensitySigma">Intensity sigma</A> |
  <A HREF="#KernelSize">Kernel size</A> |
  <A HREF="#Iterations">Iterations</A> |
  <A HREF="#CommandLine">Command line</A>

<HR>

<H2><A NAME="Enhance">Enhance</A></H2>
<P>When the <EM>Enhance</EM> toggle is on the result for
each <A HREF="#Iterations">iteration</A> is the input data for that iteration
times a <A HREF="#ScaleFactor">scale factor</A> minus what the result would be
when the toggle was off.  The <A HREF="#AvgDevFilter">average deviation</A>
filter is an exception to this.

<H3>Topics</H3>
<P>
  <A HREF="#Filter3D">Overview</A> |
  <A HREF="Region.html">Region processing</A> |
  <A HREF="#Method">Method (filter types)</A> |
  <A HREF="#SwapZT">Swap z/time</A> |
  Enhance |
  <A HREF="#ScaleFactor">Scale factor</A> |
  <A HREF="#Sigma">Sigma</A> |
  <A HREF="#IntensitySigma">Intensity sigma</A> |
  <A HREF="#KernelSize">Kernel size</A> |
  <A HREF="#Iterations">Iterations</A> |
  <A HREF="#CommandLine">Command line</A>
<HR>

<H2><A NAME="ScaleFactor">Scale Factor</A></H2>
<P>If the <A HREF="#Enhance">Enhance toggle</A> is on and the filter is not
an <A HREF="#AvgDevFilter">average deviation filter</A>, the result of
an iteration is the input data for that iteration times the scale factor
minus the filtered input data.

<H3>Topics</H3>
<P>
  <A HREF="#Filter3D">Overview</A> |
  <A HREF="Region.html">Region processing</A> |
  <A HREF="#Method">Method (filter types)</A> |
  <A HREF="#Enhance">Enhance</A> |
  Scale factor |
  <A HREF="#Sigma">Sigma</A> |
  <A HREF="#IntensitySigma">Intensity sigma</A> |
  <A HREF="#KernelSize">Kernel size</A> |
  <A HREF="#Iterations">Iterations</A> |
  <A HREF="#CommandLine">Command line</A>
<HR>

<H2><A NAME="Sigma">Sigma</A></H2>
<P>For the <A HREF="#GaussianFilter">Gaussian</A> and
<A HREF="#LaplacianFilter">Laplacian (LoG)</A>, and
<A HREF="#BilateralFilter">bilateral</A> filters the width is controlled by
the value of sigma in a given dimension.  Larger values of sigma give broader
filters.  The values of sigma for the x and y directions are the same; in the
z (or time) direction the value of sigma can be given a different value.

<P>When the <EM>autosize</EM> toggle is on, any changes to the sigma
values will automatically calculate a kernel size to give a reasonable
approximation for the filter.

<H3>Topics</H3>
<P>
  <A HREF="#Filter3D">Overview</A> |
  <A HREF="Region.html">Region processing</A> |
  <A HREF="#Method">Method (filter types)</A> |
  <A HREF="#SwapZT">Swap z/time</A> |
  <A HREF="#Enhance">Enhance</A> |
  <A HREF="#ScaleFactor">Scale factor</A> |
  Sigma |
  <A HREF="#IntensitySigma">Intensity sigma</A> |
  <A HREF="#KernelSize">Kernel size</A> |
  <A HREF="#Iterations">Iterations</A> |
  <A HREF="#CommandLine">Command line</A>
<HR>

<H2><A NAME="IntensitySigma">Intensity Sigma</A></H2>
<P>The value in the "Intensity sigma" field only affects the
<A HREF="#BilateralFilter">bilateral filter</A>.  The bilateral filter tends
to reduce the magnitude of intensity changes that are less than the intensity
sigma and preserve the magnitude of intensity changes that are much greater
than the intensity sigma.

<H3>Topics</H3>
<P>
  <A HREF="#Filter3D">Overview</A> |
  <A HREF="Region.html">Region processing</A> |
  <A HREF="#Method">Method (filter types)</A> |
  <A HREF="#SwapZT">Swap z/time</A> |
  <A HREF="#Enhance">Enhance</A> |
  <A HREF="#ScaleFactor">Scale factor</A> |
  <A HREF="#Sigma">Sigma</A> |
  Intensity sigma |
  <A HREF="#KernelSize">Kernel size</A> |
  <A HREF="#Iterations">Iterations</A> |
  <A HREF="#CommandLine">Command line</A>
<HR>

<H2><A NAME="KernelSize">Kernel Size</A></H2>
<P>The kernel size is the size, in pixels, of the box used to calculate
the filtered images.  The box has a square cross section in x and y; the
square has a side length given by the value in the <EM>XY kernel size</EM>
field.  The height of the box (i.e. the width of the filter in the z or time
dimension) is given by the value in the <EM>Z kernel size</EM> field.

<H3>Topics</H3>
<P>
  <A HREF="#Filter3D">Overview</A> |
  <A HREF="Region.html">Region processing</A> |
  <A HREF="#Method">Method (filter types)</A> |
  <A HREF="#SwapZT">Swap z/time</A> |
  <A HREF="#Enhance">Enhance</A> |
  <A HREF="#ScaleFactor">Scale factor</A> |
  <A HREF="#Sigma">Sigma</A> |
  <A HREF="#IntensitySigma">Intensity sigma</A> |
  Kernel size |
  <A HREF="#Iterations">Iterations</A> |
  <A HREF="#CommandLine">Command line</A>
<HR>

<H2><A NAME="Iterations">Iterations</A></H2>
<P>The filter is applied repeatedly with the output from the previous pass
becoming the input for the next.  The number of passes is shown in the
<EM>Iterations</EM> field.

<H3>Topics</H3>
<P>
  <A HREF="#Filter3D">Overview</A> |
  <A HREF="Region.html">Region processing</A> |
  <A HREF="#Method">Method (filter types)</A> |
  <A HREF="#SwapZT">Swap z/time</A> |
  <A HREF="#Enhance">Enhance</A> |
  <A HREF="#ScaleFactor">Scale factor</A> |
  <A HREF="#Sigma">Sigma</A> |
  <A HREF="#KernelSize">Kernel size</A> |
  <A HREF="#IntensitySigma">Intensity sigma</A> |
  Iterations |
  <A HREF="#CommandLine">Command line</A>
<HR>

<H2><A NAME="CommandLine">Command Line</A></H2>
<P>Filter 3D accepts the command-line arguments described in
<A HREF="Region.html#COMMANDLINE">Region.html</A>.  In addition, Filter 3D
has the following options (optional parts are shown in brackets):

<DL>
  <DT><CODE>-3d=z</CODE> or <CODE>-3d=t</CODE>
  <DD>Selects which dimension to use as the third dimension for processing.
    The first form selects the z dimension as the third dimension; the second
    form selects the time dimension as the third dimension.  If you do not
    specify either form, the program uses the z dimension as the third
    dimension when the input file has multiple z sections per time point or
    only one time point.  Otherwise, the program uses the time dimension as
    the third dimension for filtering.

  <DT><CODE>-enhance</CODE>
  <DD>If specified, the result of each iteration of filtering is the input data
    for that iteration minus what the result would be without
    <CODE>-enhance</CODE> specified.  The
    <A HREF="#AvgDevFilter">average deviation</A> filter is an exception to
    this.

  <DT><CODE>-iterations=</CODE><VAR>n</VAR>
  <DD>Specifies that the filtering should be performed for <VAR>n</VAR>
    iterations.  If the command line does not contain <CODE>-iterations</CODE>,
    one iteration of filtering is performed.

  <DT><CODE>-kernel_size=</CODE><VAR>nx</VAR>[<CODE>:</CODE><VAR>ny</VAR><CODE>:</CODE><VAR>nz</VAR>]
  <DD>Sets the size of the kernel to be <VAR>nx</VAR> by <VAR>ny</VAR> by
    <VAR>nz</VAR> (or, if <VAR>ny</VAR> and <VAR>nz</VAR> are not specified,
     <VAR>nx</VAR> by <VAR>nx</VAR> by <VAR>nx</VAR>).  If
    <CODE>-kernel_size</CODE> is not supplied on the command-line, the kernel
    size will be determined from the sigma values (see below) for the
    <A HREF="#GaussianFilter">Gaussian</A>,
    <A HREF="#LaplacianFilter">Laplacian (LoG)</A>, and
    <A HREF="#BilateralFilter">bilateral</A> filters and will be 3x3x3 for all
    other filter types.

  <DT><CODE>-method=</CODE><VAR>filter_type</VAR>
  <DD>Sets what form of filtering to apply.  Possible values for
    <VAR>filter_type</VAR> are:
    <DL>
      <DT><CODE>median</CODE>
      <DD>Use a <A HREF="#MedianFilter">median filter</A>.
      <DT><CODE>mean</CODE>
      <DD>Use a <A HREF="#MeanFilter">mean filter</A>.
      <DT><CODE>gaussian</CODE>
      <DD>Use a <A HREF="#GaussianFilter">Gaussian filter</A>.
      <DT><CODE>laplacian</CODE>
      <DD>Use a <A HREF="#LaplacianFilter">Laplacian (LoG) filter</A>.
      <DT><CODE>avgdev</CODE>
      <DD>Use an <A HREF="#AvgDevFilter">average deviation filter</A>.
      <DT><CODE>wghtmean</CODE>
      <DD>Use a <A HREF="#WeightedMeanFilter">weighted mean filter</A>.
      <DT><CODE>minimum</CODE>
      <DD>Use a <A HREF="#MinimumFilter">minimum filter</A>.
      <DT><CODE>maximum</CODE>
      <DD>Use a <A HREF="#MaximumFilter">maximum filter</A>.
      <DT><CODE>bilateral</CODE>
      <DD>Use a <A HREF="#BilateralFilter">bilateral filter</A>.
    </DL>

  <DT><CODE>-scale=</CODE><VAR>value</VAR>
  <DD>Sets the <A HREF="#ScaleFactor">scale factor</A> used when
    <CODE>-enhance</CODE> is used and the filter is not an average
    deviation filter.  If not supplied, the scale factor defaults
    to one.

  <DT><CODE>-sigma=</CODE><VAR>sigma_x</VAR>[<CODE>:</CODE><VAR>sigma_y</VAR><CODE>:</CODE><VAR>sigma_z</VAR>]
  <DD>Sets how rapidly the <A HREF="#GaussianFilter">Gaussian</A>,
    <A HREF="#LaplacianFilter">Laplacian (LoG)</A>, and
    <A HREF="#BilateralFilter">bilateral</A> filters fall off to zero.  If
    <VAR>sigma_y</VAR> and <VAR>sigma_z</VAR> are not supplied, they are set
    to the value of <VAR>sigma_x</VAR>.  If <CODE>-sigma</CODE> is not
    specified on the command-line, the default value of sigma in all three
    directions is one.

  <DT><CODE>-sigma_inten=</CODE><VAR>s</VAR>
  <DD>Sets the <A HREF="#IntensitySigma">intensity sigma</A>, the
    standard deviation of the Gaussian for the intensity weighting
    component of the <A HREF="#BilateralFilter">bilateral filter</A>.
    <VAR>s</VAR> must be a number greater than or equal to zero.  If you
    do not specify the -sigma_inten option on the command line, Filter3D
    uses a value of five for the intensity sigma.
</DL>

<P>As an example, the following command-line applies two iterations of a
 5x5x3 mean filter to raw.dat and places the results in image window 1:
<PRE>
    Filter3D raw.dat 1 -method=mean -kernel_size=5:5:3
</PRE>

<H3>Topics</H3>
<P>
  <A HREF="#Filter3D">Overview</A> |
  <A HREF="Region.html">Region processing</A> |
  <A HREF="#Method">Method (filter types)</A> |
  <A HREF="#SwapZT">Swap z/time</A> |
  <A HREF="#Enhance">Enhance</A> |
  <A HREF="#ScaleFactor">Scale factor</A> |
  <A HREF="#Sigma">Sigma</A> |
  <A HREF="#IntensitySigma">Intensity sigma</A> |
  <A HREF="#KernelSize">Kernel size</A> |
  <A HREF="#Iterations">Iterations</A> |
  Command line
<HR>

</BODY>
</HTML>
