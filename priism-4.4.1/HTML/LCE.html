<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
<HEAD>
  <META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <TITLE>Priism Help: LCE 2D</TITLE>
  <META NAME="Description" CONTENT="On-line help for Priism's application to perform 2D local contrast enhancement.">
  <META NAME="Keywords" CONTENT="Priism,local contrast,enhancement">
  <LINK REV=MADE HREF="mailto:ive@msg.ucsf.edu">
</HEAD>
<BODY>

<H1><A NAME="LCE">LCE 2D</A></H1>
<H2>Overview</H2>
<P>LCE (local contrast enhancement) uses a process similar to
<A HREF="HisEqual.html">histogram equalization</A> (but with greater latitude
for selecting the form of the output distribution) and adds in a term
based on the deviation from a local estimate of the mean.

<P>Mathematically, the output at a point, <VAR>o(x,y)</VAR>, is equal to

<PRE>
                                          min(m(x,y), mmax)
    o(x,y) = c(x,y) * g(m(x,y)) + integral                  f(i) di
                                          i = mmin
</PRE>

<P>where <VAR>m(x,y)</VAR> is a <A HREF="#Box">local estimate</A> of the
mean intensity at (x, y) and <VAR>c(x,y)</VAR> is the difference between
the intensity at (x,y) and the estimated local mean.  The graph of the
<A HREF="#MeanStretchFunction">local mean stretch function</A> shows the form
of the function <VAR>f</VAR>; the horizontal axis is the local mean intensity
and the vertical axis ranges from 0 to 1.  The graph of the
<A HREF="#ContrastWeightingFunction">local contrast weighting function</A>
shows the form of the function <VAR>g</VAR>; the horizontal axis is again
the local mean intensity and the vertical axis ranges from 0 to 2. In both
graphs, a histogram of the local means for either current section (if the input
is a window) or for the first section in the selected input region (if the
input is a file) is shown as a reference.  <VAR>mmin</VAR> and <VAR>mmax</VAR>
are the minimum and maximum values on the horizontal axes; they can be
specified in the <A HREF="#MinMax">MinMax field</A> and when the
<A HREF="#AutoRange">autorange toggle</A> is on they are automatically set
based on the minimum and maximum local means for the section processed.

<P>The graphs of the functions each have control points, shown as red squares,
for modifying their shape.  To use a control point, position the mouse pointer
over it and press and hold the left mouse button.  Drag the mouse until the
control point is in the desired position and then release the left mouse
button.  The control points at the ends move vertically and horizontally; the
control point in the middle of the mean stretch function only moves
horizontally.

<P>As a guide for choosing the form of the weighting functions here are
a couple of the extreme cases:

<UL>
  <LI>When the local contrast weighting function is zero (the
    left control point is shifted all the way to the right), LCE functions
    similarly to <A HREF="HisEqual.html">HisEqual</A> except that it operates
    on the local mean rather than on the individual pixel values and that
    the histogram of the output will not approximate a uniform histogram:
    in the output, input intensity ranges where the weighting function is near
    zero are compressed to a smaller range while intensity ranges where the
    weighting function is near one are expanded.  In the limiting case where
    <VAR>f</VAR> is one uniformly (the left control point moved to the top and
    to the all the way to the left; the right control point moved to the top
    and the right; the middle control point moved all the way to the right),
    the output is essentially the result of
    <A HREF="Filter2D.html">Filter2D's mean filter</A>.
  <LI>When the local mean weighting function is zero (the left and right
    control points moved to the bottom; all three control points moved all the
    way to the right), the output is similar to <A HREF="Filter2D.html">Filter2D</A>
    run with then enhance option on except that the local contrast weighting
    function can be used to suppress the variations in regions where the local
    mean intensity is either at the high or low end of the range.
</UL>

<H3>Topics</H3>
<P>
  Overview |
  <A HREF="Region.html">Region processing</A> |
  <A HREF="#Box">Box</A> |
  <A HREF="#AutoRange">Autorange</A> |
  <A HREF="#MinMax">MinMax</A> |
  <A HREF="#MeanStretchFunction">Mean stretch function</A> |
  <A HREF="#ContrastWeightingFunction">Contrast weighting function</A> |
  <A HREF="#CommandLine">Command line</A>

<H3>Related Priism Topics</H3>
<P>
  <A HREF="LCE3D.html">LCE 3D</A> |
  <A HREF="HisEqual.html">Histogram equalization</A> |
  <A HREF="Filter2D.html">Filter2D</A> |
  <A HREF="Priism.html">Priism</A>
<HR>

<H2><A NAME="Box">Box</A></H2>
<P>The local mean intensity at a point (see the <A HREF="#LCE">overview</A>
for how the local mean is used to calculate the enhanced result) is estimated
by calculating the mean intensity for a square of <VAR>n</VAR> by <VAR>n</VAR>
pixels about the point.  <VAR>n</VAR> is the value shown in the <EM>Box</EM>
field.

<H3>Topics</H3>
<P>
  <A HREF="#LCE">Overview</A> |
  <A HREF="Region.html">Region processing</A> |
  Box |
  <A HREF="#AutoRange">Autorange</A> |
  <A HREF="#MinMax">MinMax</A> |
  <A HREF="#MeanStretchFunction">Mean stretch function</A> |
  <A HREF="#ContrastWeightingFunction">Contrast weighting function</A> |
  <A HREF="#CommandLine">Command line</A>
<HR>

<H2><A NAME="AutoRange">Autorange</A></H2>
<P>When the <EM>AutoRange</EM> toggle is on, the
<A HREF="#MinMax">range of values</A> for which the weighting functions are
calculated and plotted, is automatically set from the minimum and maximum
local mean in the current section.

<H3>Topics</H3>
<P>
  <A HREF="#LCE">Overview</A> |
  <A HREF="Region.html">Region processing</A> |
  <A HREF="#Box">Box</A> |
  Autorange |
  <A HREF="#MinMax">MinMax</A> |
  <A HREF="#MeanStretchFunction">Mean stretch function</A> |
  <A HREF="#ContrastWeightingFunction">Contrast weighting function</A> |
  <A HREF="#CommandLine">Command line</A>
<HR>

<H2><A NAME="MinMax">MinMax</A></H2>
<P>The <EM>MinMax</EM> field shows the range of values on the horizontal axes
of the <A HREF="#MeanStretchFunction">local mean stretch graph</A> and
the <A HREF="#ContrastWeightingFunction">local contrast weighting graph</A>.
When the <A HREF="#AutoRange">AutoRange toggle</A> is on, these bounds
are automatically set based on the minimum and maximum local means for the
current section (when processing is not in progress and the input is a file,
the current section is the first section in the selected input region).

<H3>Topics</H3>
<P>
  <A HREF="#LCE">Overview</A> |
  <A HREF="Region.html">Region processing</A> |
  <A HREF="#Box">Box</A> |
  <A HREF="#AutoRange">Autorange</A> |
  MinMax |
  <A HREF="#MeanStretchFunction">Mean stretch function</A> |
  <A HREF="#ContrastWeightingFunction">Contrast weighting function</A> |
  <A HREF="#CommandLine">Command line</A>
<HR>

<H2><A NAME="MeanStretchFunction">Local Mean Stretch Function</A></H2>
<P>As the <A HREF="#LCE">overview</A> describes in more detail, the
result of local contrast enhancement at each pixel is the sum of two
components: a contribution from the local mean of the input data about the
point and a contribution from the local contrast (difference between the
local mean and the point's value).  The local mean stretch function
affects the first and is plotted in red as a function of the local mean
intensity.  A histogram of the local mean values for the current section
(if the input is an image window) or the first section in the input range
(if the input is a file) is shown on the same axis for reference.

<P>The curve has three control points to control the shape of the curve.  To
adjust a control point, position the mouse pointer over it, depress the
right mouse button, drag the mouse, and then release the right mouse
button.  The control points on the left and right move both vertically
and horizontally; the control point in the middle only moves horizontally.

<P>Below the plot, the coordinates of the control points are shown and may
be edited directly.  The coordinates are normalized to the range of zero
to one.  The first two values shown are the horizontal and vertical
coordinates, respectively, of the left control point.  The third value
is the horizontal coordinate of the middle control point.  The fourth
and fifth values are the horizontal and vertical coordinates, respectively,
of the right control point.

<H3>Topics</H3>
<P>
  <A HREF="#LCE">Overview</A> |
  <A HREF="Region.html">Region processing</A> |
  <A HREF="#Box">Box</A> |
  <A HREF="#AutoRange">Autorange</A> |
  <A HREF="#MinMax">MinMax</A> |
  <A HREF="#MeanStretchFunction">Mean stretch function</A> |
  <A HREF="#ContrastWeightingFunction">Contrast weighting function</A> |
  <A HREF="#CommandLine">Command line</A>
<HR>

<H2><A NAME="ContrastWeightingFunction">Local Contrast Weighting Function</A></H2>
<P>As the <A HREF="#LCE">overview</A> describes in more detail, the
result of local contrast enhancement at each pixel is the sum of two
components: a contribution from the local mean of the input data about the
point and a contribution from the local contrast (difference between the
local mean and the point's value).  The local contrast weighting function
affects the first and is plotted in red as a function of the local mean
intensity.  A histogram of the local means value for the current section
(if the input is an image window) or the first section in the input range
(if the input is a file) is shown on the same axis for reference.

<P>The curve has two control points to control the shape of the curve.  To
adjust a control point, position the mouse pointer over it, depress the
right mouse button, drag the mouse, and then release the right mouse
button.  The control points move both vertically and horizontally.

<P>Below the plot, the coordinates of the control points are shown and may
be edited directly.  The coordinates are normalized to the range of zero
to one.  The first two values shown are the horizontal and vertical
coordinates, respectively, of the left control point.  The third
and fourth values are the horizontal and vertical coordinates, respectively,
of the right control point.

<H3>Topics</H3>
<P>
  <A HREF="#LCE">Overview</A> |
  <A HREF="Region.html">Region processing</A> |
  <A HREF="#Box">Box</A> |
  <A HREF="#AutoRange">Autorange</A> |
  <A HREF="#MinMax">MinMax</A> |
  <A HREF="#MeanStretchFunction">Mean stretch function</A> |
  <A HREF="#ContrastWeightingFunction">Contrast weighting function</A> |
  <A HREF="#CommandLine">Command line</A>
<HR>

<H2><A NAME="CommandLine">Command Line</A></H2>
<P>Local contrast enhancement accepts the command-line arguments described
in <A HREF="Region.html#COMMANDLINE">Region.html</A>.  In addition,
local contrast enhancement has the following options:

<DL>
  <DT><CODE>-box=</CODE><VAR>n</VAR>
  <DD>Sets the region about each point used to estimate the local mean to be
    a square of <VAR>n</VAR> by <VAR>n</VAR> pixels.  <VAR>n</VAR> must be
    a positive integer.  If <CODE>-box</CODE> does not appear on the command
    line, local contrast enhancement uses a 3 by 3 box.

  <DT><CODE>-range=</CODE><VAR>rmin</VAR><CODE>:</CODE><VAR>rmax</VAR>
  <DD>Sets the range of local mean intensities for which the mean stretch
    and contrast weighting functions are calculated.  Points where the local
    mean estimate is less than <VAR>rmin</VAR> are treated as if the local
    mean was <VAR>rmin</VAR>; pointer where the local mean estimate is greater
    than <VAR>rmax</VAR> are treated as if the local mean was <VAR>rmax</VAR>.
    <VAR>rmin</VAR> must be less than <VAR>rmax</VAR>.  If <CODE>-range</CODE>
    does not appear on the command line, the range is automatically set for
    each section to the full range of local mean estimates for that section.

  <DT><CODE>-mean_stretch=</CODE><VAR>x1</VAR><CODE>:</CODE><VAR>y1</VAR><CODE>:</CODE><VAR>x2</VAR><CODE>:</CODE><VAR>x3</VAR><CODE>:</CODE><VAR>y3</VAR>
  <DD>Sets the shape of the mean stretch function.  Requires five arguments
    between zero and one.  The first two arguments are the normalized
    coordinate of the left control point.  The third argument is the normalized
    horizontal coordinate for the middle control point.  The fourth and fifth
    arguments are the normalized coordinates for the right control point.
    If <CODE>-mean_stretch</CODE> does not appear on the command line, local
    contrast enhancement runs as if
    <CODE>-mean_stretch=0.0:0.0:0.5:1.0:0.5</CODE> was on the command line.

  <DT><CODE>-contrast_weight=</CODE><VAR>x1</VAR><CODE>:</CODE><VAR>y1</VAR><CODE>:</CODE><VAR>x2</VAR><CODE>:</CODE><VAR>y2</VAR>
  <DD>Sets the shape of the contrast weighting function.  Requires four
    arguments between zero and one.  The first two arguments are the normalized
    coordinate of the left control point.  The third and fourth arguments are
    the normalized coordinates for the right control point.  If
    <CODE>-contrast_weight</CODE> does not appear on the command line, local
    contrast enhancement runs as if
    <CODE>-contrast_weight=0.0:0.0:1.0:1.0</CODE> was on the command line.
</DL>

<P>Here's an example command-line that reads from a.dat and writes its
results to b.dat:

<PRE>
    LCE a.dat b.dat -mean_stretch=0:0:.45:.65:0 -contrast_weight=.45:.5:.65:0
</PRE>

<P>The motivation for the chosen shape of the functions is to modify
the intensities so that a single threshold will better discriminate
between background and a brightly but non-uniformly stained structure.  Once
the modified data is segmented, the segmentation result could be applied to
original data.  Therefore, the peak of the mean stretch function is placed in
the center of the transition between background intensities and intensities
in the structure (here assumed to be .45 of the full range of values; though
it would vary from data set to data set) and to drop off rapidly so that the
staining variations in the structure are suppressed.  The contrast weighting
function is set to preserve the local contrast for low intensity values
(background), but to suppress them for the higher intensity values in the
structure.

<H3>Topics</H3>
<P>
  <A HREF="#LCE">Overview</A> |
  <A HREF="Region.html">Region processing</A> |
  <A HREF="#Box">Box</A> |
  <A HREF="#AutoRange">Autorange</A> |
  <A HREF="#MinMax">MinMax</A> |
  <A HREF="#MeanStretchFunction">Mean stretch function</A> |
  <A HREF="#ContrastWeightingFunction">Contrast weighting function</A> |
  <A HREF="#CommandLine">Command line</A>
<HR>

</BODY>
</HTML>
